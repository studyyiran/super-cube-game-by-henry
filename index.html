<!DOCTYPE html>
<html lang="zh">


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>å¯¹æˆ˜æ¸¸æˆ</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        
        // è¯·å°† GA_MEASUREMENT_ID æ›¿æ¢ä¸ºæ‚¨çš„å®é™… Google Analytics æµ‹é‡ ID
        gtag('config', 'GA_MEASUREMENT_ID');
    </script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: 400% 400%;
            background-position: center;
            background-repeat: no-repeat;
            animation: gradientShift 8s ease infinite;
            position: relative;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* åŠ¨æ€ç²’å­èƒŒæ™¯ */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }
        
        #gameCanvas {
            border: 2px solid #444;
            background: transparent;
            width: 100%;
            height: 100%;
            filter: blur(5px); /* åˆå§‹æ¨¡ç³Šæ•ˆæœ */
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 0 50px rgba(102, 126, 234, 0.3);
        }
        
        #gameCanvas.game-active {
            filter: none;
            box-shadow: 0 0 80px rgba(102, 126, 234, 0.6);
            border-color: #667eea;
        }
        
        #welcomeScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at center, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.9) 100%);
            backdrop-filter: blur(10px);
            z-index: 100;
            animation: fadeInScale 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            overflow: hidden;
        }
        
        /* åŠ¨æ€ç”»å¸ƒèƒŒæ™¯ */
        #dynamicCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.3;
        }
        
        /* åŠ¨æ€å‡ ä½•å›¾å½¢æ ·å¼ */
        .geometric-shape {
            position: absolute;
            border-radius: 50%;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.6), rgba(118, 75, 162, 0.6));
            animation: floatGeometric 8s ease-in-out infinite;
        }
        
        .geometric-triangle {
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
            animation: rotateTriangle 6s linear infinite;
        }
        
        .geometric-square {
            position: absolute;
            background: linear-gradient(45deg, rgba(52, 152, 219, 0.4), rgba(155, 89, 182, 0.4));
            animation: rotateSquare 10s linear infinite;
        }
        
        @keyframes floatGeometric {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-20px) scale(1.1); }
        }
        
        @keyframes rotateTriangle {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes rotateSquare {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }
        
        @keyframes fadeInScale {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        #welcomeMessage {
            color: white;
            font-size: 2em;
            margin-bottom: 30px;
            text-align: center;
            animation: textGlow 2s ease-in-out infinite alternate;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }
        
        @keyframes textGlow {
            0% { text-shadow: 0 0 20px rgba(255, 255, 255, 0.5), 0 0 30px rgba(102, 126, 234, 0.3); }
            100% { text-shadow: 0 0 30px rgba(255, 255, 255, 0.8), 0 0 40px rgba(102, 126, 234, 0.6); }
        }
        .gameButton {
            padding: 15px 30px;
            margin: 10px;
            font-size: 1.2em;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            position: relative;
            overflow: hidden;
        }
        .gameButton:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s;
        }
        .gameButton:hover {
            background: linear-gradient(45deg, #2980b9, #1abc9c);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.5);
        }
        .gameButton:hover:before {
            left: 100%;
        }
        .gameButton:active {
            transform: translateY(-1px) scale(1.02);
        }
        
        /* æ¸¸æˆæŒ‰é’®æ ·å¼ - æ¢å¤åŸå§‹çŸ©å½¢æ ·å¼å¹¶ç§»åˆ°å·¦è¾¹ */
        .play-button {
            width: 250px;
            height: 80px;
            border-radius: 12px;
            display: block !important;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            font-size: 1.4em;
            font-weight: bold;
            line-height: 1.2;
            margin: 10px;
            text-align: center;
            position: absolute;
            z-index: 9999 !important;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: 3px solid #2c3e50;
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
            transition: all 0.3s ease;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .play-button:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
        }
        
        /* å››ä¸ªæ¸¸æˆæŒ‰é’®çš„å…·ä½“ä½ç½® */
        #singlePlayerBtn {
            left: 30px;
            top: 25px;
        }
        
        #multiPlayerBtn {
            left: 30px;
            top: 35px;
        }
        
        #exitBtn {
            left: 30px;
            top: 45px;
        }
        
        #rulesBtn {
            left: 30px;
            top: 55px;
        }
        
        /* éš¾åº¦æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
        .difficulty-easy:hover {
            background: linear-gradient(45deg, #27ae60, #2ecc71) !important;
            transform: translateY(-3px) scale(1.05);
        }
        
        .difficulty-normal:hover {
            background: linear-gradient(45deg, #2980b9, #3498db) !important;
            transform: translateY(-3px) scale(1.05);
        }
        
        .difficulty-hard:hover {
            background: linear-gradient(45deg, #c0392b, #e74c3c) !important;
            transform: translateY(-3px) scale(1.05);
        }
        
        .difficulty-hell:hover {
            background: linear-gradient(45deg, #9b59b6, #8e44ad) !important;
            transform: translateY(-3px) scale(1.05);
        }
        .terrainButton {
            padding: 15px;
            margin: 5px;
            font-size: 1.1em;
            background-color: #ecf0f1;
            color: #2c3e50;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .terrainButton:hover {
            background-color: #d5dbdb;
            border-color: #95a5a6;
        }
        .terrainButton.selected {
            background-color: #e8f5e8;
            border-color: #27ae60;
        }
        .terrainButton.selected .terrainIndicator {
            background-color: #27ae60 !important;
        }
        
        /* å»ºè®®æŒ‰é’®æ ·å¼ */
        #suggestionButton {
            position: absolute;
            top: 20px;
            left: 200px; /* ç§»åˆ°å·¦ä¾§ */
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            z-index: 102;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: none; /* é»˜è®¤éšè—ï¼Œé€šè¿‡JavaScriptæ§åˆ¶æ˜¾ç¤º */
            align-items: center;
            justify-content: center;
        }
        
        #suggestionButton:hover {
            background-color: #2980b9;
            transform: scale(1.05);
        }
        
        /* é‚®ç®±æŒ‰é’®æ ·å¼ */
        #mailboxButton {
            position: absolute;
            top: 20px;
            left: 110px; /* ç§»åˆ°å·¦ä¾§ */
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #e74c3c;
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            z-index: 102;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: none; /* é»˜è®¤éšè—ï¼Œé€šè¿‡JavaScriptæ§åˆ¶æ˜¾ç¤º */
            align-items: center;
            justify-content: center;
        }
        
        #mailboxButton:hover {
            background-color: #c0392b;
            transform: scale(1.05);
        }
        
        /* åˆ›å»ºæˆ¿é—´æŒ‰é’®æ ·å¼ */
        #createRoomButton {
            position: absolute;
            top: 20px;
            right: 110px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #9b59b6;
            color: white;
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            z-index: 102;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #createRoomButton:hover {
            background-color: #8e44ad;
            transform: scale(1.05);
        }
        
        /* å¹¿åœºæŒ‰é’®æ ·å¼ */
        #squareButton {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #f39c12;
            color: white;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            z-index: 102;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #squareButton:hover {
            background-color: #e67e22;
            transform: scale(1.05);
        }
        
        /* æœªè¯»æ¶ˆæ¯å¾½ç« æ ·å¼ */
        .unread-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #f39c12;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }
        
        .unread-badge.hidden {
            display: none;
        }
        
        /* é‚®ç®±å¼¹çª—æ ·å¼ */
        #mailboxModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        #mailboxModalContent {
            background-color: white;
            border-radius: 10px;
            width: 500px;
            max-height: 600px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .mailbox-header {
            background-color: #3498db;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .mailbox-header h2 {
            margin: 0;
            font-size: 20px;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }
        
        .close-btn:hover {
            background-color: rgba(255,255,255,0.2);
        }
        
        .mailbox-messages {
            max-height: 500px;
            overflow-y: auto;
            padding: 20px;
        }
        
        .empty-state {
            text-align: center;
            color: #7f8c8d;
            font-size: 16px;
            padding: 40px 20px;
        }
        
        .message-item {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #3498db;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .message-time {
            color: #7f8c8d;
            font-size: 12px;
        }
        
        .message-from {
            color: #3498db;
            font-size: 12px;
            font-weight: bold;
        }
        
        .message-content {
            color: #2c3e50;
            line-height: 1.4;
            margin-bottom: 10px;
        }
        
        .message-dismiss {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }
        
        .message-dismiss:hover {
            background-color: #2980b9;
        }
        
        /* å»ºè®®å¼¹çª—æ ·å¼ */
        #suggestionModal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        
        #suggestionModalContent {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            position: relative;
        }
        
        #suggestionTextarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
        }
        
        #suggestionTextarea:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .suggestionButtons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .suggestionBtn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        
        .suggestionBtn.submit {
            background-color: #27ae60;
            color: white;
        }
        
        .suggestionBtn.submit:hover {
            background-color: #229954;
        }
        
        .suggestionBtn.cancel {
            background-color: #95a5a6;
            color: white;
        }
        
        .suggestionBtn.cancel:hover {
            background-color: #7f8c8d;
        }
        
        /* å»ºè®®é€šçŸ¥æ ·å¼ */
         #suggestionNotification {
             position: fixed;
             top: 20px;
             right: 20px;
             background: #4CAF50;
             color: white;
             padding: 20px;
             border-radius: 10px;
             box-shadow: 0 4px 20px rgba(0,0,0,0.3);
             display: none;
             z-index: 1001;
             max-width: 350px;
             animation: slideIn 0.5s ease-out;
         }
         
         #suggestionNotification.show {
             display: block;
             animation: slideIn 0.5s ease-out;
         }
         
         @keyframes slideIn {
             from { transform: translateX(100%); opacity: 0; }
             to { transform: translateX(0); opacity: 1; }
         }
         
         #suggestionNotification .notification-content {
             display: flex;
             align-items: center;
             justify-content: space-between;
             gap: 15px;
         }
         
         #suggestionNotification .notification-text {
             flex: 1;
         }
         
         /* å¼€å‘è€…é€šçŸ¥æ ·å¼ */
         #developerNotification {
             position: fixed;
             top: 100px;
             right: 20px;
             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
             color: white;
             padding: 20px;
             border-radius: 15px;
             box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
             display: none;
             z-index: 1002;
             max-width: 400px;
             min-width: 300px;
             animation: slideInBounce 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
             border: 2px solid rgba(255, 255, 255, 0.1);
             backdrop-filter: blur(10px);
             transform-origin: top right;
         }
         
         @keyframes slideInBounce {
             0% { 
                 transform: translateX(100%) scale(0.8); 
                 opacity: 0; 
             }
             60% { 
                 transform: translateX(-10px) scale(1.05); 
                 opacity: 0.8; 
             }
             100% { 
                 transform: translateX(0) scale(1); 
                 opacity: 1; 
             }
         }
         
         @keyframes slideIn {
             from { transform: translateX(100%); opacity: 0; }
             to { transform: translateX(0); opacity: 1; }
         }

        /* ç™»å½•æ³¨å†Œç³»ç»Ÿæ ·å¼ */
        #loginScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 200;
        }
        
        #loginContainer {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            text-align: center;
            min-width: 400px;
            animation: loginSlideUp 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        @keyframes loginSlideUp {
            0% { 
                transform: translateY(50px) scale(0.9); 
                opacity: 0; 
            }
            100% { 
                transform: translateY(0) scale(1); 
                opacity: 1; 
            }
        }
        
        #loginTitle {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 30px;
            font-weight: bold;
        }
        
        .loginForm {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .loginInput {
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 10px;
            outline: none;
            transition: border-color 0.3s ease;
        }
        
        .loginInput:focus {
            border-color: #667eea;
        }
        
        .loginButton {
            padding: 15px 30px;
            font-size: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s ease;
            margin: 5px;
        }
        
        .loginButton:hover {
            transform: translateY(-2px);
        }
        
        .loginButton.secondary {
            background: #95a5a6;
        }
        
        #registerForm {
            display: none;
        }
        
        /* IDæ˜¾ç¤ºå¼¹çª—æ ·å¼ */
        #idDisplayModal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            text-align: center;
            z-index: 300;
            display: none;
            animation: fadeInOut 4s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

    </style>
</head>
<body>
    <audio id="backgroundMusic" src="background_music.mp3" loop></audio>
    <div id="musicControl" style="position: absolute; top: 10px; left: 10px; z-index: 101;">
        <button id="musicToggleButton" class="play-button" style="background: linear-gradient(45deg, #3498db, #2980b9); color: white; border: none; width: 60px; height: 60px; border-radius: 50%; cursor: pointer; font-size: 20px; position: absolute; top: 20px; left: 20px; z-index: 102; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);">â–¶ï¸</button>
    </div>
    <audio id="gameMusic" src="game_music.mp3" loop></audio>

    <!-- å»ºè®®æŒ‰é’® -->
    <button id="suggestionButton">å»ºè®®</button>
    
    <!-- é‚®ç®±æŒ‰é’® -->
    <button id="mailboxButton">
        ğŸ“§
        <span id="unreadCount" class="unread-badge">0</span>
    </button>
    
    <!-- åˆ›å»ºæˆ¿é—´æŒ‰é’® -->
    <button id="createRoomButton">åˆ›å»ºæˆ¿é—´</button>
    
    <!-- å¹¿åœºæŒ‰é’® -->
    <button id="squareButton">å¹¿åœº</button>
    
    <!-- å»ºè®®å¼¹çª— -->
    <div id="suggestionModal">
        <div id="suggestionModalContent">
            <h2>ç»™å¼€å‘è€…çš„å»ºè®®</h2>
            <p>è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ‚¨çš„å»ºè®®æˆ–æ„è§ï¼š</p>
            <textarea id="suggestionTextarea" placeholder="è¯·è¾“å…¥æ‚¨çš„å»ºè®®..."></textarea>
            <div class="suggestionButtons">
                <button class="suggestionBtn cancel" id="cancelSuggestionBtn">å–æ¶ˆ</button>
                <button class="suggestionBtn submit" id="submitSuggestionBtn">æäº¤å»ºè®®</button>
            </div>
        </div>
    </div>
    
    <!-- å»ºè®®é€šçŸ¥ -->
    <div id="suggestionNotification"></div>
    
    <!-- é‚®ç®±å¼¹çª— -->
    <div id="mailboxModal">
        <div id="mailboxModalContent">
            <div class="mailbox-header">
                <h2>ğŸ“§ æ¶ˆæ¯é‚®ç®±</h2>
                <button id="closeMailboxBtn" class="close-btn">âœ•</button>
            </div>
            <div id="mailboxMessages" class="mailbox-messages">
                <div class="empty-state">
                    <p>è¿™é‡Œæ˜¯ç©ºç©ºå“’</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å¼€å‘è€…é€šçŸ¥ -->
    <div id="developerNotification">
    </div>

    <!-- ç™»å½•æ³¨å†Œç•Œé¢ -->
    <div id="loginScreen">
        <div id="loginContainer">
            <div id="loginTitle">æ¬¢è¿åˆ°ï¼šè¶…çº§æ–¹å—ï¼</div>
            
            
            <!-- ç™»å½•è¡¨å• -->
            <div id="loginForm" class="loginForm">
                <input type="text" id="loginId" class="loginInput" placeholder="è¯·è¾“å…¥æ‚¨çš„8ä½ID" maxlength="8">
                <input type="password" id="loginPassword" class="loginInput" placeholder="è¯·è¾“å…¥6ä½æ–¹æ–¹ç ï¼ˆå¯†ç ï¼‰" maxlength="6">
                <button id="loginBtn" class="loginButton">ç™»å½•</button>
                <button id="showRegisterBtn" class="loginButton secondary">æ³¨å†Œæ–°è´¦æˆ·</button>
                <div style="margin-top: 15px; font-size: 12px; color: #6c757d; text-align: center;">
                    <p style="margin: 5px 0;">ğŸ’¡ æç¤ºï¼šæŒ‰å›è½¦é”®ä¹Ÿå¯ä»¥å¿«é€Ÿç™»å½•</p>
                    <p style="margin: 5px 0;">ğŸ”’ æ‚¨çš„è´¦æˆ·ä¿¡æ¯å®‰å…¨å­˜å‚¨åœ¨æœ¬åœ°</p>
                </div>
            </div>
            
            <!-- æ³¨å†Œè¡¨å• -->
            <div id="registerForm" class="loginForm">
                <input type="text" id="registerName" class="loginInput" placeholder="è¯·è¾“å…¥æ‚¨çš„åå­—" maxlength="20">
                <input type="password" id="registerPassword" class="loginInput" placeholder="è¯·è¾“å…¥å…­ä½æ–¹æ–¹ç ï¼ˆå¯†ç ï¼‰" maxlength="6">
                <button id="registerBtn" class="loginButton">æ³¨å†Œ</button>
                <button id="backToLoginBtn" class="loginButton secondary">è¿”å›ç™»å½•</button>
            </div>
        </div>
    </div>
    
    <!-- IDæ˜¾ç¤ºå¼¹çª— -->
    <div id="idDisplayModal">
        <h2>æ³¨å†ŒæˆåŠŸï¼</h2>
        <p id="idDisplayText">ä½ çš„IDæ˜¯ï¼š</p>
    </div>

    <div id="welcomeScreen">
        <canvas id="dynamicCanvas"></canvas>
        <div id="welcomeMessage">æ¬¢è¿ç©å®¶1å·</div>
        <div id="rulesModal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
            <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; position: relative;">
                <span style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;" onclick="document.getElementById('rulesModal').style.display = 'none';">&times;</span>
                <h2>æ¸¸æˆè§„åˆ™</h2>
                <p id="rulesContent"></p>
            </div>
        </div>
        <div id="exitConfirmModal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
            <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; text-align: center;">
                <h2>ä½ çœŸçš„è¦ç¦»å¼€ä¹ˆï¼Ÿ</h2>
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button id="confirmExitBtn" class="gameButton" style="background-color: #aaa;">æ®‹å¿ç¦»å¼€</button>
                    <button id="cancelExitBtn" class="gameButton" style="background-color: #3498db;">å¼€å¿ƒç•™ä¸‹</button>
                </div>
            </div>
        </div>
        <div id="difficultyModal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
            <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; text-align: center;">
                <h2>é€‰æ‹©æ¸¸æˆéš¾åº¦</h2>
                <div style="display: flex; flex-direction: column; margin-top: 20px;">
                    <button id="easyModeBtn" class="gameButton difficulty-easy" style="background: linear-gradient(45deg, #2ecc71, #27ae60); color: white; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);">ğŸŒ± ç®€å•æ¨¡å¼</button>
                    <button id="normalModeBtn" class="gameButton difficulty-normal" style="background: linear-gradient(45deg, #3498db, #2980b9); color: white; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);">âš¡ æ­£å¸¸æ¨¡å¼</button>
                    <button id="hardModeBtn" class="gameButton difficulty-hard" style="background: linear-gradient(45deg, #e74c3c, #c0392b); color: white; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);">ğŸ”¥ å›°éš¾æ¨¡å¼</button>
                    <button id="hellModeBtn" class="gameButton difficulty-hell" style="background: linear-gradient(45deg, #8e44ad, #9b59b6); color: white; box-shadow: 0 4px 15px rgba(142, 68, 173, 0.4);">ğŸ’€ åœ°ç‹±æ¨¡å¼</button>
                </div>
            </div>
        </div>
        <div id="terrainModal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
            <div style="background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; text-align: center;">
                <h2>é€‰æ‹©åœ°å½¢</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                    <button id="shallowWaterBtn" class="terrainButton" data-terrain="shallow">
                        <div class="terrainIndicator" style="width: 20px; height: 20px; background-color: #888; margin: 0 auto 10px; border-radius: 3px;"></div>
                        æµ…æ°´
                    </button>
                    <button id="deepWaterBtn" class="terrainButton" data-terrain="deep">
                        <div class="terrainIndicator" style="width: 20px; height: 20px; background-color: #888; margin: 0 auto 10px; border-radius: 3px;"></div>
                        æ·±æ°´
                    </button>
                    <button id="lavaBtn" class="terrainButton" data-terrain="lava">
                        <div class="terrainIndicator" style="width: 20px; height: 20px; background-color: #888; margin: 0 auto 10px; border-radius: 3px;"></div>
                        å²©æµ†
                    </button>
                    <button id="grassBtn" class="terrainButton" data-terrain="grass">
                        <div class="terrainIndicator" style="width: 20px; height: 20px; background-color: #888; margin: 0 auto 10px; border-radius: 3px;"></div>
                        è‰ä¸›
                    </button>
                </div>
                <div style="margin-top: 20px;">
                    <button id="startGameBtn" class="gameButton" style="background-color: #27ae60;">å¼€å§‹æ¸¸æˆ</button>
                </div>
                <div style="margin-top: 15px; font-size: 14px; color: #666; text-align: left;">
                    <h3>åœ°å½¢æ•ˆæœè¯´æ˜ï¼š</h3>
                    <p><strong>æµ…æ°´ï¼š</strong>ç©å®¶å’Œæ•Œäººé€Ÿåº¦å‡æ…¢70%</p>
                    <p><strong>æ·±æ°´ï¼š</strong>ç©å®¶å¤´ä¸Šå‡ºç°3ä¸ªæ°”æ³¡ï¼Œæ¯5ç§’æ¶ˆå¤±1ä¸ªï¼Œå…¨éƒ¨æ¶ˆå¤±åæŒç»­æ‰£è¡€ä¸”é€Ÿåº¦å‡æ…¢60%ï¼›æ•Œäººè¿›å…¥å³å‡è¡€</p>
                    <p><strong>å²©æµ†ï¼š</strong>ç¢°åˆ°åæ— æ³•ç§»åŠ¨ï¼ŒæŒç»­æ‰£è¡€</p>
                    <p><strong>è‰ä¸›ï¼š</strong>ç©å®¶è¿›å…¥åéšèº«ï¼Œæ•Œäººåœæ­¢å°„å‡»å¹¶æ˜¾ç¤ºé—®å·ï¼›ä½¿ç”¨æŠ€èƒ½æˆ–ç¦»å¼€è‰ä¸›æ—¶æ•Œäººæ˜¾ç¤ºæ„Ÿå¹å·1ç§’åæ¢å¤æ”»å‡»ï¼Œ20ç§’å†…å†æ¬¡è¿›å…¥è‰ä¸›æ— æ•ˆ</p>
                </div>
            </div>
        </div>
        <div id="rulesSelectModal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
            <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; text-align: center;">
                <h2>é€‰æ‹©æ¸¸æˆè§„åˆ™æ¨¡å¼</h2>
                <div style="display: flex; justify-content: space-around; margin-top: 20px;">
                    <button id="singlePlayerRulesBtn" class="gameButton" style="background-color: blue;">å•äººæ¨¡å¼</button>
                    <button id="multiPlayerRulesBtn" class="gameButton" style="background-color: blue;">åŒäººæ¨¡å¼</button>
                </div>
            </div>
        </div>
        <button id="singlePlayerBtn" class="gameButton play-button">ğŸ®<br>å•äººå¯¹æˆ˜</button>
        <button id="multiPlayerBtn" class="gameButton play-button">ğŸ‘¥<br>åŒäººå¯¹æˆ˜</button>
        <button id="exitBtn" class="gameButton play-button" onclick="showExitConfirm()">ğŸšª<br>é€€å‡ºæ¸¸æˆ</button>
        <button id="rulesBtn" class="gameButton play-button" onclick="showRules()">ğŸ“–<br>æ¸¸æˆè§„åˆ™</button>

    </div>
    <canvas id="gameCanvas"></canvas>
    <div id="mobileControls" style="position: absolute; bottom: 20px; width: 100%; display: none; justify-content: space-around;">
        <button id="skill1Btn" style="padding: 10px 20px; font-size: 16px;">åŸ‹ä¸‹åœ°é›·</button>
        <button id="skill2Btn" style="padding: 10px 20px; font-size: 16px;">æ—‹è½¬å°„å‡»</button>
    </div>
    <script>
        // äº‘ç«¯ç”¨æˆ·æ•°æ®å­˜å‚¨ç³»ç»Ÿ
        const CLOUD_STORAGE_URL = 'https://api.jsonbin.io/v3/b/67a0f8e5e41b4d34e4746b8a'; // äº‘ç«¯å­˜å‚¨API
        const API_KEY = '$2a$10$8vF9xQzKjL.mH5nP2wR3XeY4tG6hB9sC1dE2fA3gH4iJ5kL6mN7oP8qR9sT0uV1wX2yZ3'; // APIå¯†é’¥
        
        // äº‘ç«¯å­˜å‚¨æ“ä½œå‡½æ•°
        async function saveUsersToCloud(usersData) {
            try {
                const response = await fetch(CLOUD_STORAGE_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': API_KEY
                    },
                    body: JSON.stringify({
                        users: usersData,
                        nextUserId: nextUserId,
                        lastUpdated: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    console.log('âœ… ç”¨æˆ·æ•°æ®å·²åŒæ­¥åˆ°äº‘ç«¯');
                    return true;
                } else {
                    console.error('âŒ äº‘ç«¯åŒæ­¥å¤±è´¥:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('âŒ äº‘ç«¯åŒæ­¥é”™è¯¯:', error);
                return false;
            }
        }
        
        async function loadUsersFromCloud() {
            try {
                const response = await fetch(CLOUD_STORAGE_URL + '/latest', {
                    headers: {
                        'X-Master-Key': API_KEY
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.record && data.record.users) {
                        console.log('âœ… ä»äº‘ç«¯åŠ è½½ç”¨æˆ·æ•°æ®æˆåŠŸ');
                        return {
                            users: data.record.users,
                            nextUserId: data.record.nextUserId || 1
                        };
                    }
                }
            } catch (error) {
                // é™é»˜å¤„ç†ç½‘ç»œé”™è¯¯ï¼Œé¿å…åœ¨æ§åˆ¶å°æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                console.log('ğŸŒ äº‘ç«¯æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
            }
            
            console.log('ğŸ“± ä½¿ç”¨æœ¬åœ°æ•°æ®æ¨¡å¼');
            return null;
        }
        
        // ç”¨æˆ·æ•°æ®å­˜å‚¨ç³»ç»Ÿï¼ˆæ”¯æŒäº‘ç«¯åŒæ­¥ï¼‰
        let users = [];
        let currentUser = null;
        let nextUserId = 1;
        
        // åˆå§‹åŒ–ç”¨æˆ·æ•°æ®ï¼ˆä¼˜å…ˆä»äº‘ç«¯åŠ è½½ï¼‰
        // æ•°æ®åŒæ­¥æœºåˆ¶
        let syncInterval = null;
        let lastSyncTime = 0;
        const SYNC_INTERVAL = 30000; // 30ç§’åŒæ­¥ä¸€æ¬¡
        const MIN_SYNC_INTERVAL = 5000; // æœ€å°åŒæ­¥é—´éš”5ç§’
        
        // åŒæ­¥ç”¨æˆ·æ•°æ®åˆ°äº‘ç«¯å’Œæœ¬åœ°
        async function syncUserData() {
            const now = Date.now();
            if (now - lastSyncTime < MIN_SYNC_INTERVAL) {
                console.log('â° åŒæ­¥é—´éš”å¤ªçŸ­ï¼Œè·³è¿‡æ­¤æ¬¡åŒæ­¥');
                return;
            }
            
            try {
                console.log('ğŸ”„ å¼€å§‹åŒæ­¥ç”¨æˆ·æ•°æ®...');
                
                // ä»äº‘ç«¯è·å–æœ€æ–°æ•°æ®
                const cloudData = await loadUsersFromCloud();
                
                if (cloudData) {
                    // åˆå¹¶æœ¬åœ°å’Œäº‘ç«¯æ•°æ®
                    const localUsers = JSON.parse(localStorage.getItem('gameUsers')) || [];
                    const mergedUsers = mergeUserData(localUsers, cloudData.users);
                    
                    // æ›´æ–°æœ¬åœ°æ•°æ®
                    users = mergedUsers;
                    nextUserId = Math.max(cloudData.nextUserId, parseInt(localStorage.getItem('nextUserId')) || 1);
                    
                    // ä¿å­˜åˆå¹¶åçš„æ•°æ®åˆ°äº‘ç«¯å’Œæœ¬åœ°
                    await saveUsersToCloud(mergedUsers);
                    localStorage.setItem('gameUsers', JSON.stringify(mergedUsers));
                    localStorage.setItem('nextUserId', nextUserId.toString());
                    
                    console.log('âœ… æ•°æ®åŒæ­¥å®Œæˆï¼Œå…±', mergedUsers.length, 'ä¸ªç”¨æˆ·');
                } else {
                    // å¦‚æœäº‘ç«¯ä¸å¯ç”¨ï¼Œå°†æœ¬åœ°æ•°æ®æ¨é€åˆ°äº‘ç«¯
                    await saveUsersToCloud(users);
                    console.log('ğŸ“¤ æœ¬åœ°æ•°æ®å·²æ¨é€åˆ°äº‘ç«¯');
                }
                
                lastSyncTime = now;
            } catch (error) {
                console.error('âŒ æ•°æ®åŒæ­¥å¤±è´¥:', error);
            }
        }
        
        // åˆå¹¶ç”¨æˆ·æ•°æ®ï¼ˆé¿å…é‡å¤ï¼Œä¿ç•™æœ€æ–°ä¿¡æ¯ï¼‰
        function mergeUserData(localUsers, cloudUsers) {
            const merged = [...cloudUsers];
            
            localUsers.forEach(localUser => {
                const existingIndex = merged.findIndex(u => u.id === localUser.id);
                if (existingIndex === -1) {
                    // æœ¬åœ°æœ‰ä½†äº‘ç«¯æ²¡æœ‰çš„ç”¨æˆ·ï¼Œæ·»åŠ åˆ°åˆå¹¶åˆ—è¡¨
                    merged.push(localUser);
                } else {
                    // å¦‚æœæœ¬åœ°ç”¨æˆ·æ›´æ–°æ—¶é—´æ›´æ™šï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®
                    const localTime = new Date(localUser.createdAt || 0).getTime();
                    const cloudTime = new Date(merged[existingIndex].createdAt || 0).getTime();
                    if (localTime > cloudTime) {
                        merged[existingIndex] = localUser;
                    }
                }
            });
            
            return merged;
        }
        
        // å¯åŠ¨å®šæœŸåŒæ­¥
        function startDataSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
            }
            
            syncInterval = setInterval(syncUserData, SYNC_INTERVAL);
            console.log('ğŸ”„ å®šæœŸæ•°æ®åŒæ­¥å·²å¯åŠ¨ï¼Œé—´éš”:', SYNC_INTERVAL / 1000, 'ç§’');
        }
        
        // åœæ­¢å®šæœŸåŒæ­¥
        function stopDataSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
                console.log('â¹ï¸ å®šæœŸæ•°æ®åŒæ­¥å·²åœæ­¢');
            }
        }
        
        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶åŒæ­¥æ•°æ®
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // é¡µé¢å˜ä¸ºå¯è§æ—¶ï¼Œç«‹å³åŒæ­¥ä¸€æ¬¡æ•°æ®
                console.log('ğŸ‘ï¸ é¡µé¢å˜ä¸ºå¯è§ï¼Œæ‰§è¡Œæ•°æ®åŒæ­¥');
                syncUserData();
            }
        });
        
        // æ³¨é‡Šæ‰é¡µé¢å¸è½½å‰çš„åŒæ­¥ï¼Œé¿å…é˜»å¡é¡µé¢å…³é—­
        // window.addEventListener('beforeunload', () => {
        //     // å°è¯•åŒæ­¥æ•°æ®ï¼ˆå¯èƒ½ä¸ä¼šå®Œæˆï¼Œä½†å°½åŠ›è€Œä¸ºï¼‰
        //     syncUserData();
        // });
        
        async function initializeUserData() {
            // å°è¯•ä»äº‘ç«¯åŠ è½½
            const cloudData = await loadUsersFromCloud();
            
            if (cloudData) {
                users = cloudData.users;
                nextUserId = cloudData.nextUserId;
            } else {
                // å¦‚æœäº‘ç«¯åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®
                users = JSON.parse(localStorage.getItem('gameUsers')) || [];
                nextUserId = parseInt(localStorage.getItem('nextUserId')) || 1;
            }
            
            // ç¡®ä¿é»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·å­˜åœ¨
            const adminUser = {
                name: 'Henry',
                id: '00000000',
                password: '993966'
            };
            
            if (!users.find(u => u.id === '00000000')) {
                users.push(adminUser);
                await saveUsersToCloud(users);
            }
            
            // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°ä½œä¸ºå¤‡ä»½
            localStorage.setItem('gameUsers', JSON.stringify(users));
            localStorage.setItem('nextUserId', nextUserId.toString());
            
            console.log('ğŸ“Š ç”¨æˆ·æ•°æ®åˆå§‹åŒ–å®Œæˆï¼Œå…±', users.length, 'ä¸ªç”¨æˆ·');
            
            // å¯åŠ¨æ•°æ®åŒæ­¥
            startDataSync();
        }
        
        // æ°¸ä¹…ç”¨æˆ·ç®¡ç†åŠŸèƒ½
        function addToPermanentUsers(user) {
            // è·å–å½“å‰æ°¸ä¹…ç”¨æˆ·åˆ—è¡¨
            let permanentUsersList = JSON.parse(localStorage.getItem('permanentUsers')) || [];
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²åœ¨æ°¸ä¹…åˆ—è¡¨ä¸­
            if (!permanentUsersList.find(u => u.id === user.id)) {
                permanentUsersList.push(user);
                localStorage.setItem('permanentUsers', JSON.stringify(permanentUsersList));
                console.log('ç”¨æˆ·å·²æ·»åŠ åˆ°æ°¸ä¹…ä¿å­˜åˆ—è¡¨:', user.name, user.id);
            }
        }
        
        function loadPermanentUsers() {
            const permanentUsersList = JSON.parse(localStorage.getItem('permanentUsers')) || [];
            
            // ç¡®ä¿æ‰€æœ‰æ°¸ä¹…ç”¨æˆ·éƒ½åœ¨å½“å‰ç”¨æˆ·åˆ—è¡¨ä¸­
            permanentUsersList.forEach(permUser => {
                if (!users.find(u => u.id === permUser.id)) {
                    users.push(permUser);
                }
            });
            
            // æ›´æ–°localStorageä¸­çš„ç”¨æˆ·åˆ—è¡¨
            localStorage.setItem('gameUsers', JSON.stringify(users));
        }
        
        // åœ¨é¡µé¢åŠ è½½æ—¶åŠ è½½æ°¸ä¹…ç”¨æˆ·
        loadPermanentUsers();
        
        // æ·»åŠ é»˜è®¤ç”¨æˆ·Henryå’Œå…¶ä»–æ°¸ä¹…ç”¨æˆ·
        const permanentUsers = [
            {
                name: 'Henry',
                id: '00000000',
                password: '993966'
            }
        ];
        
        // ç¡®ä¿æ°¸ä¹…ç”¨æˆ·å§‹ç»ˆå­˜åœ¨
        permanentUsers.forEach(permUser => {
            if (!users.find(u => u.id === permUser.id)) {
                users.push(permUser);
            }
            // åŒæ—¶å°†é»˜è®¤ç”¨æˆ·æ·»åŠ åˆ°æ°¸ä¹…ç”¨æˆ·åˆ—è¡¨
            addToPermanentUsers(permUser);
        });
        
        // å¦‚æœæ²¡æœ‰ä»»ä½•ç”¨æˆ·ï¼Œæ·»åŠ é»˜è®¤ç”¨æˆ·
        if (users.length === 0) {
            users = [...permanentUsers];
        }
        
        // ä¿å­˜æ›´æ–°åçš„ç”¨æˆ·åˆ—è¡¨
        localStorage.setItem('gameUsers', JSON.stringify(users));
         
         // ç™»å½•æ³¨å†Œç³»ç»ŸåŠŸèƒ½
        function initLoginSystem() {
            console.log('initLoginSystemå‡½æ•°è¢«è°ƒç”¨');
            // æ˜¾ç¤ºç™»å½•ç•Œé¢
            const loginScreen = document.getElementById('loginScreen');
            const welcomeScreen = document.getElementById('welcomeScreen');
            
            console.log('loginScreenå…ƒç´ :', loginScreen);
            console.log('welcomeScreenå…ƒç´ :', welcomeScreen);
            
            if (loginScreen) {
                loginScreen.style.display = 'flex';
                loginScreen.style.visibility = 'visible';
                loginScreen.style.zIndex = '200';
            }
            
            if (welcomeScreen) {
                welcomeScreen.style.display = 'none';
                welcomeScreen.style.visibility = 'hidden';
                welcomeScreen.style.zIndex = '-1';
            }
            
            // ç¡®ä¿å…ƒç´ å­˜åœ¨åå†ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            const loginBtn = document.getElementById('loginBtn');
            console.log('loginBtnå…ƒç´ :', loginBtn);
            const showRegisterBtn = document.getElementById('showRegisterBtn');
            const registerBtn = document.getElementById('registerBtn');
            const backToLoginBtn = document.getElementById('backToLoginBtn');
            const loginPassword = document.getElementById('loginPassword');
            const registerPassword = document.getElementById('registerPassword');
            
            if (loginBtn) {
                console.log('ä¸ºloginBtnç»‘å®šç‚¹å‡»äº‹ä»¶');
                loginBtn.removeEventListener('click', handleLogin); // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç›‘å¬å™¨
                loginBtn.addEventListener('click', function() {
                    console.log('ç™»å½•æŒ‰é’®è¢«ç‚¹å‡»äº†ï¼');
                    handleLogin();
                });
                console.log('loginBtnäº‹ä»¶ç»‘å®šå®Œæˆ');
            } else {
                console.error('loginBtnå…ƒç´ æœªæ‰¾åˆ°ï¼');
            }
            if (showRegisterBtn) {
                showRegisterBtn.removeEventListener('click', showRegisterForm);
                showRegisterBtn.addEventListener('click', showRegisterForm);
            }
            if (registerBtn) {
                registerBtn.removeEventListener('click', handleRegister);
                registerBtn.addEventListener('click', handleRegister);
            }
            if (backToLoginBtn) {
                backToLoginBtn.removeEventListener('click', showLoginForm);
                backToLoginBtn.addEventListener('click', showLoginForm);
            }
            
            // å›è½¦é”®ç™»å½•
            if (loginPassword) {
                loginPassword.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleLogin();
                    }
                });
            }
            
            // å›è½¦é”®æ³¨å†Œ
            if (registerPassword) {
                registerPassword.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleRegister();
                    }
                });
            }
        }
        
        function showRegisterForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'flex';
        }
        
        function showLoginForm() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'flex';
        }
        
        async function handleLogin() {
            console.log('handleLoginå‡½æ•°è¢«è°ƒç”¨');
            const loginBtn = document.getElementById('loginBtn');
            
            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            if (loginBtn) {
                loginBtn.disabled = true;
                loginBtn.style.backgroundColor = '#cccccc';
                loginBtn.style.cursor = 'not-allowed';
                loginBtn.textContent = 'ç™»å½•ä¸­...';
                
                // è®¾ç½®ä¸€ä¸ªå¤‡ç”¨çš„é‡ç½®æœºåˆ¶ï¼Œé˜²æ­¢æŒ‰é’®æ°¸è¿œå¡ä½
                setTimeout(() => {
                    console.log('å¤‡ç”¨é‡ç½®æœºåˆ¶è§¦å‘');
                    if (loginBtn.textContent === 'ç™»å½•ä¸­...') {
                        console.log('æ£€æµ‹åˆ°æŒ‰é’®ä»åœ¨åŠ è½½çŠ¶æ€ï¼Œå¼ºåˆ¶é‡ç½®');
                        resetLoginButton();
                    }
                }, 10000); // 10ç§’åå¼ºåˆ¶é‡ç½®
            }
            
            const id = document.getElementById('loginId').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            console.log('è¾“å…¥çš„ID:', id, 'å¯†ç :', password);
            
            try {
                if (!id || !password) {
                    console.log('è¾“å…¥éªŒè¯å¤±è´¥ï¼šIDæˆ–å¯†ç ä¸ºç©º');
                    alert('è¯·è¾“å…¥IDå’Œå¯†ç ï¼');
                    resetLoginButton();
                    return;
                }
                
                // ä»äº‘ç«¯åŠ è½½æœ€æ–°ç”¨æˆ·æ•°æ®
                console.log('æ­£åœ¨ä»äº‘ç«¯éªŒè¯ç”¨æˆ·å‡­æ®...');
                const cloudUsers = await loadUsersFromCloud();
                
                // å¦‚æœäº‘ç«¯åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®ä½œä¸ºå¤‡ä»½
                const usersToCheck = cloudUsers || users;
                console.log('ä½¿ç”¨çš„ç”¨æˆ·æ•°æ®æº:', cloudUsers ? 'äº‘ç«¯' : 'æœ¬åœ°');
                console.log('å½“å‰ç”¨æˆ·æ•°æ®:', usersToCheck);
                
                console.log('å¼€å§‹æŸ¥æ‰¾ç”¨æˆ·ï¼ŒæŸ¥æ‰¾æ¡ä»¶ï¼š', {id, password});
                const user = usersToCheck.find(u => u.id === id && u.password === password);
                console.log('æŸ¥æ‰¾ç»“æœï¼š', user);
                
                if (user) {
                    console.log('ç™»å½•æˆåŠŸï¼Œç”¨æˆ·:', user);
                    currentUser = user;
                    
                    // å¦‚æœä½¿ç”¨äº‘ç«¯æ•°æ®æˆåŠŸç™»å½•ï¼ŒåŒæ­¥åˆ°æœ¬åœ°
                    if (cloudUsers) {
                        users = cloudUsers;
                        localStorage.setItem('gameUsers', JSON.stringify(users));
                        console.log('ç”¨æˆ·æ•°æ®å·²åŒæ­¥åˆ°æœ¬åœ°');
                    }
                    
                    // é‡æ–°åˆå§‹åŒ–é‚®ç®±ï¼ˆç®¡ç†å‘˜æ‰æœ‰é‚®ç®±ï¼‰
                    initializeMailbox();
                    updateUnreadCount();
                    // ç™»å½•æˆåŠŸåæ˜¾ç¤ºé‚®ç®±å’Œå»ºè®®æŒ‰é’®
                    showMailboxButton();
                    showSuggestionButton();
                    
                    // æ˜¾ç¤ºåˆ›å»ºæˆ¿é—´å’Œå¹¿åœºæŒ‰é’®
                    const createRoomButton = document.getElementById('createRoomButton');
                    const squareButton = document.getElementById('squareButton');
                    if (createRoomButton) {
                        createRoomButton.style.display = 'flex';
                    }
                    if (squareButton) {
                        squareButton.style.display = 'flex';
                    }
                    console.log('å³å°†è°ƒç”¨startGameå‡½æ•°');
                    startGame();
                    console.log('startGameå‡½æ•°è°ƒç”¨å®Œæˆ');
                    // ç™»å½•æˆåŠŸåä¸é‡ç½®æŒ‰é’®ï¼Œå› ä¸ºç•Œé¢å·²ç»åˆ‡æ¢
                } else {
                    console.log('ç™»å½•å¤±è´¥ï¼Œç”¨æˆ·ä¸å­˜åœ¨æˆ–å¯†ç é”™è¯¯');
                    alert('IDæˆ–å¯†ç é”™è¯¯ï¼');
                    resetLoginButton();
                }
            } catch (error) {
                console.error('ç™»å½•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                alert('ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ï¼');
                resetLoginButton();
            }
        }
        
        function resetLoginButton() {
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
                loginBtn.disabled = false;
                loginBtn.style.backgroundColor = '';
                loginBtn.style.cursor = 'pointer';
                loginBtn.textContent = 'ç™»å½•';
            }
        }
        
        async function handleRegister() {
            const registerBtn = document.getElementById('registerBtn');
            
            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            if (registerBtn) {
                registerBtn.disabled = true;
                registerBtn.style.backgroundColor = '#cccccc';
                registerBtn.style.cursor = 'not-allowed';
                registerBtn.textContent = 'æ³¨å†Œä¸­...';
            }
            
            const name = document.getElementById('registerName').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            
            try {
                if (!name || !password) {
                    console.log('è¯·è¾“å…¥åå­—å’Œå¯†ç ï¼');
                    resetRegisterButton();
                    return;
                }
                
                if (password.length !== 6) {
                    console.log('æ–¹æ–¹ç å¿…é¡»æ˜¯6ä½æ•°å­—ï¼');
                    resetRegisterButton();
                    return;
                }
                
                if (!/^\d{6}$/.test(password)) {
                    console.log('æ–¹æ–¹ç åªèƒ½åŒ…å«æ•°å­—ï¼');
                    resetRegisterButton();
                    return;
                }
                
                // å…ˆä»äº‘ç«¯åŠ è½½æœ€æ–°æ•°æ®ï¼Œç¡®ä¿IDä¸é‡å¤
                const cloudData = await loadUsersFromCloud();
                if (cloudData) {
                    users = cloudData.users;
                    nextUserId = cloudData.nextUserId;
                }
                
                // ç”Ÿæˆ8ä½ID
                const newId = nextUserId.toString().padStart(8, '0');
                
                // æ£€æŸ¥IDæ˜¯å¦å·²å­˜åœ¨
                if (users.find(u => u.id === newId)) {
                    nextUserId++;
                    resetRegisterButton();
                    handleRegister(); // é€’å½’è°ƒç”¨ç›´åˆ°æ‰¾åˆ°å¯ç”¨ID
                    return;
                }
                
                // åˆ›å»ºæ–°ç”¨æˆ·
                const newUser = {
                    name: name,
                    id: newId,
                    password: password,
                    createdAt: new Date().toISOString(),
                    deviceInfo: navigator.userAgent
                };
                
                users.push(newUser);
                nextUserId++;
                
                // åŒæ­¥åˆ°äº‘ç«¯
                const cloudSyncSuccess = await saveUsersToCloud(users);
                
                if (cloudSyncSuccess) {
                    console.log('âœ… æ–°ç”¨æˆ·å·²åŒæ­¥åˆ°äº‘ç«¯:', newUser.name, newUser.id);
                } else {
                    console.log('âš ï¸ äº‘ç«¯åŒæ­¥å¤±è´¥ï¼Œä½†ç”¨æˆ·å·²ä¿å­˜åˆ°æœ¬åœ°');
                }
                
                // ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ä»½
                localStorage.setItem('gameUsers', JSON.stringify(users));
                localStorage.setItem('nextUserId', nextUserId.toString());
                
                // æ˜¾ç¤ºIDå¼¹çª—
                showIdDisplay(newId);
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('registerName').value = '';
                document.getElementById('registerPassword').value = '';
                
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                resetRegisterButton();
                
                // 3ç§’åè¿”å›ç™»å½•ç•Œé¢
                setTimeout(() => {
                    showLoginForm();
                }, 3000);
                
            } catch (error) {
                console.error('âŒ æ³¨å†Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                resetRegisterButton();
            }
        }
        
        function resetRegisterButton() {
            const registerBtn = document.getElementById('registerBtn');
            if (registerBtn) {
                registerBtn.disabled = false;
                registerBtn.style.backgroundColor = '';
                registerBtn.style.cursor = 'pointer';
                registerBtn.textContent = 'æ³¨å†Œ';
            }
        }
        
        function showIdDisplay(id) {
            document.getElementById('idDisplayText').textContent = `ä½ çš„IDæ˜¯ï¼š${id}`;
            const modal = document.getElementById('idDisplayModal');
            modal.style.display = 'block';
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                modal.style.display = 'none';
            }, 3000);
        }
        
        function startGame() {
            console.log('startGameå‡½æ•°è¢«è°ƒç”¨');
            console.log('å½“å‰ç”¨æˆ·:', currentUser);
            
            // æ³¨é‡Šæ‰onGameStartè°ƒç”¨ï¼Œè®©æŒ‰é’®åœ¨ç™»å½•åä¿æŒæ˜¾ç¤º
            // onGameStart();
            
            // éšè—ç™»å½•ç•Œé¢
            const loginScreen = document.getElementById('loginScreen');
            if (loginScreen) {
                loginScreen.style.display = 'none';
                loginScreen.style.visibility = 'hidden';
                loginScreen.style.zIndex = '-1';
                console.log('ç™»å½•ç•Œé¢å·²éšè—');
            } else {
                console.error('æ‰¾ä¸åˆ°loginScreenå…ƒç´ ');
            }
            
            // æ˜¾ç¤ºæ¸¸æˆç•Œé¢
            const welcomeScreen = document.getElementById('welcomeScreen');
            if (welcomeScreen) {
                welcomeScreen.style.display = 'flex';
                welcomeScreen.style.visibility = 'visible';
                welcomeScreen.style.zIndex = '100';
                welcomeScreen.style.position = 'fixed';
                welcomeScreen.style.top = '0';
                welcomeScreen.style.left = '0';
                welcomeScreen.style.width = '100%';
                welcomeScreen.style.height = '100%';
                welcomeScreen.style.backgroundColor = '#1a1a2e';
                console.log('æ¸¸æˆç•Œé¢å·²æ˜¾ç¤ºï¼Œæ ·å¼å·²å¼ºåˆ¶è®¾ç½®');
                console.log('welcomeScreenå½“å‰æ ·å¼:', {
                    display: welcomeScreen.style.display,
                    visibility: welcomeScreen.style.visibility,
                    zIndex: welcomeScreen.style.zIndex
                });
            } else {
                console.error('æ‰¾ä¸åˆ°welcomeScreenå…ƒç´ ');
            }
            
            // æ›´æ–°æ¬¢è¿ä¿¡æ¯
            const welcomeMessage = document.getElementById('welcomeMessage');
            if (welcomeMessage && currentUser) {
                welcomeMessage.textContent = `æ¬¢è¿ï¼${currentUser.name}`;
                console.log('æ¬¢è¿ä¿¡æ¯å·²æ›´æ–°:', welcomeMessage.textContent);
            } else {
                console.error('æ‰¾ä¸åˆ°welcomeMessageå…ƒç´ æˆ–currentUserä¸ºç©º');
            }
            
            // æ¸…ç©ºç™»å½•è¡¨å•
            const loginId = document.getElementById('loginId');
            const loginPassword = document.getElementById('loginPassword');
            if (loginId) loginId.value = '';
            if (loginPassword) loginPassword.value = '';
            console.log('ç™»å½•è¡¨å•å·²æ¸…ç©º');
        }
        
        // æ ¹æ®ç”µè„‘ç‰¹å¾ç¡®å®šç©å®¶ç¼–å·çš„å¸¸é‡
        const playerCount = getPlayerNumberByDevice();

    // æ ¹æ®è®¾å¤‡ç‰¹å¾ç¡®å®šç©å®¶ç¼–å·
    function getPlayerNumberByDevice() {
        // ä½¿ç”¨å¤šç§è®¾å¤‡ç‰¹å¾æ¥ç”Ÿæˆå”¯ä¸€æ ‡è¯†
        const deviceInfo = {
            userAgent: navigator.userAgent,
            language: navigator.language,
            platform: navigator.platform,
            screenWidth: screen.width,
            screenHeight: screen.height,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            cookieEnabled: navigator.cookieEnabled,
            onLine: navigator.onLine
        };
        
        // å°†è®¾å¤‡ä¿¡æ¯è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶ç”Ÿæˆå“ˆå¸Œ
        const deviceString = JSON.stringify(deviceInfo);
        let hash = 0;
        for (let i = 0; i < deviceString.length; i++) {
            const char = deviceString.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
        }
        
        // å°†å“ˆå¸Œå€¼è½¬æ¢ä¸º1-4ä¹‹é—´çš„ç©å®¶ç¼–å·
        const playerNumber = Math.abs(hash % 4) + 1;
        
        // å­˜å‚¨åˆ°localStorageä»¥ä¿æŒä¸€è‡´æ€§
        const storedPlayerNumber = localStorage.getItem('playerNumber');
        if (storedPlayerNumber) {
            return parseInt(storedPlayerNumber);
        } else {
            localStorage.setItem('playerNumber', playerNumber.toString());
            return playerNumber;
        }
    }

    // å¢åŠ ç©å®¶è®¡æ•°å™¨ï¼ˆä¿ç•™åŸå‡½æ•°åä»¥å…¼å®¹ç°æœ‰ä»£ç ï¼Œä½†ç°åœ¨åªæ›´æ–°æ˜¾ç¤ºï¼‰
    function incrementPlayerCount() {
        // playerCountç°åœ¨æ˜¯å¸¸é‡ï¼Œä¸å†æ”¹å˜ï¼Œåªæ›´æ–°æ˜¾ç¤º
        document.getElementById('welcomeMessage').textContent = `æ¬¢è¿ç©å®¶${playerCount}å·`;
    }

    // åˆå§‹åŒ–æ¬¢è¿æ¶ˆæ¯
    function initWelcomeMessage() {
        document.getElementById('welcomeMessage').textContent = `æ¬¢è¿ç©å®¶${playerCount}å·`;
    }
    function showRules() {
        // ç›´æ¥æ˜¾ç¤ºREADMEæ–‡ä»¶å†…å®¹ï¼Œä¸å†è¯¢é—®å•äººè¿˜æ˜¯åŒäººæ¨¡å¼
        const readmeContent = `
            <h1>å¯¹æˆ˜æ¸¸æˆè¯´æ˜</h1>


            <h2>æ¸¸æˆæ§åˆ¶</h2>

<h3>ç©å®¶1æ§åˆ¶</h3>
        <ul>
            <li><strong>WASDé”®</strong>ï¼šç§»åŠ¨è§’è‰²</li>
            <li><strong>é¼ æ ‡å·¦é”®</strong>ï¼šç²¾ç¡®æŠ•æ·æ‰‹é›·åˆ°ç‚¹å‡»ä½ç½®(åªåœ¨å•äººæ¸¸æˆæœ‰æ•ˆï¼ŒåŒäººæ¸¸æˆä¸‹æ— æ•ˆ)</li>
            <li><strong>";"é”®</strong>ï¼šèŒƒå›´ä¼¤å®³ï¼ˆåªåœ¨åŒäººæ¸¸æˆæœ‰æ•ˆï¼Œå•äººæ¸¸æˆä¸‹æ— æ•ˆï¼‰</li>
            <li><strong>â€œâ€˜â€é”®</strong>ï¼šæ”¾ç½®åœ°é›·</li>
            <li><strong>â€œç©ºæ ¼â€é”®</strong>ï¼šæ—‹è½¬å°„å‡»</li>


<h3>ç©å®¶2æ§åˆ¶ï¼ˆåŒäººæ¨¡å¼ï¼‰</h3>
        <ul>
            <li><strong>WASDé”®</strong>ï¼šç§»åŠ¨è§’è‰²</li>
            <li><strong>Dé”®</strong>ï¼šèŒƒå›´ä¼¤å®³ï¼ˆåªåœ¨åŒäººæ¸¸æˆæœ‰æ•ˆï¼Œå•äººæ¸¸æˆä¸‹æ— æ•ˆï¼‰</li>
            <li><strong>Fé”®</strong>ï¼šæ”¾ç½®åœ°é›·ï¼ˆæ•Œäººè¸©åˆ°å®ƒå0.5ç§’çˆ†ç‚¸ï¼Œä¼¤å®³èŒƒå›´å†…æ•Œäººï¼‰</li>
            <li><strong>Gé”®</strong>ï¼šæ—‹è½¬å°„å‡»ï¼ˆæ¯0.3ç§’å‘ä¸åŒæ–¹å‘å‘å°„å­å¼¹ï¼‰</li>
        </ul>

<h2>æŠ€èƒ½è¯´æ˜</h2>
        <ol>

            <li><strong>æ‰‹é›·æ”»å‡»</strong>
                <ul><li>å†·å´æ—¶é—´10ç§’</li></ul>
            </li>

            <li><strong>åœ°é›·æŠ€èƒ½</strong>
                <ul>
                    <li>æ”¾ç½®æ•Œäººè¸©åˆ°å0.5ç§’çˆ†ç‚¸</li>
                    <li>å†·å´æ—¶é—´10ç§’</li>
                    <li>å¯¹èŒƒå›´å†…æ•Œäººé€ æˆ60ç‚¹ä¼¤å®³</li>
                </ul>
            </li>

            <li><strong>æ—‹è½¬å°„å‡»</strong>
                <ul>
                    <li>æŒç»­5ç§’</li>
                    <li>å†·å´æ—¶é—´60ç§’</li>
                    <li>æ¯0.1ç§’å‘å°„ä¸€æ¬¡å­å¼¹</li>
                    <li>å­å¼¹ä¼¤å®³5ç‚¹</li>
                </ul>
            </li>
        </ol>


<h2>æ•Œäººç±»å‹</h2>
        <ol>

            <li><strong>ç´«è‰²æ•Œäºº</strong>
                <ul>
                    <li>è¡€é‡é«˜ï¼ˆ80ç‚¹ï¼‰</li>
                    <li>ç§»åŠ¨æ…¢</li>
                </ul>
            </li>

            <li><strong>çº¢è‰²æ•Œäºº</strong>
                <ul>
                    <li>è¡€é‡ä½ï¼ˆ50ç‚¹ï¼‰</li>
                    <li>ç§»åŠ¨å¿«</li>
                    <li>æ”»å‡»æ—¶ç§»åŠ¨é€Ÿåº¦é™ä½20%</li>
                </ul>
            </li>
        </ol>

<h2>æ¸¸æˆç‰¹è‰²</h2>
        <ul>
            <li>åŒäººåˆä½œæ¨¡å¼</li>
            <li>å¤šç§æ•Œäººç±»å‹ï¼ˆç´«è‰²å’Œçº¢è‰²æ•Œäººï¼‰</li>
            <li>å¼ºå¤§çš„Bossæˆ˜æ–—ç³»ç»Ÿ</li>
            <li>ä¸°å¯Œçš„æŠ€èƒ½ç³»ç»Ÿï¼ˆæ™®é€šæ”»å‡»ã€åœ°é›·ã€æ‰‹é›·ã€æ—‹è½¬å°„å‡»ï¼‰</li>
            <li>ç²¾ç¡®çš„æ‰‹é›·æŠ•æ·ç³»ç»Ÿ</li>
            <li>åŠ¨æ€éŸ³æ•ˆç³»ç»Ÿ</li>
        </ul>

<h2>BossæŠ€èƒ½ç³»ç»Ÿ</h2>

<h3>Bossæ”»å‡»æœºåˆ¶</h3>
        <ul>
            <li><strong>å­å¼¹æ”»å‡»</strong>ï¼šBosså‘å°„çš„å­å¼¹å‡»ä¸­ç©å®¶æ—¶ï¼Œé€ æˆ45ç‚¹ä¼¤å®³å¹¶äº§ç”Ÿçˆ†ç‚¸æ•ˆæœï¼Œä½¿ç©å®¶ç§»åŠ¨é€Ÿåº¦å‡æ…¢70%ï¼Œå‡é€Ÿæ•ˆæœæŒç»­10ç§’</li>
            <li><strong>æ¥è§¦ä¼¤å®³</strong>ï¼šå½“Bossç›´æ¥æ¥è§¦ç©å®¶æ—¶ï¼Œæ¯0.5ç§’è¿ç»­æ‰£é™¤0.2è¡€é‡</li>
            <li><strong>æŠ€èƒ½é‡Šæ”¾</strong>ï¼šBossä¼šå®šæœŸé‡Šæ”¾å¤šæ³¢å­å¼¹æ”»å‡»</li>
        </ul>

<h3>Bossé˜²å¾¡æœºåˆ¶</h3>
        <ul>
            <li>Bosså¯ä»¥è¢«ç©å®¶çš„å­å¼¹å‡»ä¸­å¹¶æ‰£è¡€</li>
            <li>Bossè¡€é‡è€—å°½åä¼šæ­»äº¡ï¼Œæ¸¸æˆèƒœåˆ©</li>
        </ul>

<h2>æ¸¸æˆè§„åˆ™</h2>
        <ol>
            <li>å‡»è´¥æ‰€æœ‰æ•Œäººè·èƒœ</li>
            <li>ç©å®¶è¡€é‡å½’é›¶åˆ™å¤±è´¥</li>
            <li>æ¸¸æˆç»“æŸåå¯åˆ·æ–°é¡µé¢è¿”å›ä¸»ç•Œé¢</li>
        </ol>

        `;
        
        document.getElementById('rulesContent').innerHTML = readmeContent;
        document.getElementById('rulesModal').style.display = 'block';
    }

    const rulesContentSinglePlayer = `
        <h3>å•äººæ¨¡å¼æ¸¸æˆæ§åˆ¶</h3>
        <p>æ–¹å‘é”®ï¼šç§»åŠ¨è§’è‰²</p>
        <p>é¼ æ ‡å·¦é”®ï¼šæŠ•å‡ºæ‰‹é›·</p>
        <p>å•å¼•å·é”®ï¼šæ”¾ç½®åœ°é›·</p>
        <p>ç©ºæ ¼é”®ï¼šæ—‹è½¬å°„å‡»</p>

        <h3>æŠ€èƒ½è¯´æ˜</h3>
        <p>1. <strong>æ‰‹é›·æ”»å‡»</strong></p>
        <ul>
            <li>å†·å´æ—¶é—´2ç§’</li>
            <li>æ”»å‡»æ—¶ç§»åŠ¨é€Ÿåº¦é™ä½30%</li>
        </ul>
        <p>2. <strong>åœ°é›·æŠ€èƒ½</strong></p>
        <ul>
            <li>æ”¾ç½®æ•Œäººè¸©åˆ°å0.5ç§’çˆ†ç‚¸</li>
            <li>å†·å´æ—¶é—´10ç§’</li>
            <li>å¯¹èŒƒå›´å†…æ•Œäººé€ æˆ60ç‚¹ä¼¤å®³</li>
        </ul>
        <p>3. <strong>æ—‹è½¬å°„å‡»</strong></p>
        <ul>
            <li>æŒç»­5ç§’</li>
            <li>å†·å´æ—¶é—´60ç§’</li>
            <li>æ¯0.1ç§’å‘å°„ä¸€æ¬¡å­å¼¹</li>
            <li>å­å¼¹ä¼¤å®³5ç‚¹</li>
        </ul>
        <p>4. <strong>èŒƒå›´æ”»å‡»</strong></p>
        <ul>
            <li>ä»¥ç©å®¶ä¸ºä¸­å¿ƒçš„ç¬é—´èŒƒå›´æ”»å‡»</li>
            <li>å†·å´æ—¶é—´1ç§’</li>
            <li>å¯¹èŒƒå›´å†…æ•Œäººé€ æˆ15ç‚¹ä¼¤å®³</li>
        </ul>

        <h3>æ•Œäººç±»å‹</h3>
        <p>1. <strong>ç´«è‰²æ•Œäºº</strong></p>
        <ul>
            <li>è¡€é‡é«˜ï¼ˆ80ç‚¹ï¼‰</li>
            <li>ç§»åŠ¨æ…¢</li>
        </ul>
        <p>2. <strong>çº¢è‰²æ•Œäºº</strong></p>
        <ul>
            <li>è¡€é‡ä½ï¼ˆ50ç‚¹ï¼‰</li>
            <li>ç§»åŠ¨å¿«</li>
            <li>æ”»å‡»æ—¶ç§»åŠ¨é€Ÿåº¦é™ä½20%</li>
        </ul>

        <h3>æ¸¸æˆè§„åˆ™</h3>
        <p>1. å‡»è´¥æ‰€æœ‰æ•Œäººè·èƒœ</p>
        <p>2. ç©å®¶è¡€é‡å½’é›¶åˆ™å¤±è´¥</p>
        <p>3. æ¸¸æˆç»“æŸåå¯åˆ·æ–°é¡µé¢è¿”å›ä¸»ç•Œé¢</p>
    `;

    const rulesContentMultiPlayer = `
        <h3>åŒäººæ¨¡å¼æ¸¸æˆæ§åˆ¶</h3>
        <p>ç©å®¶1ï¼šWASDæˆ–IJKL ç§»åŠ¨ï¼ŒDé”® éšæœºæŠ•æ·ï¼Œé¼ æ ‡å·¦é”® èŒƒå›´æ”»å‡»ï¼ŒFé”® æ”¾ç½®åœ°é›·ï¼ŒGé”® æ—‹è½¬å°„å‡»</p>
        <p>ç©å®¶2ï¼šæ–¹å‘é”® ç§»åŠ¨ï¼Œ;é”® éšæœºæŠ•æ·ï¼ŒShift+é¼ æ ‡å·¦é”® èŒƒå›´æ”»å‡»ï¼Œ'é”® æ”¾ç½®åœ°é›·ï¼Œç©ºæ ¼é”® æ—‹è½¬å°„å‡»</p>

        <h3>æŠ€èƒ½è¯´æ˜ (åŒå•äººæ¨¡å¼)</h3>
        <p>1. <strong>æ‰‹é›·æ”»å‡»</strong></p>
        <ul>
            <li>å†·å´æ—¶é—´2ç§’</li>
            <li>æ”»å‡»æ—¶ç§»åŠ¨é€Ÿåº¦é™ä½30%</li>
        </ul>
        <p>2. <strong>åœ°é›·æŠ€èƒ½</strong></p>
        <ul>
            <li>æ”¾ç½®æ•Œäººè¸©åˆ°å0.5ç§’çˆ†ç‚¸</li>
            <li>å†·å´æ—¶é—´10ç§’</li>
            <li>å¯¹èŒƒå›´å†…æ•Œäººé€ æˆ60ç‚¹ä¼¤å®³</li>
        </ul>
        <p>3. <strong>æ—‹è½¬å°„å‡»</strong></p>
        <ul>
            <li>æŒç»­5ç§’</li>
            <li>å†·å´æ—¶é—´60ç§’</li>
            <li>æ¯0.1ç§’å‘å°„ä¸€æ¬¡å­å¼¹</li>
            <li>å­å¼¹ä¼¤å®³5ç‚¹</li>
        </ul>

        <h3>æ•Œäººç±»å‹ (åŒå•äººæ¨¡å¼)</h3>
        <p>1. <strong>ç´«è‰²æ•Œäºº</strong></p>
        <ul>
            <li>è¡€é‡é«˜ï¼ˆ80ç‚¹ï¼‰</li>
            <li>ç§»åŠ¨æ…¢</li>
        </ul>
        <p>2. <strong>çº¢è‰²æ•Œäºº</strong></p>
        <ul>
            <li>è¡€é‡ä½ï¼ˆ50ç‚¹ï¼‰</li>
            <li>ç§»åŠ¨å¿«</li>
            <li>æ”»å‡»æ—¶ç§»åŠ¨é€Ÿåº¦é™ä½20%</li>
        </ul>

        <h3>æ¸¸æˆè§„åˆ™</h3>
        <p>1. å‡»è´¥æ‰€æœ‰æ•Œäººè·èƒœ</p>
        <p>2. ç©å®¶è¡€é‡å½’é›¶åˆ™å¤±è´¥</p>
        <p>3. æ¸¸æˆç»“æŸåå¯åˆ·æ–°é¡µé¢è¿”å›ä¸»ç•Œé¢</p>
    `;

    document.getElementById('singlePlayerRulesBtn').addEventListener('click', function() {
        document.getElementById('rulesSelectModal').style.display = 'none';
        document.getElementById('rulesContent').innerHTML = rulesContentSinglePlayer;
        document.getElementById('rulesModal').style.display = 'block';
    });

    document.getElementById('multiPlayerRulesBtn').addEventListener('click', function() {
        document.getElementById('rulesSelectModal').style.display = 'none';
        document.getElementById('rulesContent').innerHTML = rulesContentMultiPlayer;
        document.getElementById('rulesModal').style.display = 'block';
    });
    // å•äººå¯¹æˆ˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('singlePlayerBtn').addEventListener('click', function() {
        // æ˜¾ç¤ºéš¾åº¦é€‰æ‹©æ¨¡æ€æ¡†
        document.getElementById('difficultyModal').style.display = 'block';
    });

    // å…¨å±€å˜é‡å­˜å‚¨é€‰æ‹©çš„éš¾åº¦å’Œåœ°å½¢
    let selectedDifficulty = null;
    let selectedTerrain = [];

    // éš¾åº¦é€‰æ‹©æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('easyModeBtn').addEventListener('click', function() {
        selectedDifficulty = 'easy';
        showTerrainSelection();
    });
    document.getElementById('normalModeBtn').addEventListener('click', function() {
        selectedDifficulty = 'normal';
        showTerrainSelection();
    });
    document.getElementById('hardModeBtn').addEventListener('click', function() {
        selectedDifficulty = 'hard';
        showTerrainSelection();
    });
    document.getElementById('hellModeBtn').addEventListener('click', function() {
        selectedDifficulty = 'hell';
        showTerrainSelection();
    });

    // æ˜¾ç¤ºåœ°å½¢é€‰æ‹©æ¨¡æ€æ¡†
    function showTerrainSelection() {
        document.getElementById('difficultyModal').style.display = 'none';
        document.getElementById('terrainModal').style.display = 'block';
    }

    // åœ°å½¢é€‰æ‹©æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.terrainButton').forEach(button => {
        button.addEventListener('click', function() {
            const terrain = this.getAttribute('data-terrain');
            const indicator = this.querySelector('.terrainIndicator');
            
            if (this.classList.contains('selected')) {
                // å–æ¶ˆé€‰æ‹©
                this.classList.remove('selected');
                selectedTerrain = selectedTerrain.filter(t => t !== terrain);
            } else {
                // é€‰æ‹©åœ°å½¢
                this.classList.add('selected');
                if (!selectedTerrain.includes(terrain)) {
                    selectedTerrain.push(terrain);
                }
            }
        });
    });

    // å¼€å§‹æ¸¸æˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('startGameBtn').addEventListener('click', function() {
        if (selectedDifficulty) {
            const mode = window.gameMode || 'single';
            startActualGame(selectedDifficulty, mode, selectedTerrain);
            window.gameMode = null; // é‡ç½®æ¨¡å¼æ ‡è®°
            selectedDifficulty = null;
            selectedTerrain = [];
            // é‡ç½®åœ°å½¢é€‰æ‹©çŠ¶æ€
            document.querySelectorAll('.terrainButton').forEach(btn => {
                btn.classList.remove('selected');
            });
        }
    });

    // å¼€å§‹æ¸¸æˆå‡½æ•°
    function startActualGame(difficulty, mode = 'single', terrains = []) { // mode: 'single' or 'multi', terrains: array of selected terrains
        // æ¸¸æˆçœŸæ­£å¼€å§‹æ—¶éšè—æŒ‰é’®
        onGameStart();
        
        document.getElementById('difficultyModal').style.display = 'none';
        document.getElementById('terrainModal').style.display = 'none';
        hideSuggestionButton(); // éšè—å»ºè®®æŒ‰é’®
        incrementPlayerCount();
        initWelcomeMessage();
        document.getElementById('welcomeScreen').style.display = 'none';
        const gameCanvas = document.getElementById('gameCanvas');
        gameCanvas.style.filter = 'none';
        gameCanvas.classList.add('game-active');
        
        // è®¾ç½®æ¸¸æˆèƒŒæ™¯ä¸ºé»‘è‰²
        document.body.style.backgroundColor = 'black';
        document.body.style.backgroundImage = 'none';
        
        currentGameMode = mode; // è®¾ç½®å½“å‰æ¸¸æˆæ¨¡å¼
        currentTerrains = terrains; // è®¾ç½®å½“å‰åœ°å½¢
        init(difficulty, mode, terrains); // åˆå§‹åŒ–æ¸¸æˆå¹¶ä¼ å…¥éš¾åº¦å‚æ•°ã€æ¨¡å¼å’Œåœ°å½¢
        gameRunning = true; // æ¸¸æˆçŠ¶æ€è®¾ç½®ä¸ºè¿è¡Œä¸­
        gameStartTime = Date.now(); // è®°å½•æ¸¸æˆå¼€å§‹æ—¶é—´
    lastBossSpawnCheckTime = 0; // åˆå§‹åŒ–ä¸Šæ¬¡æ£€æŸ¥Bossç”Ÿæˆçš„æ—¶é—´ä¸º0ï¼Œç¡®ä¿ç¬¬ä¸€æ¬¡æ£€æŸ¥åœ¨30ç§’å
        gameLoop(); // å¼€å§‹æ¸¸æˆå¾ªç¯

        // åœæ­¢å¤§å…éŸ³ä¹ï¼Œæ’­æ”¾æ¸¸æˆéŸ³ä¹
        // åœæ­¢å¤§å…éŸ³ä¹ï¼Œæ’­æ”¾æ¸¸æˆéŸ³ä¹
        const bgMusic = document.getElementById('backgroundMusic');
        if (bgMusic && !bgMusic.paused) {
            bgMusic.pause();
        }
        const gameMusic = document.getElementById('gameMusic');
        if (gameMusic) {
            gameMusic.play();
        }
    }


    // åŒäººå¯¹æˆ˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('multiPlayerBtn').addEventListener('click', function() {
        // æ˜¾ç¤ºéš¾åº¦é€‰æ‹©æ¨¡æ€æ¡†
        document.getElementById('difficultyModal').style.display = 'block';
        // è®¾ç½®ä¸ºåŒäººæ¨¡å¼æ ‡è®°
        window.gameMode = 'multi';
    });


    // æ˜¾ç¤ºé€€å‡ºç¡®è®¤æ¨¡æ€æ¡†
    function showExitConfirm() {
        document.getElementById('exitConfirmModal').style.display = 'block';
    }

    // â€œæ®‹å¿ç¦»å¼€â€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('confirmExitBtn').addEventListener('click', function() {
        window.close();
    });

    // â€œå¼€å¿ƒç•™ä¸‹â€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('cancelExitBtn').addEventListener('click', function() {
        document.getElementById('exitConfirmModal').style.display = 'none';
    });
    let lastPurpleEnemySpawnTime = Date.now();
let lastRedEnemySpawnTime = Date.now();

// éŸ³ä¹æ§åˆ¶é€»è¾‘
const musicToggleButton = document.getElementById('musicToggleButton');
const backgroundMusic = document.getElementById('backgroundMusic');
let isMusicPlaying = false;

musicToggleButton.addEventListener('click', () => {
    if (isMusicPlaying) {
        backgroundMusic.pause();
        musicToggleButton.textContent = 'â–¶ï¸';
    } else {
        backgroundMusic.play().catch(e => console.log("èƒŒæ™¯éŸ³ä¹æ’­æ”¾å¤±è´¥: ", e));
        musicToggleButton.textContent = 'â¸ï¸';
    }
    isMusicPlaying = !isMusicPlaying;
});

// åˆå§‹çŠ¶æ€ï¼Œå¦‚æœéŸ³ä¹æ˜¯è‡ªåŠ¨æ’­æ”¾çš„ï¼Œåˆ™æ›´æ–°æŒ‰é’®çŠ¶æ€
backgroundMusic.addEventListener('play', () => {
    musicToggleButton.textContent = 'â¸ï¸';
    isMusicPlaying = true;
});

backgroundMusic.addEventListener('pause', () => {
    musicToggleButton.textContent = 'â–¶ï¸';
    isMusicPlaying = false;
});

// å°è¯•åœ¨é¡µé¢åŠ è½½æ—¶æ’­æ”¾éŸ³ä¹ï¼Œå¦‚æœå¤±è´¥åˆ™ç­‰å¾…ç”¨æˆ·äº¤äº’
backgroundMusic.play().then(() => {
    musicToggleButton.textContent = 'â¸ï¸';
    isMusicPlaying = true;
}).catch(e => {
    console.log("èƒŒæ™¯éŸ³ä¹è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œç­‰å¾…ç”¨æˆ·äº¤äº’: ", e);
    musicToggleButton.textContent = 'â–¶ï¸';
    isMusicPlaying = false;
});

// ç©å®¶å¯¹è±¡
// Player object should be defined here, before any functions

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const PLAYER_SPEED = 5;
const PLAYER_ATTACK_SPEED_REDUCTION = 0.3; // æ”»å‡»æ—¶é€Ÿåº¦é™ä½30%
const ATTACK_RANGE = 100; // æ™®é€šæ”»å‡»èŒƒå›´
const ATTACK_DAMAGE = 20; // å¢åŠ æ”»å‡»åŠ›
const ATTACK_DURATION = 5000; // æ”»å‡»æŒç»­5ç§’
const ATTACK_COOLDOWN = 2000; // æ”»å‡»å†·å´2ç§’
const PLAYER_MAX_HEALTH = 100;
const PLAYER_ATTACK_COOLDOWN = 200; // é»˜è®¤æ”»å‡»å†·å´æ—¶é—´ (æ¯«ç§’)
const GRENADE_COOLDOWN = 2000; // é»˜è®¤æ‰‹é›·å†·å´æ—¶é—´ (æ¯«ç§’)
const MINE_COOLDOWN = 2000; // é»˜è®¤åœ°é›·å†·å´æ—¶é—´ (æ¯«ç§’)
const ROTATE_SHOOT_COOLDOWN = 40000; // é»˜è®¤æ—‹è½¬å°„å‡»å†·å´æ—¶é—´ (æ¯«ç§’)

// æ¸¸æˆçŠ¶æ€
// gameRunningå˜é‡å·²åœ¨å…¶ä»–åœ°æ–¹å£°æ˜
let lastEnemyAttackTime = null;
let gameStartTime = 0; // æ¸¸æˆå¼€å§‹æ—¶é—´
let lastBossSpawnCheckTime = 0; // ä¸Šæ¬¡æ£€æŸ¥Bossç”Ÿæˆçš„æ—¶é—´
let currentGameMode = 'single'; // å½“å‰æ¸¸æˆæ¨¡å¼ï¼š'single' æˆ– 'multi'
let player = {};
let player2 = null; // Player 2 object, initially null
let boss = null; // Boss å¯¹è±¡ï¼Œåˆå§‹ä¸º null

player = {
        x: canvas.width / 2,
        y: canvas.height / 2,
        width: 30, // å›ºå®šè§’è‰²å¤§å°
        height: 30,
        color: '#87CEEB',
        health: PLAYER_MAX_HEALTH,
        speed: PLAYER_SPEED,
        isAttacking: false,
        attackStartTime: 0,
        attackEndTime: 0,
        canMove: true,
        canAttack: true,
        moveUp: false,
        moveDown: false,
        moveLeft: false,
        moveRight: false,
        cnt: 0,
        rotationAngle: 0, // åˆå§‹åŒ–æ—‹è½¬è§’åº¦
        // åœ°é›·æŠ€èƒ½ç›¸å…³å±æ€§
        canPlaceMine: true,
        canMove: true,
        lastMinePlaced: 0,
    // æ—‹è½¬å°„å‡»æŠ€èƒ½ç›¸å…³å±æ€§
    isRotateShooting: false,
    rotateShootStartTime: 0,
    rotateShootEndTime: 0,
    lastBulletTime: 0,
    rotationAngle: 0,
    // æ‰‹é›·æŠ€èƒ½ç›¸å…³å±æ€§
    canThrowGrenade: true,
    lastGrenadeThrowTime: 0,
    canAreaAttack: true, // æ˜¯å¦å¯ä»¥è¿›è¡ŒèŒƒå›´æ”»å‡»
    lastAreaAttackTime: 0, // ä¸Šæ¬¡èŒƒå›´æ”»å‡»æ—¶é—´
    // æ—‹è½¬å°„å‡»æŠ€èƒ½ç›¸å…³å±æ€§
    canUseRotateShoot: true,
    rotateShootCharges: 0,
    lastRotateShootChargeTime: 0,
    isChargingRotateShoot: false,
    rotateShootActive: false,
    rotateShootStartTime: 0,
    rotateShootX: 0,
    rotateShootY: 0
};

//åˆ¤æ–­å®¢æˆ·æ˜¯ä¸æ˜¯ç”µè„‘ç«¯
const isPC = /Windows|Macintosh|Linux/.test(navigator.userAgent);

// åˆå§‹åŒ–ç§»åŠ¨ç«¯æ§åˆ¶
if (!isPC) {
    document.getElementById('mobileControls').style.display = 'flex';
    
    // ç¬¬ä¸€ä¸ªæŠ€èƒ½æŒ‰é’®
    document.getElementById('skill1Btn').addEventListener('touchstart', function() {
        // ç¬¬ä¸€ä¸ªæŠ€èƒ½é€»è¾‘
        activateBoomerangThrow();
    });
    
    // ç¬¬äºŒä¸ªæŠ€èƒ½æŒ‰é’®
    document.getElementById('skill2Btn').addEventListener('touchstart', function() {
        // ç¬¬äºŒä¸ªæŠ€èƒ½é€»è¾‘
        activateRotateShoot();
    });
}

// æ•Œäººæ•°ç»„
let enemies = [];

// åœ°é›·æ•°ç»„
let mines = [];

// å­å¼¹æ•°ç»„
let bullets = [];

// ç´«è‰²æ•Œäººå­å¼¹æ•°ç»„
let purpleEnemyBullets = [];

// çº¢è‰²æ•Œäººå­å¼¹æ•°ç»„
let redEnemyBullets = [];

// æ‰‹é›·æ•°ç»„
let grenades = [];

// çˆ†ç‚¸æ•ˆæœæ•°ç»„
let explosions = [];

// å†³èµ›åœˆç›¸å…³å˜é‡
let finalCircleActive = false; // å†³èµ›åœˆæ˜¯å¦æ¿€æ´»
let finalCircleRadius = 0; // å½“å‰å†³èµ›åœˆåŠå¾„
let finalCircleCenterX = 0; // å†³èµ›åœˆä¸­å¿ƒXåæ ‡
let finalCircleCenterY = 0; // å†³èµ›åœˆä¸­å¿ƒYåæ ‡
let finalCircleStartTime = 0; // å†³èµ›åœˆå¼€å§‹æ—¶é—´
let gameWinner = null; // æ¸¸æˆè·èƒœè€…
let finalBattleStarted = false; // æ˜¯å¦å·²å¼€å§‹å†³æˆ˜
let lastCircleDamageTime = 0; // ä¸Šæ¬¡å†³èµ›åœˆä¼¤å®³æ—¶é—´

// åœ°å½¢ç›¸å…³å˜é‡
let currentTerrains = []; // å½“å‰é€‰æ‹©çš„åœ°å½¢
let terrainAreas = []; // åœ°å½¢åŒºåŸŸæ•°ç»„
let playerBubbles = { player1: 3, player2: 3 }; // ç©å®¶æ°”æ³¡æ•°é‡
let lastBubbleLossTime = { player1: 0, player2: 0 }; // ä¸Šæ¬¡å¤±å»æ°”æ³¡æ—¶é—´
let playerInGrass = { player1: false, player2: false }; // ç©å®¶æ˜¯å¦åœ¨è‰ä¸›ä¸­
let grassCooldown = { player1: 0, player2: 0 }; // è‰ä¸›å†·å´æ—¶é—´
let enemyQuestionMarks = []; // æ•Œäººé—®å·çŠ¶æ€

// ç”Ÿæˆæ•Œäºº
canvas.width = window.innerWidth * 0.8;
canvas.height = window.innerHeight * 0.8;

// ç§»é™¤è‡ªåŠ¨å¼€å§‹æ¸¸æˆ

function generateEnemy(type, targetPlayer = player) { // targetPlayer é»˜è®¤ä¸º player1
    let health, speed, color;
    switch (type) {
        case 'purple':
            health = PURPLE_ENEMY_HEALTH;
            speed = PURPLE_ENEMY_SPEED;
            color = '#9b59b6'; // ç´«è‰²
            break;
        case 'red':
            health = RED_ENEMY_HEALTH;
            speed = RED_ENEMY_SPEED;
            color = '#e74c3c'; // çº¢è‰²
            break;
        default:
            health = ENEMY_MAX_HEALTH;
            speed = ENEMY_SPEED;
            color = '#e74c3c'; // é»˜è®¤çº¢è‰²
    }

    let x, y;
    let attempts = 0;
    const maxAttempts = 100;

    do {
        x = Math.random() * (canvas.width - 30);
        y = Math.random() * (canvas.height - 30);
        attempts++;

        // å¦‚æœå°è¯•æ¬¡æ•°è¿‡å¤šï¼Œåˆ™æ”¾å®½æ¡ä»¶
        if (attempts >= maxAttempts) break;

    } while (Math.sqrt(Math.pow(x - player.x, 2) + Math.pow(y - player.y, 2)) < ATTACK_RANGE);

    const enemy = {
        x: x,
        y: y,
        width: canvas.width / 20,
        height: canvas.height / 20,
        color: color,
        health: health,
        maxHealth: health,
        speed: speed,
        isDead: false,
        isStunned: false,
        stunStartTime: 0,
        tickDamageStartTime: 0,
        targetPlayer: targetPlayer, // æ·»åŠ ç›®æ ‡ç©å®¶å±æ€§
        type: type, // æ·»åŠ æ•Œäººç±»å‹
        lastShootTime: 0, // æ·»åŠ ä¸Šæ¬¡å°„å‡»æ—¶é—´ï¼ˆç´«è‰²æ•Œäººéœ€è¦ï¼‰
        canShoot: true // åˆå§‹åŒ–å°„å‡»èƒ½åŠ›
    };
    enemies.push(enemy);
}



const ENEMY_MAX_HEALTH = 50;
const PURPLE_ENEMY_HEALTH = 80; // ç´«è‰²æ•Œäººè¡€é‡
const PURPLE_ENEMY_SPEED = 0.05; // ç´«è‰²æ•Œäººé€Ÿåº¦
const PURPLE_ENEMY_BULLET_SPEED = 3; // ç´«è‰²æ•Œäººå­å¼¹é€Ÿåº¦
const PURPLE_ENEMY_BULLET_DAMAGE = 5; // ç´«è‰²æ•Œäººå­å¼¹ä¼¤å®³
const PURPLE_ENEMY_SHOOT_INTERVAL = 3000; // ç´«è‰²æ•Œäººå°„å‡»é—´éš”ï¼ˆ3ç§’ï¼‰
const RED_ENEMY_SHOOT_INTERVAL = 2000; // çº¢è‰²æ•Œäººå°„å‡»é—´éš”ï¼ˆ2ç§’ï¼‰
const RED_ENEMY_HEALTH = 40; // çº¢è‰²æ•Œäººè¡€é‡
const RED_ENEMY_SPEED = 0.2; // çº¢è‰²æ•Œäººé€Ÿåº¦
 const ENEMY_SPEED_RECOVERY_DURATION = 2000; // æ•Œäººé€Ÿåº¦æ¢å¤æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
const ENEMY_SPEED = 0.2; // é»˜è®¤æ•Œäººé€Ÿåº¦

// Boss å¸¸é‡
const BOSS_MAX_HEALTH = 600;
const BOSS_SPEED = 0.1; // Boss ç§»åŠ¨é€Ÿåº¦
const BOSS_SKILL_COOLDOWN = 5000; // Boss æŠ€èƒ½å†·å´æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
const BOSS_BULLET_SPEED = 5; // Boss å­å¼¹é€Ÿåº¦
const BOSS_BULLET_COUNT = 8; // Boss æ¯æ¬¡æŠ€èƒ½å‘å°„çš„å­å¼¹æ–¹å‘æ•°
const BOSS_BULLET_WAVES = 1; // Boss æŠ€èƒ½è¿ç»­å‘å°„çš„å­å¼¹æ³¢æ¬¡ï¼ˆæ¯è½®åªå‘å°„ä¸€æ³¢ï¼‰
const BOSS_SPAWN_TIME = 30000; // Boss é¦–æ¬¡å‡ºç°æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
const BOSS_SPAWN_CHANCE = 0.3; // Boss æ¯æ¬¡å‡ºç°æ¦‚ç‡

// çˆ†ç‚¸æ•ˆæœå¸¸é‡
const EXPLOSION_DURATION = 30; // çˆ†ç‚¸åŠ¨ç”»æŒç»­å¸§æ•°ï¼ˆå¢åŠ æŒç»­æ—¶é—´ï¼‰
const EXPLOSION_MAX_RADIUS = 35; // çˆ†ç‚¸æœ€å¤§åŠå¾„ï¼ˆå¢å¤§çˆ†ç‚¸èŒƒå›´ï¼‰
const EXPLOSION_PARTICLES = 8; // çˆ†ç‚¸ç²’å­æ•°é‡

// æ•Œäººç”Ÿæˆå¸¸é‡
const PURPLE_ENEMY_SPAWN_INTERVAL = 30000; // 30ç§’
const PURPLE_ENEMY_SPAWN_CHANCE = 0.5; // 50%æ¦‚ç‡
const RED_ENEMY_SPAWN_INTERVAL = 10000; // 10ç§’
const RED_ENEMY_SPAWN_CHANCE = 0.7; // 70%æ¦‚ç‡

// åœ°é›·æŠ€èƒ½å¸¸é‡
const MINE_EXPLOSION_RANGE = 100;
const MINE_DAMAGE = 60; // å¢å¼ºåœ°é›·ä¼¤å®³
// åœ°é›·æŠ€èƒ½å†·å´æ—¶é—´å¸¸é‡å·²åœ¨å‰é¢å®šä¹‰,è¿™é‡Œåˆ é™¤é‡å¤å£°æ˜
const MINE_COUNTDOWN = 3000; // 3ç§’å€’è®¡æ—¶

// æ—‹è½¬å°„å‡»æŠ€èƒ½å¸¸é‡ // 10ç§’æŒç»­æ—¶é—´
// æ—‹è½¬å°„å‡»å†·å´æ—¶é—´å·²åœ¨å‰é¢å®šä¹‰,è¿™é‡Œåˆ é™¤é‡å¤å£°æ˜
const ROTATE_SHOOT_INTERVAL = 40; // 0.2ç§’å‘å°„ä¸€æ¬¡
const ROTATE_SHOOT_DAMAGE = 25; // å­å¼¹ä¼¤å®³
const ROTATE_SHOOT_SPEED = 10; // å­å¼¹é€Ÿåº¦
const ROTATE_SHOOT_DURATION = 5000; // 10ç§’æŒç»­æ—¶é—´
const ROTATE_SHOOT_RADIUS = 5; // å­å¼¹åŠå¾„ï¼Œä½¿å…¶å˜å°

// æ•ŒäººçŠ¶æ€å¸¸é‡
const ENEMY_STUN_DURATION = 400; // æ•Œäººåœæ­¢ç§»åŠ¨0.1ç§’
const ENEMY_TICK_DAMAGE_INTERVAL = 50; // æ¯0.05ç§’æ‰£è¡€
const ENEMY_TICK_DAMAGE_AMOUNT = 3; // æ¯æ¬¡æ‰£è¡€3ç‚¹

// æ‰‹é›·æŠ€èƒ½å¸¸é‡
const GRENADE_DAMAGE = 70; // æ‰‹é›·ä¼¤å®³
const GRENADE_EXPLOSION_RADIUS = 70; // æ‰‹é›·çˆ†ç‚¸èŒƒå›´

// å¼•åŠ›ç‚¸å¼¹æŠ€èƒ½å¸¸é‡
const GRAVITY_BOMB_COOLDOWN = 15000; // å¼•åŠ›ç‚¸å¼¹å†·å´æ—¶é—´ (15ç§’)
const GRAVITY_BOMB_DURATION = 3000; // å¼•åŠ›ç‚¸å¼¹æŒç»­æ—¶é—´ (3ç§’)
const GRAVITY_BOMB_ATTRACT_RADIUS = 125; // å¸å¼•èŒƒå›´
const GRAVITY_BOMB_EXPLOSION_RADIUS = 150; // çˆ†ç‚¸èŒƒå›´
const GRAVITY_BOMB_DAMAGE = 100; // çˆ†ç‚¸ä¼¤å®³
const GRAVITY_BOMB_SLOW_PERCENTAGE = 0.9; // å‡é€Ÿ90%
const GRAVITY_BOMB_BLEED_PERCENTAGE = 0.7; // æŒç»­æ‰£è¡€70%
const GRAVITY_BOMB_MAX_CHARGES = 10; // æœ€å¤§å……èƒ½æ¬¡æ•°
const GRAVITY_BOMB_CHARGE_INTERVAL = 100; // æ¯æ¬¡ç‚¹å‡»ç©ºæ ¼çš„é—´éš”ï¼Œç”¨äºå……èƒ½

// æŠ€èƒ½ç¦ç”¨çŠ¶æ€
const SKILL_DISABLED_STATUS = 'ç¦ç”¨ä¸­';
// ç¬é—´èŒƒå›´æ”»å‡»å¸¸é‡ (Player 1)
const AREA_ATTACK_RADIUS = 100; // èŒƒå›´æ”»å‡»åŠå¾„
const AREA_ATTACK_DAMAGE = 15; // èŒƒå›´æ”»å‡»ä¼¤å®³
const AREA_ATTACK_COOLDOWN = 1000; // èŒƒå›´æ”»å‡»å†·å´æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

// æ‰‹é›·å†·å´æ—¶é—´å·²åœ¨å‰é¢å®šä¹‰,è¿™é‡Œåˆ é™¤é‡å¤å£°æ˜
const GRENADE_MIN_FLIGHT_TIME = 400; // æ‰‹é›·æœ€å°é£è¡Œæ—¶é—´0.1ç§’
const GRENADE_MAX_FLIGHT_TIME = 700; // æ‰‹é›·æœ€å¤§é£è¡Œæ—¶é—´1ç§’

// å†³èµ›åœˆç›¸å…³å¸¸é‡
const FINAL_CIRCLE_SHRINK_SPEED = 0.5; // å†³èµ›åœˆç¼©å°é€Ÿåº¦ï¼ˆæ¯å¸§ç¼©å°0.5åƒç´ ï¼‰
const FINAL_CIRCLE_DAMAGE = 5; // å†³èµ›åœˆä¼¤å®³
const FINAL_CIRCLE_DAMAGE_INTERVAL = 1000; // å†³èµ›åœˆä¼¤å®³é—´éš”ï¼ˆæ¯«ç§’ï¼‰
const PVP_DAMAGE = 10; // ç©å®¶äº’ç›¸æ”»å‡»ä¼¤å®³
const FINAL_CIRCLE_MIN_RADIUS = 80; // å†³èµ›åœˆæœ€å°åŠå¾„ï¼ˆç¨å¾®å°ä¸€ç‚¹å¢åŠ ç´§å¼ æ„Ÿï¼‰

// åœ°å½¢ç›¸å…³å¸¸é‡
const SHALLOW_WATER_SPEED_REDUCTION = 0.3; // æµ…æ°´é€Ÿåº¦å‡å°‘70%
const DEEP_WATER_SPEED_REDUCTION = 0.4; // æ·±æ°´é€Ÿåº¦å‡å°‘60%
const DEEP_WATER_BUBBLE_INTERVAL = 5000; // æ·±æ°´æ°”æ³¡æ¶ˆå¤±é—´éš”ï¼ˆ5ç§’ï¼‰
const DEEP_WATER_DAMAGE = 2; // æ·±æ°´ä¼¤å®³
const LAVA_DAMAGE = 5; // å²©æµ†ä¼¤å®³
const GRASS_COOLDOWN_TIME = 20000; // è‰ä¸›å†·å´æ—¶é—´ï¼ˆ20ç§’ï¼‰
const TERRAIN_AREA_SIZE = 150; // åœ°å½¢åŒºåŸŸå¤§å°
// è·å–ç”»å¸ƒå’Œä¸Šä¸‹æ–‡



function init(difficulty, mode, terrains = []) {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    // const ROTATE_SHOOT_RADIUS = canvas.width / 100; // å­å¼¹åŠå¾„
    // æ ¹æ®éš¾åº¦è°ƒæ•´æ¸¸æˆå‚æ•°
    let currentPurpleEnemyHealth = PURPLE_ENEMY_HEALTH;
    let currentRedEnemyHealth = RED_ENEMY_HEALTH;
    let currentPurpleEnemySpeed = PURPLE_ENEMY_SPEED;
    let currentRedEnemySpeed = RED_ENEMY_SPEED;
    let currentPurpleEnemySpawnInterval = PURPLE_ENEMY_SPAWN_INTERVAL;
    let currentRedEnemySpawnInterval = RED_ENEMY_SPAWN_INTERVAL;
    let currentPlayerMaxHealth = PLAYER_MAX_HEALTH;
    let currentPlayerAttackCooldown = PLAYER_ATTACK_COOLDOWN;
    let currentGrenadeCooldown = GRENADE_COOLDOWN;
    let currentMineCooldown = MINE_COOLDOWN;
    let currentRotateShootCooldown = ROTATE_SHOOT_COOLDOWN;
    let initialRedEnemies = 5; // é»˜è®¤åˆå§‹çº¢è‰²æ•Œäººæ•°é‡
    let initialPurpleEnemies = 5; // é»˜è®¤åˆå§‹ç´«è‰²æ•Œäººæ•°é‡

    if (mode === 'multi') {
        initialRedEnemies = 10; // åŒäººæ¨¡å¼ä¸‹10ä¸ªçº¢è‰²æ•Œäºº
        initialPurpleEnemies = 5; // åŒäººæ¨¡å¼ä¸‹5ä¸ªç´«è‰²æ•Œäºº
        player2 = {
            x: canvas.width / 2 + 100, // ç©å®¶2åˆå§‹ä½ç½®
            y: canvas.height / 2,
            width: 30,
            height: 30,
            color: '#FFD700', // ç©å®¶2é¢œè‰²
            health: currentPlayerMaxHealth,
            speed: PLAYER_SPEED,
            isAttacking: false,
            attackStartTime: 0,
            attackEndTime: 0,
            canMove: true,
            canAttack: true,
            moveUp: false,
            moveDown: false,
            moveLeft: false,
            moveRight: false,
            cnt: 0,
            rotationAngle: 0,
            canPlaceMine: true,
            lastMinePlaced: 0,
            isRotateShooting: false,
            rotateShootStartTime: 0,
            rotateShootEndTime: 0,
            lastBulletTime: 0,
            canThrowGrenade: true,
            lastGrenadeThrowTime: 0,
            canUseRotateShoot: true,
            rotateShootCharges: 0,
            lastRotateShootChargeTime: 0,
            isChargingRotateShoot: false,
            attackCooldown: currentPlayerAttackCooldown, // æ·»åŠ æ”»å‡»å†·å´æ—¶é—´
            canAreaAttack: true, // æ·»åŠ èŒƒå›´æ”»å‡»èƒ½åŠ›
            lastAreaAttackTime: 0, // æ·»åŠ ä¸Šæ¬¡èŒƒå›´æ”»å‡»æ—¶é—´
            trail: [] // ç©å®¶2ç§»åŠ¨è½¨è¿¹
        };
    }

    switch (difficulty) {
        case 'easy':
            currentPurpleEnemyHealth = 60;
            currentRedEnemyHealth = 30;
            currentPurpleEnemySpeed = 0.03;
            currentRedEnemySpeed = 0.2;
            currentPurpleEnemySpawnInterval = 40000;
            currentRedEnemySpawnInterval = 15000;
            currentPlayerMaxHealth = 120;
            currentPlayerAttackCooldown = 300; // ç®€å•éš¾åº¦æ”»å‡»å†·å´æ—¶é—´
            currentGrenadeCooldown = 3000; // ç®€å•éš¾åº¦æ‰‹é›·å†·å´æ—¶é—´
            currentMineCooldown = 3000; // ç®€å•éš¾åº¦åœ°é›·å†·å´æ—¶é—´
            currentRotateShootCooldown = 5000; // ç®€å•éš¾åº¦æ—‹è½¬å°„å‡»å†·å´æ—¶é—´
            initialRedEnemies = 3; // ç®€å•éš¾åº¦åˆå§‹çº¢è‰²æ•Œäººæ•°é‡
            initialPurpleEnemies = 2; // ç®€å•éš¾åº¦åˆå§‹ç´«è‰²æ•Œäººæ•°é‡
            break;
        case 'normal':
            // é»˜è®¤å€¼ï¼Œæ— éœ€ä¿®æ”¹
            break;
        case 'hard':
            currentPurpleEnemyHealth = 100;
            currentRedEnemyHealth = 60;
            currentPurpleEnemySpeed = 0.07;
            currentRedEnemySpeed = 0.6;
            currentPurpleEnemySpawnInterval = 20000;
            currentRedEnemySpawnInterval = 8000;
            currentPlayerMaxHealth = 80;
            currentPlayerAttackCooldown = 100; // å›°éš¾éš¾åº¦æ”»å‡»å†·å´æ—¶é—´
            currentGrenadeCooldown = 1000; // å›°éš¾éš¾åº¦æ‰‹é›·å†·å´æ—¶é—´
            currentMineCooldown = 1000; // å›°éš¾éš¾åº¦åœ°é›·å†·å´æ—¶é—´
            currentRotateShootCooldown = 2000; // å›°éš¾éš¾åº¦æ—‹è½¬å°„å‡»å†·å´æ—¶é—´
            initialRedEnemies = 7; // å›°éš¾éš¾åº¦åˆå§‹çº¢è‰²æ•Œäººæ•°é‡
            initialPurpleEnemies = 3; // å›°éš¾éš¾åº¦åˆå§‹ç´«è‰²æ•Œäººæ•°é‡
            break;
        case 'hell':
            currentPurpleEnemyHealth = 120;
            currentRedEnemyHealth = 80;
            currentPurpleEnemySpeed = 0.09;
            currentRedEnemySpeed = 0.8;
            currentPurpleEnemySpawnInterval = 15000;
            currentRedEnemySpawnInterval = 5000;
            currentPlayerMaxHealth = 60;
            currentPlayerAttackCooldown = 50; // åœ°ç‹±éš¾åº¦æ”»å‡»å†·å´æ—¶é—´
            currentGrenadeCooldown = 500; // åœ°ç‹±éš¾åº¦æ‰‹é›·å†·å´æ—¶é—´
            currentMineCooldown = 500; // åœ°ç‹±éš¾åº¦åœ°é›·å†·å´æ—¶é—´
            currentRotateShootCooldown = 1000; // åœ°ç‹±éš¾åº¦æ—‹è½¬å°„å‡»å†·å´æ—¶é—´
            initialRedEnemies = 10; // åœ°ç‹±éš¾åº¦åˆå§‹çº¢è‰²æ•Œäººæ•°é‡
            initialPurpleEnemies = 5; // åœ°ç‹±éš¾åº¦åˆå§‹ç´«è‰²æ•Œäººæ•°é‡
            break;
    }

    // æ›´æ–°ç©å®¶åˆå§‹è¡€é‡
    player.health = currentPlayerMaxHealth;
    player.maxHealth = currentPlayerMaxHealth;
    
    // æ›´æ–°ç©å®¶äºŒçš„è¡€é‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (player2) {
        player2.health = currentPlayerMaxHealth;
        player2.maxHealth = currentPlayerMaxHealth;
    }

// åˆå§‹åŒ–æ¸¸æˆ
// There should be only ONE init function

    // æ›´æ–°æ•Œäººç”Ÿæˆé€»è¾‘ä»¥ä½¿ç”¨è°ƒæ•´åçš„å‚æ•°
    // å‡è®¾ generateEnemy å‡½æ•°ä¼šä½¿ç”¨è¿™äº›å…¨å±€æˆ–å¯è®¿é—®çš„å¸¸é‡
    // å¦‚æœ generateEnemy å†…éƒ¨æœ‰ç¡¬ç¼–ç çš„å¸¸é‡ï¼Œéœ€è¦ä¿®æ”¹ generateEnemy å‡½æ•°

    // ç¤ºä¾‹ï¼šè°ƒæ•´æ•Œäººç”Ÿæˆ
    // è¿™é‡Œçš„é€»è¾‘éœ€è¦æ ¹æ®å®é™…çš„æ•Œäººç”Ÿæˆæ–¹å¼è¿›è¡Œè°ƒæ•´
    // å¦‚æœæ•Œäººæ˜¯å¾ªç¯ç”Ÿæˆçš„ï¼Œéœ€è¦ä¿®æ”¹ç”Ÿæˆé—´éš”çš„å˜é‡
    // å¦‚æœæ˜¯åˆå§‹ç”Ÿæˆï¼Œåˆ™åœ¨ä¸‹é¢ç”Ÿæˆæ—¶ä½¿ç”¨è°ƒæ•´åçš„è¡€é‡å’Œé€Ÿåº¦

    // ç©å®¶å¯¹è±¡åˆå§‹åŒ– (ç¡®ä¿åœ¨éš¾åº¦è°ƒæ•´å)
    player.x = canvas.width / 2 - 25;
    player.y = canvas.height / 2 - 25;
    player.width = 50;
    player.height = 50;
    player.color = 'blue';
    player.health = currentPlayerMaxHealth;
    player.speed = PLAYER_SPEED;
    player.canMove = true; // ç¡®ä¿ canMove å±æ€§è¢«åˆå§‹åŒ–
    player.isAttacking = false;
    player.attackEndTime = 0;
    player.canAttack = true;
    player.rotationAngle = 0; // åˆå§‹åŒ–æ—‹è½¬è§’åº¦
    player.attackCooldown = currentPlayerAttackCooldown; // ç©å®¶æ”»å‡»å†·å´æ—¶é—´
    player.lastGrenadeThrowTime = 0;
    player.canThrowGrenade = true;
    player.grenadeCooldown = currentGrenadeCooldown; // æ‰‹é›·å†·å´æ—¶é—´
    player.lastMinePlacementTime = 0;
    player.canPlaceMine = true;
    player.mineCooldown = currentMineCooldown; // åœ°é›·å†·å´æ—¶é—´
    player.lastRotateShootTime = 0;
    player.canUseRotateShoot = true;
    player.rotateShootCooldown = currentRotateShootCooldown; // æ—‹è½¬å°„å‡»å†·å´æ—¶é—´
    player.moveUp = false;
    player.moveDown = false;
    player.moveLeft = false;
    player.moveRight = false;
    player.trail = []; // ç©å®¶ç§»åŠ¨è½¨è¿¹

    // æ¸…ç©ºæ•Œäººå’Œå­å¼¹
    enemies = [];
    bullets = [];
    purpleEnemyBullets = [];
    redEnemyBullets = [];
    grenades = [];
    mines = [];
    explosions = [];
    
    // åˆå§‹åŒ–åœ°å½¢åŒºåŸŸ
    terrainAreas = [];
    if (terrains.length > 0) {
        generateTerrainAreas(terrains);
    }
    
    // é‡ç½®åœ°å½¢ç›¸å…³çŠ¶æ€
    playerBubbles = { player1: 3, player2: 3 };
    lastBubbleLossTime = { player1: 0, player2: 0 };
    playerInGrass = { player1: false, player2: false };
    grassCooldown = { player1: 0, player2: 0 };
    enemyQuestionMarks = [];

    // åˆå§‹ç”Ÿæˆæ•Œäºº (ä½¿ç”¨è°ƒæ•´åçš„å‚æ•°)
    if (mode === 'multi') {
        // åŒäººæ¨¡å¼ä¸‹ï¼Œä»»æ„å¤šä¸ªçº¢æŒ‚å’Œç“·æ€ªå†²å‘ç©å®¶ä¸€ï¼Œå…¶ä»–å†²å‘ç©å®¶äºŒ
        // å‡è®¾ä¸€åŠå†²å‘ç©å®¶ä¸€ï¼Œä¸€åŠå†²å‘ç©å®¶äºŒ
        const redToPlayer1 = Math.ceil(initialRedEnemies / 2);
        const purpleToPlayer1 = Math.ceil(initialPurpleEnemies / 2);

        for (let i = 0; i < redToPlayer1; i++) {
            generateEnemy('red', player);
        }
        for (let i = 0; i < initialRedEnemies - redToPlayer1; i++) {
            generateEnemy('red', player2);
        }

        for (let i = 0; i < purpleToPlayer1; i++) {
            generateEnemy('purple', player);
        }
        for (let i = 0; i < initialPurpleEnemies - purpleToPlayer1; i++) {
            generateEnemy('purple', player2);
        }
    } else {
        for (let i = 0; i < initialRedEnemies; i++) {
            generateEnemy('red');
        }
        for (let i = 0; i < initialPurpleEnemies; i++) {
            generateEnemy('purple');
        }
    }

    // ... ä¿æŒå…¶ä»–ä¸å˜çš„åˆå§‹åŒ–é€»è¾‘ ...

    // æ ¹æ®è®¾å¤‡ç±»å‹åˆå§‹åŒ–æ§åˆ¶æ–¹å¼
    if (isPC) {
        // ç”µè„‘ç«¯ä½¿ç”¨é”®ç›˜æ§åˆ¶ - ç§»é™¤é‡å¤çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œä½¿ç”¨å…¨å±€çš„handleKeyDown
    }
    // è®¾ç½®é”®ç›˜äº‹ä»¶ç›‘å¬
    window.addEventListener('keydown', handleKeyDown);
    window.addEventListener('keyup', handleKeyUp);
    
    // è®¾ç½®é¼ æ ‡ç‚¹å‡»ç›‘å¬
    canvas.addEventListener('click', handleMouseClick);
    
    // åŠ è½½READMEå†…å®¹
}

// ç”Ÿæˆåœ°å½¢åŒºåŸŸå‡½æ•°
function generateTerrainAreas(terrains) {
    terrains.forEach(terrainType => {
        let area;
        do {
            area = {
                type: terrainType,
                x: Math.random() * (canvas.width - TERRAIN_AREA_SIZE),
                y: Math.random() * (canvas.height - TERRAIN_AREA_SIZE),
                width: TERRAIN_AREA_SIZE,
                height: TERRAIN_AREA_SIZE
            };
        } while (isOverlapping(area));
        
        terrainAreas.push(area);
    });
}

// æ£€æŸ¥åœ°å½¢åŒºåŸŸæ˜¯å¦é‡å 
function isOverlapping(newArea) {
    return terrainAreas.some(area => {
        return newArea.x < area.x + area.width &&
               newArea.x + newArea.width > area.x &&
               newArea.y < area.y + area.height &&
               newArea.y + newArea.height > area.y;
    });
}

// æ£€æŸ¥ç©å®¶æ˜¯å¦åœ¨ç‰¹å®šåœ°å½¢ä¸­
function getPlayerTerrain(player) {
    for (let area of terrainAreas) {
        if (player.x < area.x + area.width &&
            player.x + player.width > area.x &&
            player.y < area.y + area.height &&
            player.y + player.height > area.y) {
            return area.type;
        }
    }
    return null;
}

// æ£€æŸ¥æ•Œäººæ˜¯å¦åœ¨ç‰¹å®šåœ°å½¢ä¸­
function getEnemyTerrain(enemy) {
    for (let area of terrainAreas) {
        if (enemy.x < area.x + area.width &&
            enemy.x + enemy.width > area.x &&
            enemy.y < area.y + area.height &&
            enemy.y + enemy.height > area.y) {
            return area.type;
        }
    }
    return null;
}

// å¤„ç†åœ°å½¢æ•ˆæœ
function handleTerrainEffects() {
    const currentTime = Date.now();
    
    // å¤„ç†ç©å®¶1åœ°å½¢æ•ˆæœ
    handlePlayerTerrainEffects(player, 'player1', currentTime);
    
    // å¤„ç†ç©å®¶2åœ°å½¢æ•ˆæœï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (player2) {
        handlePlayerTerrainEffects(player2, 'player2', currentTime);
    }
    
    // å¤„ç†æ•Œäººåœ°å½¢æ•ˆæœ
    enemies.forEach(enemy => {
        handleEnemyTerrainEffects(enemy, currentTime);
    });
}

// å¤„ç†ç©å®¶åœ°å½¢æ•ˆæœ
function handlePlayerTerrainEffects(player, playerId, currentTime) {
    const terrain = getPlayerTerrain(player);
    
    // é‡ç½®é€Ÿåº¦
    let speedMultiplier = 1;
    
    if (terrain) {
        switch (terrain) {
            case 'shallow':
                speedMultiplier = SHALLOW_WATER_SPEED_REDUCTION;
                break;
            case 'deep':
                speedMultiplier = DEEP_WATER_SPEED_REDUCTION;
                // å¤„ç†æ°”æ³¡é€»è¾‘
                if (currentTime - lastBubbleLossTime[playerId] >= DEEP_WATER_BUBBLE_INTERVAL) {
                    if (playerBubbles[playerId] > 0) {
                        playerBubbles[playerId]--;
                        lastBubbleLossTime[playerId] = currentTime;
                    }
                }
                // å¦‚æœæ²¡æœ‰æ°”æ³¡äº†ï¼ŒæŒç»­æ‰£è¡€
                if (playerBubbles[playerId] === 0) {
                    if (currentTime - lastBubbleLossTime[playerId] >= 1000) {
                        player.health -= DEEP_WATER_DAMAGE;
                        lastBubbleLossTime[playerId] = currentTime;
                    }
                }
                break;
            case 'lava':
                // å²©æµ†ï¼šç§»åŠ¨é€Ÿåº¦å¤§å¹…å‡å°‘ï¼ŒæŒç»­æ‰£è¡€
                speedMultiplier = 0.2; // å‡å°‘80%ç§»åŠ¨é€Ÿåº¦
                if (currentTime - (player.lastLavaDamage || 0) >= 1000) {
                    player.health -= LAVA_DAMAGE;
                    player.lastLavaDamage = currentTime;
                }
                break;
            case 'grass':
                // è‰ä¸›ï¼šæ£€æŸ¥å†·å´æ—¶é—´
                if (currentTime - grassCooldown[playerId] >= GRASS_COOLDOWN_TIME) {
                    playerInGrass[playerId] = true;
                    // è®¾ç½®æ•Œäººé—®å·çŠ¶æ€
                    enemies.forEach(enemy => {
                        if (!enemy.questionMark && !enemy.isDead) {
                            enemy.questionMark = true;
                            enemy.canShoot = false;
                            enemy.isStunned = true; // ç¦ç”¨ç§»åŠ¨
                        }
                    });
                }
                break;
        }
    } else {
        // ç¦»å¼€åœ°å½¢æ—¶é‡ç½®çŠ¶æ€
        if (playerInGrass[playerId]) {
            playerInGrass[playerId] = false;
            grassCooldown[playerId] = currentTime;
            // è§¦å‘æ•Œäººæ„Ÿå¹å·
            triggerEnemyExclamation();
        }
        // ç¦»å¼€æ·±æ°´æ—¶é‡ç½®æ°”æ³¡
        if (playerBubbles[playerId] < 3) {
            playerBubbles[playerId] = 3;
        }
    }
    
    // åº”ç”¨é€Ÿåº¦ä¿®æ­£
    player.currentSpeedMultiplier = speedMultiplier;
}

// å¤„ç†æ•Œäººåœ°å½¢æ•ˆæœ
function handleEnemyTerrainEffects(enemy, currentTime) {
    const terrain = getEnemyTerrain(enemy);
    
    if (terrain) {
        switch (terrain) {
            case 'shallow':
                enemy.speedMultiplier = SHALLOW_WATER_SPEED_REDUCTION;
                break;
            case 'deep':
                enemy.speedMultiplier = DEEP_WATER_SPEED_REDUCTION;
                // æ•Œäººè¿›å…¥æ·±æ°´ç«‹å³æ‰£è¡€
                if (!enemy.inDeepWater) {
                    enemy.health -= DEEP_WATER_DAMAGE;
                    enemy.inDeepWater = true;
                }
                break;
            case 'lava':
                enemy.speedMultiplier = 0.2; // å‡å°‘80%ç§»åŠ¨é€Ÿåº¦
                if (currentTime - (enemy.lastLavaDamage || 0) >= 1000) {
                    enemy.health -= LAVA_DAMAGE;
                    enemy.lastLavaDamage = currentTime;
                }
                break;
            case 'grass':
                enemy.speedMultiplier = 1;
                break;
        }
    } else {
        enemy.speedMultiplier = 1;
        enemy.inDeepWater = false;
    }
}

// è§¦å‘æ•Œäººæ„Ÿå¹å·æ•ˆæœ
function triggerEnemyExclamation() {
    enemies.forEach(enemy => {
        if (enemy.questionMark && !enemy.isDead) {
            enemy.questionMark = false;
            enemy.exclamationMark = true;
            enemy.exclamationStartTime = Date.now();
            setTimeout(() => {
                if (!enemy.isDead) {
                    enemy.exclamationMark = false;
                    enemy.canShoot = true;
                    enemy.isStunned = false; // æ¢å¤ç§»åŠ¨
                }
            }, 1000);
        }
    });
}

// æ£€æŸ¥ç©å®¶æŠ€èƒ½ä½¿ç”¨æ—¶æ˜¯å¦åœ¨è‰ä¸›ä¸­
function checkGrassSkillTrigger(player, playerId) {
    if (playerInGrass[playerId]) {
        triggerEnemyExclamation();
        playerInGrass[playerId] = false;
        grassCooldown[playerId] = Date.now();
    }
}

// ç»˜åˆ¶åœ°å½¢åŒºåŸŸ
function drawTerrainAreas() {
    terrainAreas.forEach(area => {
        ctx.save();
        
        switch (area.type) {
            case 'shallow':
                // æµ…æ°´ - æµ…è“è‰²
                ctx.fillStyle = 'rgba(135, 206, 235, 0.6)';
                break;
            case 'deep':
                // æ·±æ°´ - æ·±è“è‰²
                ctx.fillStyle = 'rgba(0, 100, 200, 0.7)';
                break;
            case 'lava':
                // å²©æµ† - çº¢æ©™è‰²
                ctx.fillStyle = 'rgba(255, 69, 0, 0.8)';
                break;
            case 'grass':
                // è‰ä¸› - ç»¿è‰²
                ctx.fillStyle = 'rgba(34, 139, 34, 0.6)';
                break;
        }
        
        ctx.fillRect(area.x, area.y, area.width, area.height);
        
        // ç»˜åˆ¶è¾¹æ¡†
        ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
        ctx.lineWidth = 2;
        ctx.strokeRect(area.x, area.y, area.width, area.height);
        
        ctx.restore();
    });
}

// ç»˜åˆ¶ç©å®¶æ°”æ³¡ï¼ˆæ·±æ°´æ•ˆæœï¼‰
function drawPlayerBubbles(player, playerId) {
    const bubbleCount = playerBubbles[playerId] || 0;
    if (bubbleCount > 0) {
        for (let i = 0; i < bubbleCount; i++) {
            ctx.save();
            ctx.fillStyle = 'rgba(173, 216, 230, 0.8)';
            ctx.beginPath();
            const bubbleX = player.x + player.width / 2 + (i - 1) * 15;
            const bubbleY = player.y - 20 - i * 5;
            ctx.arc(bubbleX, bubbleY, 5, 0, 2 * Math.PI);
            ctx.fill();
            ctx.strokeStyle = 'rgba(0, 100, 200, 0.6)';
            ctx.lineWidth = 1;
            ctx.stroke();
            ctx.restore();
        }
    }
}

// ç»˜åˆ¶æ•ŒäººçŠ¶æ€å›¾æ ‡ï¼ˆé—®å·/æ„Ÿå¹å·ï¼‰
function drawEnemyStatusIcons() {
    enemies.forEach(enemy => {
        if (enemy.questionMark) {
            ctx.save();
            ctx.fillStyle = 'yellow';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('?', enemy.x + enemy.width / 2, enemy.y - 10);
            ctx.restore();
        } else if (enemy.exclamationMark) {
            ctx.save();
            ctx.fillStyle = 'red';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('!', enemy.x + enemy.width / 2, enemy.y - 10);
            ctx.restore();
        }
    });
}


// é¼ æ ‡ç‚¹å‡»äº‹ä»¶å¤„ç†
function handleMouseClick(e) {
    // è·å–ç”»å¸ƒçš„è¾¹ç•ŒçŸ©å½¢
    const rect = canvas.getBoundingClientRect();
    
    // è®¡ç®—é¼ æ ‡åœ¨ç”»å¸ƒä¸­çš„å®é™…åæ ‡
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    
    // åœ¨åŒäººæ¨¡å¼ä¸‹ï¼Œæ ¹æ®æŒ‰é”®çŠ¶æ€åˆ¤æ–­æ˜¯å“ªä¸ªç©å®¶è¿›è¡ŒèŒƒå›´æ”»å‡»
    if (player2) {
        // åŒäººæ¨¡å¼ï¼šæ£€æŸ¥æ˜¯å¦æŒ‰ä½äº†ç©å®¶2çš„æ§åˆ¶é”®
        if (e.shiftKey) {
            // æŒ‰ä½Shifté”®+é¼ æ ‡ç‚¹å‡» = ç©å®¶2ä»¥è‡ªèº«ä¸ºä¸­å¿ƒçš„èŒƒå›´æ”»å‡»
            activateAreaAttack(player2);
        } else {
            // æ™®é€šé¼ æ ‡ç‚¹å‡» = ç©å®¶1ä»¥è‡ªèº«ä¸ºä¸­å¿ƒçš„èŒƒå›´æ”»å‡»
            activateAreaAttack(player);
        }
    } else {
        // å•äººæ¨¡å¼ï¼šé¼ æ ‡ç‚¹å‡»æ§åˆ¶ç©å®¶1å®šç‚¹æ‰‹é›·æŠ›å°„ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰
        handlePlayerGrenade(player, mouseX, mouseY);
    }
}

// é”®ç›˜æŒ‰ä¸‹äº‹ä»¶å¤„ç†
function handleKeyDown(e) {
    console.log('Key pressed:', e.key); // æ·»åŠ æ—¥å¿—
    switch(e.key) {
        case 'ArrowUp':
            if (player2) {
                player2.moveUp = true;
            } else {
                // å•äººæ¨¡å¼ä¸‹ï¼Œæ–¹å‘é”®æ§åˆ¶ç©å®¶1
                player.moveUp = true;
            }
            break;
        case 'ArrowDown':
            if (player2) {
                player2.moveDown = true;
            } else {
                // å•äººæ¨¡å¼ä¸‹ï¼Œæ–¹å‘é”®æ§åˆ¶ç©å®¶1
                player.moveDown = true;
            }
            break;
        case 'ArrowLeft':
            if (player2) {
                player2.moveLeft = true;
            } else {
                // å•äººæ¨¡å¼ä¸‹ï¼Œæ–¹å‘é”®æ§åˆ¶ç©å®¶1
                player.moveLeft = true;
            }
            break;
        case 'ArrowRight':
            if (player2) {
                player2.moveRight = true;
            } else {
                // å•äººæ¨¡å¼ä¸‹ï¼Œæ–¹å‘é”®æ§åˆ¶ç©å®¶1
                player.moveRight = true;
            }
            break;
        case 'f': // ç©å®¶1åœ°é›· (æŒ‰ç…§README)
            handlePlayerMine(player);
            break;
        case 'g': // ç©å®¶1æ—‹è½¬å°„å‡» (æŒ‰ç…§README)
            activateRotateShoot(player);
            break;
        case 'd': // ç©å®¶1æ‰‹é›· (åŒäººæ¨¡å¼ï¼ŒæŒ‰ç…§README)
            if (player2) {
                // åŒäººæ¨¡å¼ä¸‹ï¼ŒDé”®ä¸ºç©å®¶1æŠ•æ·æ‰‹é›·
                handlePlayerGrenade(player);
            } else {
                // å•äººæ¨¡å¼ä¸‹ï¼ŒDé”®ä¸ºå‘å³ç§»åŠ¨
                player.moveRight = true;
            }
            break;
        case 'e': // ç©å®¶1æ”»å‡» (ä¿ç•™åŸæœ‰åŠŸèƒ½)
            if (player.canAttack) {
                player.isAttacking = true;
                player.attackTimer = 10; // æ”»å‡»åŠ¨ç”»æŒç»­æ—¶é—´
                player.canAttack = false;
                setTimeout(() => {
                    player.canAttack = true;
                }, player.attackCooldown);
            }
            break;
        case 'r': // ç©å®¶1ç¬é—´èŒƒå›´æ”»å‡» (ä¿ç•™åŸæœ‰åŠŸèƒ½)
            if (player.canAreaAttack) {
                activateAreaAttack(player);
            }
            break;
        case 't': // ç©å®¶1æ—‹è½¬å°„å‡» (ä¿ç•™åŸæœ‰åŠŸèƒ½)
            activateRotateShoot(player);
            break;
        // Player 1 controls (WASDé”®åœ¨å•äººå’ŒåŒäººæ¨¡å¼ä¸‹éƒ½æœ‰æ•ˆ)
        case 'w':
            // WASDæ§åˆ¶ç©å®¶1ç§»åŠ¨ï¼ˆå•äººå’ŒåŒäººæ¨¡å¼éƒ½å¯ç”¨ï¼‰
            player.moveUp = true;
            break;
        case 's':
            // WASDæ§åˆ¶ç©å®¶1ç§»åŠ¨ï¼ˆå•äººå’ŒåŒäººæ¨¡å¼éƒ½å¯ç”¨ï¼‰
            player.moveDown = true;
            break;
        case 'a':
            // WASDæ§åˆ¶ç©å®¶1ç§»åŠ¨ï¼ˆå•äººå’ŒåŒäººæ¨¡å¼éƒ½å¯ç”¨ï¼‰
            player.moveLeft = true;
            break;
        // åŒäººæ¨¡å¼ä¸‹ç©å®¶1çš„ç§»åŠ¨é”®ä½ (æŒ‰ç…§README)
        case 'i': // ç©å®¶1å‘ä¸Šç§»åŠ¨ (åŒäººæ¨¡å¼)
            if (player2) {
                player.moveUp = true;
            }
            break;
        case 'k': // ç©å®¶1å‘ä¸‹ç§»åŠ¨ (åŒäººæ¨¡å¼)
            if (player2) {
                player.moveDown = true;
            }
            break;
        case 'j': // ç©å®¶1å‘å·¦ç§»åŠ¨ (åŒäººæ¨¡å¼)
            if (player2) {
                player.moveLeft = true;
            }
            break;
        case 'l': // ç©å®¶1å‘å³ç§»åŠ¨ (åŒäººæ¨¡å¼)
            if (player2) {
                player.moveRight = true;
            }
            break;
        case ' ': // ç©å®¶2æ—‹è½¬å°„å‡»ï¼ˆæŒ‰ç…§READMEï¼‰
            if (player2) {
                activateRotateShoot(player2);
            } else {
                // å•äººæ¨¡å¼ä¸‹ï¼Œç©ºæ ¼é”®ä¹Ÿèƒ½æ§åˆ¶ç©å®¶1æ—‹è½¬å°„å‡»
                activateRotateShoot(player);
            }
            break;
        case "'": // ç©å®¶2åœ°é›·ï¼ˆæŒ‰ç…§READMEï¼‰
            if (player2) {
                handlePlayerMine(player2);
            } else {
                // å•äººæ¨¡å¼ä¸‹ï¼Œ'é”®ä¹Ÿèƒ½æ§åˆ¶ç©å®¶1æ”¾ç½®åœ°é›·
                handlePlayerMine(player);
            }
            break;
        case ';': // ç©å®¶2æ‰‹é›·ï¼ˆæŒ‰ç…§READMEï¼‰
            if (player2) {
                handlePlayerGrenade(player2);
            } 
            break;
        case '/': // ç©å®¶2æ”»å‡» (ä¿ç•™åŸæœ‰åŠŸèƒ½)
            if (player2 && player2.canAttack) {
                player2.isAttacking = true;
                player2.attackTimer = 10;
                player2.canAttack = false;
                setTimeout(() => {
                    player2.canAttack = true;
                }, player2.attackCooldown);
            } else if (player.canAttack) {
                // å•äººæ¨¡å¼ä¸‹ï¼Œ/é”®ä¹Ÿèƒ½æ§åˆ¶ç©å®¶1æ”»å‡»
                player.isAttacking = true;
                player.attackTimer = 10;
                player.canAttack = false;
                setTimeout(() => {
                    player.canAttack = true;
                }, player.attackCooldown);
            }
            break;
        case '.': // ç©å®¶2æ‰‹é›· (ä¿ç•™åŸæœ‰åŠŸèƒ½)
            if (player2) {
                handlePlayerGrenade(player2);
            } else {
                // å•äººæ¨¡å¼ä¸‹ï¼Œ.é”®ä¹Ÿèƒ½æ§åˆ¶ç©å®¶1æŠ•æ·æ‰‹é›·
                handlePlayerGrenade(player);
            }
            break;
        case ',': // ç©å®¶2ç¬é—´èŒƒå›´æ”»å‡» (ä¿ç•™åŸæœ‰åŠŸèƒ½)
            if (player2 && player2.canAreaAttack) {
                activateAreaAttack(player2);
            } else if (player.canAreaAttack) {
                // å•äººæ¨¡å¼ä¸‹ï¼Œ,é”®ä¹Ÿèƒ½æ§åˆ¶ç©å®¶1ç¬é—´èŒƒå›´æ”»å‡»
                activateAreaAttack(player);
            }
            break;

        case 'Escape': // è¿”å›å¤§å…
            if (gameWinner) {
                returnToLobby();
            }
            break;
    }
}

function handleKeyUp(e) {
    switch(e.key) {
        case 'ArrowUp':
            if (player2) {
                player2.moveUp = false;
            } else {
                // å•äººæ¨¡å¼ä¸‹ï¼Œæ–¹å‘é”®æ§åˆ¶ç©å®¶1
                player.moveUp = false;
            }
            break;
        case 'ArrowDown':
            if (player2) {
                player2.moveDown = false;
            } else {
                // å•äººæ¨¡å¼ä¸‹ï¼Œæ–¹å‘é”®æ§åˆ¶ç©å®¶1
                player.moveDown = false;
            }
            break;
        case 'ArrowLeft':
            if (player2) {
                player2.moveLeft = false;
            } else {
                // å•äººæ¨¡å¼ä¸‹ï¼Œæ–¹å‘é”®æ§åˆ¶ç©å®¶1
                player.moveLeft = false;
            }
            break;
        case 'ArrowRight':
            if (player2) {
                player2.moveRight = false;
            } else {
                // å•äººæ¨¡å¼ä¸‹ï¼Œæ–¹å‘é”®æ§åˆ¶ç©å®¶1
                player.moveRight = false;
            }
            break;
        case 'w':
            // WASDæ§åˆ¶ç©å®¶1ç§»åŠ¨ï¼ˆå•äººå’ŒåŒäººæ¨¡å¼éƒ½å¯ç”¨ï¼‰
            player.moveUp = false;
            break;
        case 's':
            // WASDæ§åˆ¶ç©å®¶1ç§»åŠ¨ï¼ˆå•äººå’ŒåŒäººæ¨¡å¼éƒ½å¯ç”¨ï¼‰
            player.moveDown = false;
            break;
        case 'a':
            // WASDæ§åˆ¶ç©å®¶1ç§»åŠ¨ï¼ˆå•äººå’ŒåŒäººæ¨¡å¼éƒ½å¯ç”¨ï¼‰
            player.moveLeft = false;
            break;
        case 'd':
            // åœ¨åŒäººæ¨¡å¼ä¸‹ï¼ŒDé”®ç”¨äºæ‰‹é›·ï¼Œä¸ç”¨äºç§»åŠ¨
            if (!player2) {
                player.moveRight = false;
            }
            break;
        // åŒäººæ¨¡å¼ä¸‹ç©å®¶1çš„ç§»åŠ¨é”®ä½ (æŒ‰ç…§README)
        case 'i': // ç©å®¶1å‘ä¸Šç§»åŠ¨ (åŒäººæ¨¡å¼)
            if (player2) {
                player.moveUp = false;
            }
            break;
        case 'k': // ç©å®¶1å‘ä¸‹ç§»åŠ¨ (åŒäººæ¨¡å¼)
            if (player2) {
                player.moveDown = false;
            }
            break;
        case 'j': // ç©å®¶1å‘å·¦ç§»åŠ¨ (åŒäººæ¨¡å¼)
            if (player2) {
                player.moveLeft = false;
            }
            break;
        case 'l': // ç©å®¶1å‘å³ç§»åŠ¨ (åŒäººæ¨¡å¼)
            if (player2) {
                player.moveRight = false;
            }
            break;
    }
}

function updatePlayerPosition(p) {
    if (p.canMove) {
        const oldX = p.x;
        const oldY = p.y;
        
        // åº”ç”¨åœ°å½¢é€Ÿåº¦ä¿®æ­£
        const effectiveSpeed = p.speed * (p.currentSpeedMultiplier || 1);
        
        if (p.moveUp) p.y -= effectiveSpeed;
        if (p.moveDown) p.y += effectiveSpeed;
        if (p.moveLeft) p.x -= effectiveSpeed;
        if (p.moveRight) p.x += effectiveSpeed;

        // è¾¹ç•Œæ£€æŸ¥
        p.x = Math.max(0, Math.min(canvas.width - p.width, p.x));
        p.y = Math.max(0, Math.min(canvas.height - p.height, p.y));
        
        // å¦‚æœç©å®¶ä½ç½®å‘ç”Ÿäº†å˜åŒ–ï¼Œè®°å½•è½¨è¿¹
        if (oldX !== p.x || oldY !== p.y) {
            p.trail.push({
                x: oldX + p.width / 2,
                y: oldY + p.height / 2,
                time: Date.now(),
                alpha: 1.0
            });
            
            // é™åˆ¶è½¨è¿¹é•¿åº¦ï¼Œä¿æŒæœ€è¿‘çš„20ä¸ªä½ç½®
            if (p.trail.length > 20) {
                p.trail.shift();
            }
        }
        
        // æ›´æ–°è½¨è¿¹é€æ˜åº¦
        const currentTime = Date.now();
        p.trail = p.trail.filter(point => {
            const age = currentTime - point.time;
            point.alpha = Math.max(0, 1 - age / 1000); // 1ç§’å†…å®Œå…¨æ¶ˆå¤±
            return point.alpha > 0;
        });
    }
}

function handlePlayerGrenade(p, targetX, targetY) {
    const currentTime = Date.now();
    if (!p.canThrowGrenade) {
        const remainingCooldown = Math.ceil((p.lastGrenadeThrowTime + GRENADE_COOLDOWN - currentTime) / 1000);
        if (remainingCooldown > 0) {
            showCooldownMessage('æ‰‹é›·', remainingCooldown);
        }
        return;
    }
    
    // æ£€æŸ¥è‰ä¸›æŠ€èƒ½è§¦å‘
    const playerId = p === player ? 'player1' : 'player2';
    checkGrassSkillTrigger(p, playerId);

    // å¦‚æœæ²¡æœ‰æä¾›ç›®æ ‡åæ ‡ï¼Œä½¿ç”¨ç©å®¶é™„è¿‘çš„éšæœºä½ç½®ï¼ˆç”¨äºé”®ç›˜æ§åˆ¶ï¼‰
    if (targetX === undefined || targetY === undefined) {
        targetX = p.x + p.width / 2 + (Math.random() - 0.5) * 200;
        targetY = p.y + p.height / 2 + (Math.random() - 0.5) * 200;
    }

    const flightTime = GRENADE_MIN_FLIGHT_TIME + Math.random() * (GRENADE_MAX_FLIGHT_TIME - GRENADE_MIN_FLIGHT_TIME);

    const grenade = {
        x: p.x + p.width / 2,
        y: p.y + p.height / 2,
        targetX: targetX,
        targetY: targetY,
        startTime: currentTime,
        flightTime: flightTime,
        radius: 10,
        color: '#3498db',
        damage: GRENADE_DAMAGE,
        explosionRadius: GRENADE_EXPLOSION_RADIUS,
        hasExploded: false,
        owner: p
    };
    grenades.push(grenade);

    p.canThrowGrenade = false;
    p.lastGrenadeThrowTime = currentTime;

    setTimeout(() => {
        p.canThrowGrenade = true;
    }, GRENADE_COOLDOWN);
}

function handlePlayerMine(p) {
    const currentTime = Date.now();
    if (!p.canPlaceMine) {
        const remainingCooldown = Math.ceil((p.lastMinePlaced + MINE_COOLDOWN - currentTime) / 1000);
        if (remainingCooldown > 0) {
            showCooldownMessage('åœ°é›·', remainingCooldown);
        }
        return;
    }

    const mine = {
        x: p.x + p.width / 2 - 15,
        y: p.y + p.height / 2 - 15,
        width: 30,
        height: 30,
        radius: 15,
        color: '#f1c40f',
        damage: MINE_DAMAGE,
        explosionRadius: MINE_EXPLOSION_RANGE,
        placedTime: currentTime,
        explodeTime: currentTime + 3000, // 3ç§’åçˆ†ç‚¸
        hasExploded: false,
        explosionTimer: 0,
        isExploding: false,
        damageApplied: false, // æ–°å¢å±æ€§ï¼Œæ ‡è®°ä¼¤å®³æ˜¯å¦å·²åº”ç”¨
        owner: p // æ·»åŠ ownerå±æ€§ï¼Œæ ‡è¯†åœ°é›·çš„æ‰€æœ‰è€…
    };
    mines.push(mine);

    p.canPlaceMine = false;
    p.lastMinePlaced = currentTime;

    setTimeout(() => {
        p.canPlaceMine = true;
    }, MINE_COOLDOWN);
}

function activateAreaAttack(p) {
    const currentTime = Date.now();
    if (!p.canAreaAttack) {
        const remainingCooldown = Math.ceil((p.lastAreaAttackTime + AREA_ATTACK_COOLDOWN - currentTime) / 1000);
        if (remainingCooldown > 0) {
            showCooldownMessage('ç¬é—´èŒƒå›´æ”»å‡»', remainingCooldown);
        }
        return;
    }

    // æ‰§è¡ŒèŒƒå›´æ”»å‡»
    enemies.forEach(enemy => {
        if (!enemy.isDead) {
            const dx = enemy.x + enemy.width / 2 - p.x - p.width / 2;
            const dy = enemy.y + enemy.height / 2 - p.y - p.height / 2;
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (distance <= AREA_ATTACK_RADIUS) {
                enemy.health -= AREA_ATTACK_DAMAGE;
                if (enemy.health <= 0) {
                    enemy.isDead = true;
                }
            }
        }
    });

    // å¯¹Bossé€ æˆèŒƒå›´æ”»å‡»ä¼¤å®³
    if (boss && !boss.isDead) {
        const dx = boss.x + boss.width / 2 - p.x - p.width / 2;
        const dy = boss.y + boss.height / 2 - p.y - p.height / 2;
        const distance = Math.sqrt(dx * dx + dy * dy);

        if (distance <= AREA_ATTACK_RADIUS) {
            boss.health -= AREA_ATTACK_DAMAGE;
            if (boss.health <= 0) {
                boss.isDead = true;
            }
        }
    }

    // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„çˆ†ç‚¸æ•ˆæœæ¥è¡¨ç¤ºèŒƒå›´æ”»å‡»
    createExplosion(p.x + p.width / 2, p.y + p.height / 2, AREA_ATTACK_RADIUS, 0, p); // ä¼¤å®³ä¸º0ï¼Œå› ä¸ºä¼¤å®³å·²ç›´æ¥è®¡ç®—

    p.canAreaAttack = false;
    p.lastAreaAttackTime = currentTime;

    setTimeout(() => {
        p.canAreaAttack = true;
    }, AREA_ATTACK_COOLDOWN);
}

// å®šç‚¹èŒƒå›´æ”»å‡»å‡½æ•°ï¼ˆç”¨äºé¼ æ ‡ç‚¹å‡»ï¼‰


function handlePlayerRotateShoot(p) {
    const currentTime = Date.now();
    if (!p.canUseRotateShoot) {
        const remainingCooldown = Math.ceil((p.lastRotateShootTime + ROTATE_SHOOT_COOLDOWN - currentTime) / 1000);
        if (remainingCooldown > 0) {
            showCooldownMessage('æ—‹è½¬å°„å‡»', remainingCooldown);
        }
        return;
    }

    p.isRotateShooting = true;
    p.rotateShootStartTime = currentTime;
    p.rotateShootEndTime = currentTime + ROTATE_SHOOT_DURATION;
    p.lastBulletTime = currentTime;

    p.canUseRotateShoot = false;
    p.lastRotateShootTime = currentTime;

    setTimeout(() => {
        p.canUseRotateShoot = true;
    }, ROTATE_SHOOT_COOLDOWN);
}

// æ›´æ–°æ•Œäººä½ç½®ï¼ˆç®€å•çš„AIï¼Œå‘ç©å®¶ç§»åŠ¨ï¼‰
function updateEnemies() {
    
    enemies.forEach(enemy => {
        if (!enemy.isDead) {
            // ç®€å•AIï¼šå‘ç©å®¶ç§»åŠ¨
            const currentTime = Date.now();

            // å¤„ç†æ•Œäººçœ©æ™•çŠ¶æ€
            if (enemy.isStunned) {
                if (currentTime - enemy.stunStartTime >= ENEMY_STUN_DURATION) {
                    enemy.isStunned = false; // çœ©æ™•ç»“æŸ
                }
            }

            // æ¢å¤æ•Œäººé€Ÿåº¦
            if (enemy.originalSpeed && enemy.speedReducedTime && (currentTime - enemy.speedReducedTime >= ENEMY_SPEED_RECOVERY_DURATION)) {
                enemy.speed = enemy.originalSpeed;
                enemy.originalSpeed = null; // æ¸…é™¤åŸå§‹é€Ÿåº¦è®°å½•
                enemy.speedReducedTime = null;
            }

            if (!enemy.isStunned) {
                const targetPlayer = enemy.targetPlayer; // è·å–æ•Œäººçš„ç›®æ ‡ç©å®¶
                const dx = targetPlayer.x - enemy.x;
                const dy = targetPlayer.y - enemy.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
    
                if (distance > 0) {
                    // åº”ç”¨åœ°å½¢é€Ÿåº¦ä¿®æ­£
                    const effectiveSpeed = enemy.speed * (enemy.speedMultiplier || 1);
                    enemy.x += (dx / distance) * effectiveSpeed;
                    enemy.y += (dy / distance) * effectiveSpeed;
                }
            }

            // æ•Œäººå°„å‡»é€»è¾‘
            // æ¸¸æˆå¼€å§‹5ç§’å†…æ•Œäººä¸èƒ½å°„å‡»
            const gameElapsedTime = currentTime - gameStartTime;
            if (enemy.type === 'purple') {
                if (gameElapsedTime < 5000) {
                    // åœ¨å†·å´æœŸå†…ï¼Œæ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
                    const remainingCooldown = Math.ceil((5000 - gameElapsedTime) / 1000);
                    if (Math.floor(gameElapsedTime / 1000) !== Math.floor((gameElapsedTime - 16) / 1000)) {
                        console.log(`ç´«è‰²æ•Œäººå†·å´ä¸­ï¼Œå‰©ä½™ ${remainingCooldown} ç§’`);
                    }
                } else if (currentTime - enemy.lastShootTime >= PURPLE_ENEMY_SHOOT_INTERVAL && enemy.canShoot !== false) {
                    // é€‰æ‹©æœ€è¿‘çš„ç©å®¶ä½œä¸ºç›®æ ‡
                    let targetPlayer = player;
                    let minDistance = Math.sqrt(Math.pow(player.x - enemy.x, 2) + Math.pow(player.y - enemy.y, 2));
                    
                    if (player2) {
                        const distanceToPlayer2 = Math.sqrt(Math.pow(player2.x - enemy.x, 2) + Math.pow(player2.y - enemy.y, 2));
                        if (distanceToPlayer2 < minDistance) {
                            targetPlayer = player2;
                            minDistance = distanceToPlayer2;
                        }
                    }

                    // è®¡ç®—å°„å‡»æ–¹å‘
                    const shootDx = targetPlayer.x - enemy.x;
                    const shootDy = targetPlayer.y - enemy.y;
                    const shootDistance = Math.sqrt(shootDx * shootDx + shootDy * shootDy);

                    if (shootDistance > 0) {
                        // åˆ›å»ºå­å¼¹
                        const bullet = {
                            x: enemy.x + enemy.width / 2,
                            y: enemy.y + enemy.height / 2,
                            vx: (shootDx / shootDistance) * PURPLE_ENEMY_BULLET_SPEED,
                            vy: (shootDy / shootDistance) * PURPLE_ENEMY_BULLET_SPEED,
                            radius: 8,
                            damage: PURPLE_ENEMY_BULLET_DAMAGE,
                            color: '#ff00ff' // äº®ç´«è‰²å­å¼¹ï¼Œæ›´å®¹æ˜“çœ‹è§
                        };
                        purpleEnemyBullets.push(bullet);
                        enemy.lastShootTime = currentTime;
                        console.log('ç´«è‰²æ•Œäººå°„å‡»ï¼å­å¼¹æ•°é‡:', purpleEnemyBullets.length);
                    }
                }
            } else if (enemy.type === 'red') {
                // çº¢è‰²æ•Œäººå°„å‡»é€»è¾‘
                if (gameElapsedTime >= 3000 && currentTime - enemy.lastShootTime >= RED_ENEMY_SHOOT_INTERVAL && enemy.canShoot !== false) {
                    // é€‰æ‹©æœ€è¿‘çš„ç©å®¶ä½œä¸ºç›®æ ‡
                    let targetPlayer = player;
                    let minDistance = Math.sqrt(Math.pow(player.x - enemy.x, 2) + Math.pow(player.y - enemy.y, 2));
                    
                    if (player2) {
                        const distanceToPlayer2 = Math.sqrt(Math.pow(player2.x - enemy.x, 2) + Math.pow(player2.y - enemy.y, 2));
                        if (distanceToPlayer2 < minDistance) {
                            targetPlayer = player2;
                            minDistance = distanceToPlayer2;
                        }
                    }

                    // è®¡ç®—å°„å‡»æ–¹å‘
                    const shootDx = targetPlayer.x - enemy.x;
                    const shootDy = targetPlayer.y - enemy.y;
                    const shootDistance = Math.sqrt(shootDx * shootDx + shootDy * shootDy);

                    if (shootDistance > 0) {
                        // åˆ›å»ºçº¢è‰²æ•Œäººå­å¼¹
                        const bullet = {
                            x: enemy.x + enemy.width / 2,
                            y: enemy.y + enemy.height / 2,
                            vx: (shootDx / shootDistance) * 4, // çº¢è‰²æ•Œäººå­å¼¹é€Ÿåº¦ç¨å¿«
                            vy: (shootDy / shootDistance) * 4,
                            radius: 6,
                            damage: 3, // çº¢è‰²æ•Œäººå­å¼¹ä¼¤å®³
                            color: '#ff4444' // äº®çº¢è‰²å­å¼¹
                        };
                        redEnemyBullets.push(bullet);
                        enemy.lastShootTime = currentTime;
                        console.log('çº¢è‰²æ•Œäººå°„å‡»ï¼å­å¼¹æ•°é‡:', redEnemyBullets.length);
                    }
                }
            }
            
            // æ£€æµ‹ä¸ç©å®¶çš„ç¢°æ’
            if (checkCollision(player, enemy)) {
                const currentTime = Date.now();
                // æ•Œäººæ¯0.3ç§’æ”»å‡»ä¸€æ¬¡
                if (!enemy.lastAttackTime || currentTime - enemy.lastAttackTime >= 300) {
                    enemy.lastAttackTime = currentTime;
                    player.health -= 10; // æ•Œäººæ”»å‡»ç©å®¶é€ æˆä¼¤å®³
                    
                    // æ•Œäººæ”»å‡»æ—¶èƒŒæ™¯é—ªçƒ
                    document.body.style.backgroundColor = 'rgba(255, 0, 0, 0.3)';
                    setTimeout(() => {
                        document.body.style.backgroundColor = 'black';
                    }, 100);
                }
                
                // ç©å®¶æ­»äº¡æ£€æŸ¥
                if (player.health <= 0) {
                    gameRunning = false;
                }
            }
            // æ£€æµ‹ä¸ç©å®¶2çš„ç¢°æ’
            if (player2 && checkCollision(player2, enemy)) {
                const currentTime = Date.now();
                // æ•Œäººæ¯0.3ç§’æ”»å‡»ä¸€æ¬¡
                if (!enemy.lastAttackTimeP2 || currentTime - enemy.lastAttackTimeP2 >= 300) {
                    enemy.lastAttackTimeP2 = currentTime;
                    player2.health -= 10; // æ•Œäººæ”»å‡»ç©å®¶2é€ æˆä¼¤å®³
                    
                    // æ•Œäººæ”»å‡»æ—¶èƒŒæ™¯é—ªçƒ
                    document.body.style.backgroundColor = 'rgba(255, 0, 0, 0.3)';
                    setTimeout(() => {
                        document.body.style.backgroundColor = 'black';
                    }, 100);
                }
                
                // ç©å®¶2æ­»äº¡æ£€æŸ¥
                if (player2.health <= 0) {
                    // ç©å®¶2æ­»äº¡ï¼Œæ¸¸æˆç»“æŸæˆ–ç©å®¶1èƒœåˆ©
                    gameRunning = false;
                    onGameEnd(); // æ¸¸æˆç»“æŸæ—¶æ˜¾ç¤ºé‚®ç®±
                }
            }
        }
    });
}

// æ›´æ–°ç´«è‰²æ•Œäººå­å¼¹
function updatePurpleEnemyBullets() {
    for (let i = purpleEnemyBullets.length - 1; i >= 0; i--) {
        const bullet = purpleEnemyBullets[i];
        
        // æ›´æ–°å­å¼¹ä½ç½®
        bullet.x += bullet.vx;
        bullet.y += bullet.vy;
        
        // æ£€æŸ¥å­å¼¹æ˜¯å¦è¶…å‡ºè¾¹ç•Œ
        if (bullet.x < 0 || bullet.x > canvas.width || bullet.y < 0 || bullet.y > canvas.height) {
            purpleEnemyBullets.splice(i, 1);
            continue;
        }
        
        // æ£€æŸ¥ä¸ç©å®¶1çš„ç¢°æ’
        if (checkCircleRectCollision(bullet, player)) {
            console.log('ç´«è‰²å­å¼¹å‡»ä¸­ç©å®¶1ï¼ä¼¤å®³:', bullet.damage, 'ç©å®¶è¡€é‡:', player.health);
            player.health -= bullet.damage; // æ‰£10æ»´è¡€
            purpleEnemyBullets.splice(i, 1);
            
            // åˆ›å»ºç´«è‰²çˆ†ç‚¸æ•ˆæœ
            createPurpleExplosion(bullet.x, bullet.y, 25, 0, null);
            console.log('åˆ›å»ºç´«è‰²çˆ†ç‚¸æ•ˆæœ');
            
            // èƒŒæ™¯é—ªçƒæ•ˆæœ
            document.body.style.backgroundColor = 'rgba(255, 0, 0, 0.3)';
            setTimeout(() => {
                document.body.style.backgroundColor = 'black';
            }, 100);
            
            // ç©å®¶æ­»äº¡æ£€æŸ¥
            if (player.health <= 0) {
                gameRunning = false;
            }
            continue;
        }
        
        // æ£€æŸ¥ä¸ç©å®¶2çš„ç¢°æ’
        if (player2 && checkCircleRectCollision(bullet, player2)) {
            console.log('ç´«è‰²å­å¼¹å‡»ä¸­ç©å®¶2ï¼ä¼¤å®³:', bullet.damage, 'ç©å®¶è¡€é‡:', player2.health);
            player2.health -= bullet.damage; // æ‰£10æ»´è¡€
            purpleEnemyBullets.splice(i, 1);
            
            // åˆ›å»ºç´«è‰²çˆ†ç‚¸æ•ˆæœ
            createPurpleExplosion(bullet.x, bullet.y, 25, 0, null);
            console.log('åˆ›å»ºç´«è‰²çˆ†ç‚¸æ•ˆæœ');
            
            // èƒŒæ™¯é—ªçƒæ•ˆæœ
            document.body.style.backgroundColor = 'rgba(255, 0, 0, 0.3)';
            setTimeout(() => {
                document.body.style.backgroundColor = 'black';
            }, 100);
            
            // ç©å®¶2æ­»äº¡æ£€æŸ¥
            if (player2.health <= 0) {
                gameRunning = false;
            }
            continue;
        }
    }
}

// æ›´æ–°çº¢è‰²æ•Œäººå­å¼¹
function updateRedEnemyBullets() {
    for (let i = redEnemyBullets.length - 1; i >= 0; i--) {
        const bullet = redEnemyBullets[i];
        
        // æ›´æ–°å­å¼¹ä½ç½®
        bullet.x += bullet.vx;
        bullet.y += bullet.vy;
        
        // æ£€æŸ¥å­å¼¹æ˜¯å¦è¶…å‡ºè¾¹ç•Œ
        if (bullet.x < 0 || bullet.x > canvas.width || bullet.y < 0 || bullet.y > canvas.height) {
            redEnemyBullets.splice(i, 1);
            continue;
        }
        
        // æ£€æŸ¥ä¸ç©å®¶1çš„ç¢°æ’
        if (checkCircleRectCollision(bullet, player)) {
            console.log('çº¢è‰²å­å¼¹å‡»ä¸­ç©å®¶1ï¼ä¼¤å®³:', bullet.damage, 'ç©å®¶è¡€é‡:', player.health);
            player.health -= bullet.damage; // æ‰£2æ»´è¡€
            redEnemyBullets.splice(i, 1);
            
            // åˆ›å»ºçº¢è‰²çˆ†ç‚¸æ•ˆæœ
            createExplosion(bullet.x, bullet.y, 20, 0, null);
            console.log('åˆ›å»ºçº¢è‰²çˆ†ç‚¸æ•ˆæœ');
            
            // èƒŒæ™¯é—ªçƒæ•ˆæœ
            document.body.style.backgroundColor = 'rgba(255, 100, 100, 0.2)';
            setTimeout(() => {
                document.body.style.backgroundColor = 'black';
            }, 80);
            
            // ç©å®¶æ­»äº¡æ£€æŸ¥
            if (player.health <= 0) {
                gameRunning = false;
            }
            continue;
        }
        
        // æ£€æŸ¥ä¸ç©å®¶2çš„ç¢°æ’
        if (player2 && checkCircleRectCollision(bullet, player2)) {
            console.log('çº¢è‰²å­å¼¹å‡»ä¸­ç©å®¶2ï¼ä¼¤å®³:', bullet.damage, 'ç©å®¶è¡€é‡:', player2.health);
            player2.health -= bullet.damage; // æ‰£2æ»´è¡€
            redEnemyBullets.splice(i, 1);
            
            // åˆ›å»ºçº¢è‰²çˆ†ç‚¸æ•ˆæœ
            createExplosion(bullet.x, bullet.y, 20, 0, null);
            console.log('åˆ›å»ºçº¢è‰²çˆ†ç‚¸æ•ˆæœ');
            
            // èƒŒæ™¯é—ªçƒæ•ˆæœ
            document.body.style.backgroundColor = 'rgba(255, 100, 100, 0.2)';
            setTimeout(() => {
                document.body.style.backgroundColor = 'black';
            }, 80);
            
            // ç©å®¶2æ­»äº¡æ£€æŸ¥
            if (player2.health <= 0) {
                gameRunning = false;
            }
            continue;
        }
    }
}

// æ›´æ–°BossçŠ¶æ€
function updateBoss() {
    if (!boss || boss.isDead) return;

    const currentTime = Date.now();

    // æ£€æŸ¥Bossè¡€é‡ï¼Œå¦‚æœä½äº20%åˆ™åŠ å¿«é€Ÿåº¦
    const healthPercentage = boss.health / boss.maxHealth;
    let currentSpeed = boss.speed;
    if (healthPercentage <= 0.2) {
        // è¡€é‡ä½äº20%æ—¶é€Ÿåº¦ç¿»å€
        if (!boss.originalSpeed) {
            boss.originalSpeed = boss.speed;
        }
        currentSpeed = boss.originalSpeed * 2;
    }

    // Boss ç§»åŠ¨ (ç®€å•åœ°å‘ç©å®¶ç§»åŠ¨)
    const dx = player.x - boss.x;
    const dy = player.y - boss.y;
    const distance = Math.sqrt(dx * dx + dy * dy);

    if (distance > 0) {
        boss.x += (dx / distance) * currentSpeed;
        boss.y += (dy / distance) * currentSpeed;
    }

    // Bossä¸ç©å®¶1ç›´æ¥ç¢°æ’æ£€æµ‹
    if (checkCollision(player, boss)) {
        // è¿ç»­æ‰£è¡€ï¼Œæ¯0.1ç§’æ‰£1è¡€
        if (!player.lastBossTouchTime || currentTime - player.lastBossTouchTime >= 100) {
            player.health -= 1;
            player.lastBossTouchTime = currentTime;
            
            // ç©å®¶æ­»äº¡æ£€æŸ¥
            if (player.health <= 0) {
                gameRunning = false;
            }
        }
    }

    // Bossä¸ç©å®¶2ç›´æ¥ç¢°æ’æ£€æµ‹
    if (player2 && checkCollision(player2, boss)) {
        // è¿ç»­æ‰£è¡€ï¼Œæ¯0.1ç§’æ‰£1è¡€
        if (!player2.lastBossTouchTime || currentTime - player2.lastBossTouchTime >= 100) {
            player2.health -= 1;
            player2.lastBossTouchTime = currentTime;
            
            // ç©å®¶æ­»äº¡æ£€æŸ¥
            if (player2.health <= 0) {
                gameRunning = false;
            }
        }
    }

    // Boss æŠ€èƒ½é‡Šæ”¾
    if (currentTime - boss.lastSkillTime >= BOSS_SKILL_COOLDOWN) {
        boss.shootSkill();
        boss.lastSkillTime = currentTime;
    }

    // æ›´æ–°Bosså­å¼¹
    boss.bullets.forEach((bullet, index) => {
        bullet.x += bullet.vx;
        bullet.y += bullet.vy;

        // æ£€æŸ¥å­å¼¹æ˜¯å¦è¶…å‡ºè¾¹ç•Œ
        if (bullet.x < 0 || bullet.x > canvas.width || bullet.y < 0 || bullet.y > canvas.height) {
            boss.bullets.splice(index, 1);
            return;
        }

        // æ£€æŸ¥Bosså­å¼¹ä¸ç©å®¶1çš„ç¢°æ’
        if (checkCollision(player, bullet)) {
            player.health -= 45; // Bosså­å¼¹é€ æˆ45ç‚¹ä¼¤å®³
            boss.bullets.splice(index, 1);

            // åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
            createExplosion(bullet.x, bullet.y, 30, 45, player);

            // ç©å®¶å‡é€Ÿè‡³30%
            if (!player.originalSpeed) {
                player.originalSpeed = player.speed;
            }
            player.speed = player.originalSpeed * 0.3;
            player.slowedByBoss = true;
            player.slowEndTime = Date.now() + 10000; // å‡é€ŸæŒç»­10ç§’

            // ç©å®¶æ­»äº¡æ£€æŸ¥
            if (player.health <= 0) {
                gameRunning = false;
            }
            return;
        }

        // æ£€æŸ¥Bosså­å¼¹ä¸ç©å®¶2çš„ç¢°æ’
        if (player2 && checkCollision(player2, bullet)) {
            player2.health -= 45; // Bosså­å¼¹é€ æˆ45ç‚¹ä¼¤å®³
            boss.bullets.splice(index, 1);

            // åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
            createExplosion(bullet.x, bullet.y, 30, 45, player2);

            // ç©å®¶å‡é€Ÿè‡³30%
            if (!player2.originalSpeed) {
                player2.originalSpeed = player2.speed;
            }
            player2.speed = player2.originalSpeed * 0.3;
            player2.slowedByBoss = true;
            player2.slowEndTime = Date.now() + 10000; // å‡é€ŸæŒç»­10ç§’

            // ç©å®¶æ­»äº¡æ£€æŸ¥
            if (player2.health <= 0) {
                gameRunning = false;
            }
        }
    });

    // æ£€æŸ¥Bossæ˜¯å¦æ­»äº¡
    if (boss && boss.health <= 0) {
        boss.isDead = true;
        gameRunning = false; // Bossæ­»äº¡ï¼Œæ¸¸æˆç»“æŸ
        boss = null; // æ¸…é™¤Bosså¯¹è±¡
        onGameEnd(); // æ¸¸æˆç»“æŸæ—¶æ˜¾ç¤ºé‚®ç®±
    }
}




// æ›´æ–°æ”»å‡»çŠ¶æ€
function updateAttackStatus() {
    const currentTime = Date.now();
    
    // æ£€æŸ¥æ”»å‡»æŒç»­æ—¶é—´æ˜¯å¦ç»“æŸ
    if (player.isAttacking && currentTime >= player.attackEndTime) {
        player.isAttacking = false;
    }
    
    // æ£€æŸ¥å†·å´æ—¶é—´æ˜¯å¦ç»“æŸ
    if (!player.canAttack && currentTime >= player.attackEndTime + ATTACK_COOLDOWN) {
        player.canAttack = true;
    }
}

// æ”»å‡»æ•Œäººå’ŒBoss - ç°åœ¨æ˜¯æŒç»­ä¼¤å®³
function attackEnemies() {
    // ç©å®¶1æ”»å‡»æ•Œäºº
    if (player.isAttacking) {
        enemies.forEach(enemy => {
            if (!enemy.isDead) {
                // è®¡ç®—ä¸ç©å®¶1çš„è·ç¦»
                const dx = enemy.x - player.x;
                const dy = enemy.y - player.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
    
                // å¦‚æœåœ¨æ”»å‡»èŒƒå›´å†…
                if (distance <= ATTACK_RANGE) {
                    // æ¯å¸§é€ æˆå°‘é‡ä¼¤å®³ï¼ˆæŒç»­ä¼¤å®³ï¼‰
                    enemy.health -= ATTACK_DAMAGE / 60; // å‡è®¾60FPSï¼Œæ¯ç§’æ€»ä¼¤å®³ä¸ºATTACK_DAMAGE
                    
                    // åˆ›å»ºçˆ†ç‚¸æ•ˆæœï¼ˆæ¯éš”å‡ å¸§åˆ›å»ºä¸€æ¬¡ï¼Œé¿å…è¿‡å¤šçˆ†ç‚¸ï¼‰
                    if (Math.random() < 0.1) { // 10%æ¦‚ç‡åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
                        createExplosion(enemy.x + enemy.width/2, enemy.y + enemy.height/2);
                    }
                    
                    // æ•Œäººæ­»äº¡æ£€æŸ¥
                    if (enemy.health <= 0) {
                        enemy.isDead = true;
                        // æ•Œäººæ­»äº¡æ—¶åˆ›å»ºå¤§çˆ†ç‚¸
                        createExplosion(enemy.x + enemy.width/2, enemy.y + enemy.height/2);
                    }
                }
            }
        });

        // ç©å®¶1æ”»å‡»Boss
        if (boss && !boss.isDead) {
            const dx = boss.x - player.x;
            const dy = boss.y - player.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (distance <= ATTACK_RANGE) {
                // æ¯å¸§é€ æˆå°‘é‡ä¼¤å®³ï¼ˆæŒç»­ä¼¤å®³ï¼‰
                boss.health -= ATTACK_DAMAGE / 60; // å‡è®¾60FPSï¼Œæ¯ç§’æ€»ä¼¤å®³ä¸ºATTACK_DAMAGE
                
                // åˆ›å»ºçˆ†ç‚¸æ•ˆæœï¼ˆæ¯éš”å‡ å¸§åˆ›å»ºä¸€æ¬¡ï¼Œé¿å…è¿‡å¤šçˆ†ç‚¸ï¼‰
                if (Math.random() < 0.1) { // 10%æ¦‚ç‡åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
                    createExplosion(boss.x + boss.width/2, boss.y + boss.height/2);
                }
                
                // Bossæ­»äº¡æ£€æŸ¥
                if (boss.health <= 0) {
                    boss.isDead = true;
                    // Bossæ­»äº¡æ—¶åˆ›å»ºå¤§çˆ†ç‚¸
                    createExplosion(boss.x + boss.width/2, boss.y + boss.height/2);
                }
            }
        }
    }
    
    // ç©å®¶2æ”»å‡»æ•Œäºº
    if (player2 && player2.isAttacking) {
        enemies.forEach(enemy => {
            if (!enemy.isDead) {
                // è®¡ç®—ä¸ç©å®¶2çš„è·ç¦»
                const dx = enemy.x - player2.x;
                const dy = enemy.y - player2.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
    
                // å¦‚æœåœ¨æ”»å‡»èŒƒå›´å†…
                if (distance <= ATTACK_RANGE) {
                    // æ¯å¸§é€ æˆå°‘é‡ä¼¤å®³ï¼ˆæŒç»­ä¼¤å®³ï¼‰
                    enemy.health -= ATTACK_DAMAGE / 60; // å‡è®¾60FPSï¼Œæ¯ç§’æ€»ä¼¤å®³ä¸ºATTACK_DAMAGE
                    
                    // åˆ›å»ºçˆ†ç‚¸æ•ˆæœï¼ˆæ¯éš”å‡ å¸§åˆ›å»ºä¸€æ¬¡ï¼Œé¿å…è¿‡å¤šçˆ†ç‚¸ï¼‰
                    if (Math.random() < 0.1) { // 10%æ¦‚ç‡åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
                        createExplosion(enemy.x + enemy.width/2, enemy.y + enemy.height/2);
                    }
                    
                    // æ•Œäººæ­»äº¡æ£€æŸ¥
                    if (enemy.health <= 0) {
                        enemy.isDead = true;
                        // æ•Œäººæ­»äº¡æ—¶åˆ›å»ºå¤§çˆ†ç‚¸
                        createExplosion(enemy.x + enemy.width/2, enemy.y + enemy.height/2);
                    }
                }
            }
        });

        // ç©å®¶2æ”»å‡»Boss
        if (boss && !boss.isDead) {
            const dx = boss.x - player2.x;
            const dy = boss.y - player2.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (distance <= ATTACK_RANGE) {
                // æ¯å¸§é€ æˆå°‘é‡ä¼¤å®³ï¼ˆæŒç»­ä¼¤å®³ï¼‰
                boss.health -= ATTACK_DAMAGE / 60; // å‡è®¾60FPSï¼Œæ¯ç§’æ€»ä¼¤å®³ä¸ºATTACK_DAMAGE
                
                // åˆ›å»ºçˆ†ç‚¸æ•ˆæœï¼ˆæ¯éš”å‡ å¸§åˆ›å»ºä¸€æ¬¡ï¼Œé¿å…è¿‡å¤šçˆ†ç‚¸ï¼‰
                if (Math.random() < 0.1) { // 10%æ¦‚ç‡åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
                    createExplosion(boss.x + boss.width/2, boss.y + boss.height/2);
                }
                
                // Bossæ­»äº¡æ£€æŸ¥
                if (boss.health <= 0) {
                    boss.isDead = true;
                    // Bossæ­»äº¡æ—¶åˆ›å»ºå¤§çˆ†ç‚¸
                    createExplosion(boss.x + boss.width/2, boss.y + boss.height/2);
                }
            }
        }
    }
}

// ç©å®¶é—´æ”»å‡» - æŒç»­ä¼¤å®³
function attackPlayers() {
    // åªåœ¨åŒäººæ¨¡å¼ä¸‹è¿›è¡Œç©å®¶é—´æ”»å‡»æ£€æµ‹
    if (!player2) return;
    
    // ç©å®¶1æ”»å‡»ç©å®¶2
    if (player.isAttacking) {
        const dx = player2.x - player.x;
        const dy = player2.y - player.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        if (distance <= ATTACK_RANGE) {
            // æ¯å¸§é€ æˆå°‘é‡ä¼¤å®³ï¼ˆæŒç»­ä¼¤å®³ï¼‰
            player2.health -= ATTACK_DAMAGE / 60; // å‡è®¾60FPSï¼Œæ¯ç§’æ€»ä¼¤å®³ä¸ºATTACK_DAMAGE
            
            // ç©å®¶2æ­»äº¡æ£€æŸ¥
            if (player2.health <= 0) {
                player2.health = 0;
            }
        }
    }
    
    // ç©å®¶2æ”»å‡»ç©å®¶1
    if (player2.isAttacking) {
        const dx = player.x - player2.x;
        const dy = player.y - player2.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        if (distance <= ATTACK_RANGE) {
            // æ¯å¸§é€ æˆå°‘é‡ä¼¤å®³ï¼ˆæŒç»­ä¼¤å®³ï¼‰
            player.health -= ATTACK_DAMAGE / 60; // å‡è®¾60FPSï¼Œæ¯ç§’æ€»ä¼¤å®³ä¸ºATTACK_DAMAGE
            
            // ç©å®¶1æ­»äº¡æ£€æŸ¥
            if (player.health <= 0) {
                player.health = 0;
            }
        }
    }
}


// ç¢°æ’æ£€æµ‹
function checkCollision(rect1, rect2) {
    return rect1.x < rect2.x + rect2.width &&
           rect1.x + rect1.width > rect2.x &&
           rect1.y < rect2.y + rect2.height &&
           rect1.y + rect1.height > rect2.y;
}

// æ£€æŸ¥åœ†å½¢ä¸çŸ©å½¢çš„ç¢°æ’ï¼ˆç”¨äºå­å¼¹ä¸ç©å®¶çš„ç¢°æ’æ£€æµ‹ï¼‰
function checkCircleRectCollision(circle, rect) {
    // æ‰¾åˆ°çŸ©å½¢ä¸Šè·ç¦»åœ†å¿ƒæœ€è¿‘çš„ç‚¹
    const closestX = Math.max(rect.x, Math.min(circle.x, rect.x + rect.width));
    const closestY = Math.max(rect.y, Math.min(circle.y, rect.y + rect.height));
    
    // è®¡ç®—è·ç¦»
    const dx = circle.x - closestX;
    const dy = circle.y - closestY;
    const distance = Math.sqrt(dx * dx + dy * dy);
    
    return distance <= circle.radius;
}

// ç»˜åˆ¶ç©å®¶
function drawPlayer(p) {
    // ç»˜åˆ¶ç©å®¶ç§»åŠ¨è½¨è¿¹
    if (p.trail && p.trail.length > 1) {
        ctx.save();
        
        for (let i = 0; i < p.trail.length - 1; i++) {
            const point = p.trail[i];
            const nextPoint = p.trail[i + 1];
            
            // è®¾ç½®è½¨è¿¹é¢œè‰²å’Œé€æ˜åº¦
            const trailAlpha = point.alpha * 0.6; // è½¨è¿¹æ¯”ç©å®¶æ›´é€æ˜
            ctx.strokeStyle = `rgba(${p.color === 'blue' ? '0, 100, 255' : '255, 215, 0'}, ${trailAlpha})`;
            ctx.lineWidth = 8 * point.alpha; // è½¨è¿¹å®½åº¦éšé€æ˜åº¦å˜åŒ–
            ctx.lineCap = 'round';
            
            // ç»˜åˆ¶è½¨è¿¹çº¿æ®µ
            ctx.beginPath();
            ctx.moveTo(point.x, point.y);
            ctx.lineTo(nextPoint.x, nextPoint.y);
            ctx.stroke();
        }
        
        ctx.restore();
    }
    
    // ç»˜åˆ¶ç©å®¶è§’è‰²
    ctx.fillStyle = p.color;
    ctx.fillRect(p.x, p.y, p.width, p.height);
    
    // ç»˜åˆ¶ç©å®¶è¡€æ¡
    drawHealthBar(p.x, p.y - 15, p.width, 5, p.health, PLAYER_MAX_HEALTH, '#2ecc71');
    
    // ç»˜åˆ¶æ”»å‡»èŒƒå›´ï¼ˆå½“æ”»å‡»æ—¶ï¼‰
    if (p.isAttacking) {
        ctx.beginPath();
        ctx.arc(p.x + p.width/2, p.y + p.height/2, ATTACK_RANGE, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(255, 255, 0, 0.5)';
        ctx.stroke();
        
        p.attackTimer--;
        if (p.attackTimer <= 0) {
            p.isAttacking = false;
        }
    }
}

// ç»˜åˆ¶æ•Œäºº
function drawEnemies() {
    enemies.forEach(enemy => {
        if (!enemy.isDead) {
            // ç»˜åˆ¶æ•Œäººæ”»å‡»èŒƒå›´
            ctx.beginPath();
            ctx.arc(enemy.x + enemy.width/2, enemy.y + enemy.height/2, 60, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(231, 76, 60, 0.5)';
            ctx.stroke();
            
            // ç»˜åˆ¶æ•Œäºº
            ctx.fillStyle = enemy.color;
            ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
            
            // ç»˜åˆ¶æ•Œäººè¡€æ¡
            drawHealthBar(enemy.x, enemy.y - 10, enemy.width, 5, enemy.health, enemy.maxHealth, '#e74c3c');
        }
    });
}

// ç»˜åˆ¶è¡€æ¡
function drawHealthBar(x, y, width, height, health, maxHealth, color) {
    const healthPercentage = Math.max(0, health / maxHealth);
    
    // è¡€æ¡èƒŒæ™¯
    ctx.fillStyle = '#333';
    ctx.fillRect(x, y, width, height);
    
    // è¡€æ¡
    ctx.fillStyle = color;
    ctx.fillRect(x, y, width * healthPercentage, height);
}

// ç»˜åˆ¶æ¸¸æˆçŠ¶æ€
function drawGameStatus() {
    // æ˜¾ç¤ºç©å®¶è¡€é‡
    ctx.fillStyle = 'white';
    ctx.font = '16px Arial';
    ctx.textAlign = 'left';
    ctx.fillText(`ç©å®¶1 è¡€é‡: ${Math.floor(player.health)}/${PLAYER_MAX_HEALTH}`, 10, canvas.height - 10);
    if (player2) {
        ctx.fillText(`ç©å®¶2 è¡€é‡: ${Math.floor(player2.health)}/${PLAYER_MAX_HEALTH}`, 10, canvas.height - 30);
    }
    
    // æ˜¾ç¤ºå‰©ä½™æ•Œäººæ•°é‡
    const aliveEnemies = enemies.filter(enemy => !enemy.isDead).length;
    ctx.fillText(`å‰©ä½™æ•Œäºº: ${aliveEnemies}/${enemies.length}`, canvas.width - 150, canvas.height - 10);
    
    // æ˜¾ç¤ºæŠ€èƒ½çŠ¶æ€
    const currentTime = Date.now();
    
    // æ™®é€šæ”»å‡»çŠ¶æ€
    let attackStatus = player.canAttack ? 'å°±ç»ª' : 
        `å†·å´ä¸­ (${Math.ceil((player.attackStartTime + ATTACK_DURATION + ATTACK_COOLDOWN - currentTime) / 1000)}ç§’)`;
    ctx.fillText(`æ™®é€šæ”»å‡»: ${attackStatus}`, 10, canvas.height - 35);
    
    // åœ°é›·æŠ€èƒ½çŠ¶æ€
    let mineStatus = player.canPlaceMine ? 'å°±ç»ª' : 
        `å†·å´ä¸­ (${Math.ceil((player.lastMinePlaced + MINE_COOLDOWN - currentTime) / 1000)}ç§’)`;
    ctx.fillText(`åœ°é›·æŠ€èƒ½: ${mineStatus}`, 10, canvas.height - 60);

    // æ‰‹é›·æŠ€èƒ½çŠ¶æ€
    let grenadeStatus = player.canThrowGrenade ? 'å°±ç»ª' :
        `å†·å´ä¸­ (${Math.ceil((player.lastGrenadeThrowTime + GRENADE_COOLDOWN - currentTime) / 1000)}ç§’)`;
    ctx.fillText(`æ‰‹é›·æŠ€èƒ½: ${grenadeStatus}`, 10, canvas.height - 110);
    
    // æ—‹è½¬å°„å‡»æŠ€èƒ½çŠ¶æ€
    let rotateShootStatus = '';
    if (player.canUseRotateShoot) {
        rotateShootStatus = 'å°±ç»ª';
    } else if (player.rotateShootActive) {
        const remainingDuration = Math.ceil((player.rotateShootStartTime + ROTATE_SHOOT_DURATION - currentTime) / 1000);
        if (remainingDuration > 0) {
            rotateShootStatus = `æ¿€æ´»ä¸­ (${remainingDuration}ç§’)`;
        } else {
            player.rotateShootActive = false; // æŒç»­æ—¶é—´ç»“æŸ
            rotateShootStatus = 'å°±ç»ª'; // æŒç»­æ—¶é—´ç»“æŸåç«‹å³æ˜¾ç¤ºå°±ç»ªï¼Œç­‰å¾…å†·å´
        }
    } else {
        const remainingCooldown = Math.ceil((player.lastRotateShootTime + ROTATE_SHOOT_DURATION + ROTATE_SHOOT_COOLDOWN - currentTime) / 1000);
        rotateShootStatus = `å†·å´ä¸­ (${remainingCooldown}ç§’)`;
    }
    ctx.fillText(`æ—‹è½¬å°„å‡»: ${rotateShootStatus}`, 10, canvas.height - 85);
    

}

// æ•Œäººç”Ÿæˆè®¡æ—¶

// ç”Ÿæˆç´«è‰²æ•Œäºº
function generatePurpleEnemy() {
    const currentTime = Date.now();
    
    // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ç”Ÿæˆé—´éš”
    if (currentTime - lastPurpleEnemySpawnTime >= PURPLE_ENEMY_SPAWN_INTERVAL) {
        // æ ¹æ®æ¦‚ç‡å†³å®šæ˜¯å¦ç”Ÿæˆ
        if (Math.random() < PURPLE_ENEMY_SPAWN_CHANCE) {
            const enemy = {
                x: Math.random() * (canvas.width - 30),
                y: Math.random() * (canvas.height - 30),
                width: 30,
                height: 30,
                color: '#8e44ad', // ç´«è‰²
                health: PURPLE_ENEMY_HEALTH,
                maxHealth: PURPLE_ENEMY_HEALTH,
                speed: PURPLE_ENEMY_SPEED,
                isDead: false,
                type: 'purple', // æ ‡è®°ä¸ºç´«è‰²æ•Œäºº
                lastShootTime: 0 // ä¸Šæ¬¡å°„å‡»æ—¶é—´
            };
            enemies.push(enemy);
        }
        
        // æ›´æ–°æœ€åç”Ÿæˆæ—¶é—´
        lastPurpleEnemySpawnTime = currentTime;
    }
}

// ç”Ÿæˆçº¢è‰²æ•Œäºº
function generateRedEnemy() {
    const currentTime = Date.now();
    
    // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ç”Ÿæˆé—´éš”
    if (currentTime - lastRedEnemySpawnTime >= RED_ENEMY_SPAWN_INTERVAL) {
        // æ ¹æ®æ¦‚ç‡å†³å®šæ˜¯å¦ç”Ÿæˆ
        if (Math.random() < RED_ENEMY_SPAWN_CHANCE) {
            const enemy = {
                x: Math.random() * (canvas.width - 30),
                y: Math.random() * (canvas.height - 30),
                width: 30,
                height: 30,
                color: '#e74c3c', // çº¢è‰²
                health: RED_ENEMY_HEALTH,
                maxHealth: RED_ENEMY_HEALTH,
                speed: RED_ENEMY_SPEED,
                isDead: false
            };
            enemies.push(enemy);
        }
        
        // æ›´æ–°æœ€åç”Ÿæˆæ—¶é—´
        lastRedEnemySpawnTime = currentTime;
    }
}

// æ¿€æ´»æ—‹è½¬å°„å‡»æŠ€èƒ½ (å¼€å§‹å……èƒ½)
function activateRotateShoot(p) {
    console.log('activateRotateShoot called'); // æ·»åŠ æ—¥å¿—
    const currentTime = Date.now();

    // æ£€æŸ¥æ˜¯å¦åœ¨å†·å´ä¸­
    if (!p.canUseRotateShoot) {
        const remainingCooldown = Math.ceil((p.lastRotateShootTime + ROTATE_SHOOT_COOLDOWN - currentTime) / 1000);
        if (remainingCooldown > 0) {
            showCooldownMessage('æ—‹è½¬å°„å‡»', remainingCooldown);
        }
        return;
    }
    
    // æ£€æŸ¥è‰ä¸›æŠ€èƒ½è§¦å‘
    const playerId = p === player ? 'player1' : 'player2';
    checkGrassSkillTrigger(p, playerId);

    // ç›´æ¥æ¿€æ´»æ—‹è½¬å°„å‡»ï¼Œä¸è¿›è¡Œå……èƒ½
    p.isChargingRotateShoot = false; // ç¡®ä¿å……èƒ½çŠ¶æ€ä¸ºfalse
    launchRotateShoot(p);

    // æ—‹è½¬å°„å‡»æ¿€æ´»æ—¶ï¼Œç©å®¶é€Ÿåº¦é™ä¸º30%
    p.speed = PLAYER_SPEED * 0.3;
    p.rotateShootActive = true;
    // æ—‹è½¬å°„å‡»æ—¶ç©å®¶å¯ä»¥ç§»åŠ¨ï¼Œä½†é€Ÿåº¦é™ä½

    // æŠ€èƒ½ç»“æŸåæ¢å¤åŸé€Ÿ
    setTimeout(() => {
        p.speed = PLAYER_SPEED;
    }, ROTATE_SHOOT_DURATION);
    p.rotateShootStartTime = currentTime;
    showCooldownMessage('æ—‹è½¬å°„å‡»', 'å·²æ¿€æ´»');
}



// å‘å°„å¼•åŠ›ç‚¸å¼¹
// å‘å°„æ—‹è½¬å°„å‡»
function launchRotateShoot(p) {
    p.canUseRotateShoot = false;
    p.lastRotateShootTime = Date.now();

    let bulletsFired = 0;
    const totalBullets = ROTATE_SHOOT_DURATION / ROTATE_SHOOT_INTERVAL;

    const shootInterval = setInterval(() => {
        if (bulletsFired < totalBullets) {
            createBullet(p);
            bulletsFired++;
        } else {
            clearInterval(shootInterval);
        }
    }, ROTATE_SHOOT_INTERVAL);

    // è®¾ç½®å†·å´ï¼Œåœ¨æŠ€èƒ½æŒç»­æ—¶é—´ç»“æŸåå¼€å§‹è®¡ç®—
    setTimeout(() => {
        p.canUseRotateShoot = true;
    }, ROTATE_SHOOT_DURATION + ROTATE_SHOOT_COOLDOWN);
}



// åˆ›å»ºå­å¼¹ï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼‰
function createBullet(p) {
    const centerX = p.x + p.width / 2;
    const centerY = p.y + p.height / 2;
    
    // è®¡ç®—å­å¼¹æ–¹å‘ï¼ˆåŸºäºå½“å‰æ—‹è½¬è§’åº¦ï¼‰
    const directionX = Math.cos(p.rotationAngle);
    const directionY = -Math.sin(p.rotationAngle);
    
    // åˆ›å»ºæ–°å­å¼¹
    const bullet = {
        x: centerX,
        y: centerY,
        radius: ROTATE_SHOOT_RADIUS,
        directionX: directionX,
        directionY: directionY,
        speed: ROTATE_SHOOT_SPEED,
        damage: ROTATE_SHOOT_DAMAGE,
        hasHit: false,
        color: '#f39c12', // å­å¼¹é¢œè‰²
        isRotateShootBullet: true,
        owner: p // æ·»åŠ å­å¼¹çš„æ‹¥æœ‰è€…
    };
    
    // æ·»åŠ åˆ°å­å¼¹æ•°ç»„
    bullets.push(bullet);
    
    // æ›´æ–°æ—‹è½¬è§’åº¦ï¼ˆæ¯æ¬¡å‘å°„åæ—‹è½¬ï¼‰
    p.rotationAngle += Math.PI / 8; // æ¯æ¬¡æ—‹è½¬45åº¦
    if (p.rotationAngle >= Math.PI * 2) {
        p.rotationAngle = 0; // é‡ç½®ä¸º0å½“å®Œæˆä¸€åœˆ
    }
}

// æŒ‰æŒ‡å®šæ–¹å‘åˆ›å»ºå­å¼¹
function createBulletInDirection(p, angle) {
    const centerX = p.x + p.width / 2;
    const centerY = p.y + p.height / 2;
    
    // è®¡ç®—å­å¼¹æ–¹å‘
    const directionX = Math.cos(angle);
    const directionY = Math.sin(angle);
    
    // åˆ›å»ºæ–°å­å¼¹
    const bullet = {
        x: centerX,
        y: centerY,
        radius: ROTATE_SHOOT_RADIUS,
        directionX: directionX,
        directionY: directionY,
        speed: ROTATE_SHOOT_SPEED,
        damage: ROTATE_SHOOT_DAMAGE,
        hasHit: false,
        color: '#f39c12', // å­å¼¹é¢œè‰²
        isRotateShootBullet: true,
        owner: p // æ·»åŠ å­å¼¹çš„æ‹¥æœ‰è€…
    };
    
    // æ·»åŠ åˆ°å­å¼¹æ•°ç»„
    bullets.push(bullet);
}

// æ›´æ–°å­å¼¹ä½ç½®å’Œæ£€æµ‹ç¢°æ’
function updateRotateShootStatus(p) {
    if (!p.rotateShootActive) return;

    const currentTime = Date.now();
    if (currentTime >= p.rotateShootStartTime + ROTATE_SHOOT_DURATION) {
        p.rotateShootActive = false;
        p.speed = PLAYER_SPEED; // æ¢å¤ç©å®¶é€Ÿåº¦
        return;
    }
}

function updateBullets(p) {
    for (let i = bullets.length - 1; i >= 0; i--) {
        const bullet = bullets[i];
        // åªå¤„ç†å±äºå½“å‰ç©å®¶çš„å­å¼¹
        if (bullet.owner !== p) continue;

        // æ›´æ–°å­å¼¹ä½ç½®
        bullet.x += bullet.directionX * bullet.speed;
        bullet.y += bullet.directionY * bullet.speed;
        
        // æ£€æŸ¥æ˜¯å¦è¶…å‡ºç”»å¸ƒè¾¹ç•Œ
        if (bullet.x < 0 || bullet.x > canvas.width || bullet.y < 0 || bullet.y > canvas.height) {
            bullets.splice(i, 1);
            continue;
        }
        
        // æ£€æµ‹ä¸Bossçš„ç¢°æ’
        if (boss && !boss.isDead) {
            const closestX = Math.max(boss.x, Math.min(bullet.x, boss.x + boss.width));
            const closestY = Math.max(boss.y, Math.min(bullet.y, boss.y + boss.height));
            
            const distanceX = bullet.x - closestX;
            const distanceY = bullet.y - closestY;
            const distance = Math.sqrt(distanceX * distanceX + distanceY * distanceY);
            
            if (distance < ROTATE_SHOOT_RADIUS) {
                // å­å¼¹å‡»ä¸­Boss
                boss.health -= 15;
                
                // åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
                createExplosion(bullet.x, bullet.y);
                
                // æ£€æŸ¥Bossæ˜¯å¦æ­»äº¡
                if (boss.health <= 0) {
                    boss.isDead = true;
                }
                
                bullets.splice(i, 1); // å‡»ä¸­åç«‹å³ç§»é™¤å­å¼¹
                continue;
            }
        }

        // æ£€æµ‹ä¸æ•Œäººçš„ç¢°æ’
        let hasHitEnemy = false;
        for (let j = 0; j < enemies.length; j++) {
            const enemy = enemies[j];
            if (!enemy.isDead) {
                // ç®€å•çš„åœ†å½¢ä¸çŸ©å½¢ç¢°æ’æ£€æµ‹
                const closestX = Math.max(enemy.x, Math.min(bullet.x, enemy.x + enemy.width));
                const closestY = Math.max(enemy.y, Math.min(bullet.y, enemy.y + enemy.height));
                
                const distanceX = bullet.x - closestX;
                const distanceY = bullet.y - closestY;
                const distance = Math.sqrt(distanceX * distanceX + distanceY * distanceY);
                
                if (distance < ROTATE_SHOOT_RADIUS) {
                    // å­å¼¹å‡»ä¸­æ•Œäºº
                    enemy.health -= ROTATE_SHOOT_DAMAGE;

                    // å¦‚æœæ˜¯æ—‹è½¬å°„å‡»å­å¼¹ï¼Œè®©æ•Œäººåé€€10åƒç´ 
                    if (bullet.isRotateShootBullet) {
                        const knockbackDistance = 10;
                        enemy.x -= bullet.directionX * knockbackDistance;
                        enemy.y -= bullet.directionY * knockbackDistance;

                        // ç¡®ä¿æ•Œäººä¸ä¼šç§»å‡ºç”»å¸ƒ
                        enemy.x = Math.max(0, Math.min(canvas.width - enemy.width, enemy.x));
                        enemy.y = Math.max(0, Math.min(canvas.height - enemy.height, enemy.y));

                        // æ•Œäººé€Ÿåº¦é™åˆ°åŸæ¥çš„ç™¾åˆ†ä¹‹ä¸‰å
                        if (!enemy.originalSpeed) {
                            enemy.originalSpeed = enemy.speed; // å­˜å‚¨åŸå§‹é€Ÿåº¦
                        }
                        enemy.speed = enemy.originalSpeed * 0.3; // é™ä½é€Ÿåº¦
                        enemy.speedReducedTime = Date.now(); // è®°å½•é€Ÿåº¦é™ä½çš„æ—¶é—´

                        // æ•ŒäººæŒç»­æ‰£è¡€ï¼Œç›´åˆ°è¡€é‡ä½äº50%
                        if (enemy.health > enemy.maxHealth * 0.5) {
                            enemy.isBleeding = true;
                            enemy.bleedDamage = bullet.damage / 5; // æ¯æ¬¡æ‰£è¡€é‡ï¼Œå¯ä»¥è°ƒæ•´
                            enemy.bleedInterval = 500; // æ¯0.5ç§’æ‰£è¡€ä¸€æ¬¡
                            enemy.lastBleedTime = Date.now();
                        } else {
                            enemy.isBleeding = false;
                        }
                    }

                    // æ£€æŸ¥æ•Œäººæ˜¯å¦æ­»äº¡
                    if (enemy.health <= 0) {
                        enemy.isDead = true;
                    }

                    // åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
                    createExplosion(bullet.x, bullet.y);

                    // å¦‚æœæ˜¯æ—‹è½¬å°„å‡»çš„å­å¼¹ï¼Œä½¿æ•Œäººåœæ­¢ç§»åŠ¨å¹¶æŒç»­æ‰£è¡€
                    if (bullet.isRotateShootBullet) {
                        enemy.isStunned = true;
                        enemy.stunStartTime = Date.now();
                    }

                    hasHitEnemy = true;
                    bullets.splice(i, 1); // å‡»ä¸­åç«‹å³ç§»é™¤å­å¼¹
                    break;
                }
            }
        }
    }
}

// ç»˜åˆ¶å­å¼¹
function drawBullets() {
    bullets.forEach(bullet => {
        ctx.fillStyle = bullet.color || '#f39c12'; // æ©™è‰²å­å¼¹ï¼Œå¦‚æœå­å¼¹æ²¡æœ‰é¢œè‰²å±æ€§åˆ™é»˜è®¤ä¸ºæ©™è‰²
        ctx.beginPath();
        ctx.arc(bullet.x, bullet.y, ROTATE_SHOOT_RADIUS, 0, Math.PI * 2);
        ctx.fill();
    });

    // ç»˜åˆ¶Bosså­å¼¹
    if (boss && boss.bullets) {
        boss.bullets.forEach(bullet => {
            ctx.fillStyle = bullet.color;
            ctx.beginPath();
            ctx.arc(bullet.x, bullet.y, bullet.radius, 0, Math.PI * 2);
            ctx.fill();
        });
    }

    // ç»˜åˆ¶ç´«è‰²æ•Œäººå­å¼¹
    purpleEnemyBullets.forEach(bullet => {
        // æ·»åŠ å‘å…‰æ•ˆæœ
        ctx.save();
        ctx.shadowColor = bullet.color;
        ctx.shadowBlur = 15;
        ctx.fillStyle = bullet.color;
        ctx.beginPath();
        ctx.arc(bullet.x, bullet.y, bullet.radius, 0, Math.PI * 2);
        ctx.fill();
        
        // ç»˜åˆ¶ç™½è‰²å†…æ ¸
        ctx.shadowBlur = 0;
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(bullet.x, bullet.y, bullet.radius * 0.4, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
    });

    // ç»˜åˆ¶çº¢è‰²æ•Œäººå­å¼¹
    redEnemyBullets.forEach(bullet => {
        // æ·»åŠ å‘å…‰æ•ˆæœ
        ctx.save();
        ctx.shadowColor = bullet.color;
        ctx.shadowBlur = 12;
        ctx.fillStyle = bullet.color;
        ctx.beginPath();
        ctx.arc(bullet.x, bullet.y, bullet.radius, 0, Math.PI * 2);
        ctx.fill();
        
        // ç»˜åˆ¶ç™½è‰²å†…æ ¸
        ctx.shadowBlur = 0;
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(bullet.x, bullet.y, bullet.radius * 0.3, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
    });
}





// åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
function createExplosion(x, y, radius = EXPLOSION_MAX_RADIUS, damage = 0, owner = null) {
    const explosion = {
        x: x,
        y: y,
        radius: 5, // åˆå§‹åŠå¾„
        maxRadius: radius,
        duration: EXPLOSION_DURATION,
        timer: EXPLOSION_DURATION, // å€’è®¡æ—¶
        colors: ['#ff0000', '#ff7700', '#ffff00'], // çˆ†ç‚¸é¢œè‰²æ¸å˜ï¼ˆçº¢->æ©™->é»„ï¼‰
        damage: damage,
        owner: owner, // æ·»åŠ çˆ†ç‚¸çš„æ‹¥æœ‰è€…
        particles: [] // æ·»åŠ ç²’å­ç³»ç»Ÿ
    };
    
    // åˆ›å»ºçˆ†ç‚¸ç²’å­
    for (let i = 0; i < EXPLOSION_PARTICLES; i++) {
        const angle = (Math.PI * 2 * i) / EXPLOSION_PARTICLES;
        const speed = Math.random() * 4 + 3;
        explosion.particles.push({
            x: x,
            y: y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            life: EXPLOSION_DURATION,
            maxLife: EXPLOSION_DURATION,
            size: Math.random() * 3 + 2
        });
    }
    
    // æ·»åŠ åˆ°çˆ†ç‚¸æ•ˆæœæ•°ç»„
    explosions.push(explosion);
}

// åˆ›å»ºç´«è‰²çˆ†ç‚¸æ•ˆæœ
function createPurpleExplosion(x, y, radius = EXPLOSION_MAX_RADIUS, damage = 0, owner = null) {
    const explosion = {
        x: x,
        y: y,
        radius: 5, // åˆå§‹åŠå¾„
        maxRadius: radius,
        duration: EXPLOSION_DURATION,
        timer: EXPLOSION_DURATION, // å€’è®¡æ—¶
        colors: ['#8B00FF', '#9932CC', '#DA70D6'], // ç´«è‰²çˆ†ç‚¸é¢œè‰²æ¸å˜ï¼ˆæ·±ç´«->ä¸­ç´«->æµ…ç´«ï¼‰
        damage: damage,
        owner: owner // æ·»åŠ çˆ†ç‚¸çš„æ‹¥æœ‰è€…
    };
    
    // æ·»åŠ åˆ°çˆ†ç‚¸æ•ˆæœæ•°ç»„
    explosions.push(explosion);
    console.log('ç´«è‰²çˆ†ç‚¸å·²åˆ›å»ºï¼ä½ç½®:', x, y, 'çˆ†ç‚¸æ•°ç»„é•¿åº¦:', explosions.length);
}

// æ›´æ–°çˆ†ç‚¸æ•ˆæœ
function updateExplosions(p) {
    for (let i = explosions.length - 1; i >= 0; i--) {
        const explosion = explosions[i];
        // åªå¤„ç†å±äºå½“å‰ç©å®¶çš„çˆ†ç‚¸ï¼Œå…¬å…±çˆ†ç‚¸ç”±updatePublicExplosionså¤„ç†
        if (explosion.owner !== p) continue;
        
        // æ›´æ–°è®¡æ—¶å™¨
        explosion.timer--;
        
        // è®¡ç®—å½“å‰åŠå¾„ï¼ˆéšæ—¶é—´å¢å¤§ç„¶åç¼©å°ï¼‰
        const progress = 1 - (explosion.timer / explosion.duration);
        explosion.radius = explosion.maxRadius * Math.sin(progress * Math.PI);
        
        // æ›´æ–°ç²’å­
        if (explosion.particles) {
            for (let j = explosion.particles.length - 1; j >= 0; j--) {
                const particle = explosion.particles[j];
                particle.x += particle.vx;
                particle.y += particle.vy;
                particle.life--;
                particle.vx *= 0.98; // ç²’å­å‡é€Ÿ
                particle.vy *= 0.98;
                
                if (particle.life <= 0) {
                    explosion.particles.splice(j, 1);
                }
            }
        }
        
        // å¦‚æœè®¡æ—¶å™¨ç»“æŸï¼Œç§»é™¤çˆ†ç‚¸æ•ˆæœ
        if (explosion.timer <= 0) {
            // å¦‚æœçˆ†ç‚¸æœ‰ä¼¤å®³ï¼Œåˆ™å¯¹æ•Œäººå’ŒBossé€ æˆä¼¤å®³
            if (explosion.damage > 0) {
                // å¯¹æ•Œäººé€ æˆä¼¤å®³
                enemies.forEach(enemy => {
                    if (!enemy.isDead) {
                        const dx = enemy.x + enemy.width / 2 - explosion.x;
                        const dy = enemy.y + enemy.height / 2 - explosion.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        if (distance <= explosion.maxRadius) {
                            enemy.health -= explosion.damage;
                            if (enemy.health <= 0) {
                                enemy.isDead = true;
                            }
                        }
                    }
                });

                // å¯¹Bossé€ æˆä¼¤å®³
                if (boss && !boss.isDead) {
                    const dx = boss.x + boss.width / 2 - explosion.x;
                    const dy = boss.y + boss.height / 2 - explosion.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance <= explosion.maxRadius) {
                        boss.health -= explosion.damage;
                        if (boss.health <= 0) {
                            boss.isDead = true;
                        }
                    }
                }
            }
            explosions.splice(i, 1);
        }
    }
}

// æ›´æ–°å…¬å…±çˆ†ç‚¸æ•ˆæœï¼ˆownerä¸ºnullçš„çˆ†ç‚¸ï¼‰
function updatePublicExplosions() {
    for (let i = explosions.length - 1; i >= 0; i--) {
        const explosion = explosions[i];
        // åªå¤„ç†å…¬å…±çˆ†ç‚¸ï¼ˆownerä¸ºnullï¼‰
        if (explosion.owner !== null) continue;
        
        // æ›´æ–°è®¡æ—¶å™¨
        explosion.timer--;
        
        // è®¡ç®—å½“å‰åŠå¾„ï¼ˆéšæ—¶é—´å¢å¤§ç„¶åç¼©å°ï¼‰
        const progress = 1 - (explosion.timer / explosion.duration);
        explosion.radius = explosion.maxRadius * Math.sin(progress * Math.PI);
        
        // æ›´æ–°ç²’å­
        if (explosion.particles) {
            for (let j = explosion.particles.length - 1; j >= 0; j--) {
                const particle = explosion.particles[j];
                particle.x += particle.vx;
                particle.y += particle.vy;
                particle.life--;
                particle.vx *= 0.98; // ç²’å­å‡é€Ÿ
                particle.vy *= 0.98;
                
                if (particle.life <= 0) {
                    explosion.particles.splice(j, 1);
                }
            }
        }
        
        // å¦‚æœè®¡æ—¶å™¨ç»“æŸï¼Œç§»é™¤çˆ†ç‚¸æ•ˆæœ
        if (explosion.timer <= 0) {
            explosions.splice(i, 1);
        }
    }
}

// ç»˜åˆ¶çˆ†ç‚¸æ•ˆæœ
function drawExplosions(p) {
    explosions.forEach(explosion => {
        if (explosion.owner !== p && explosion.owner !== null) return;
        
        // è®¡ç®—å½“å‰é¢œè‰²ï¼ˆåŸºäºå‰©ä½™æ—¶é—´ï¼‰
        const colorIndex = Math.floor((1 - explosion.timer / explosion.duration) * explosion.colors.length);
        const color = explosion.colors[Math.min(colorIndex, explosion.colors.length - 1)];
        const alpha = explosion.timer / explosion.duration;
        
        // ç»˜åˆ¶ä¸»çˆ†ç‚¸åœ†å½¢ï¼ˆå¢å¼ºæ•ˆæœï¼‰
        ctx.save();
        ctx.shadowColor = color;
        ctx.shadowBlur = 20;
        ctx.beginPath();
        ctx.arc(explosion.x, explosion.y, explosion.radius, 0, Math.PI * 2);
        ctx.fillStyle = color;
        ctx.globalAlpha = alpha * 0.8;
        ctx.fill();
        
        // ç»˜åˆ¶å†…æ ¸
        ctx.shadowBlur = 10;
        ctx.beginPath();
        ctx.arc(explosion.x, explosion.y, explosion.radius * 0.6, 0, Math.PI * 2);
        ctx.fillStyle = '#ffffff';
        ctx.globalAlpha = alpha;
        ctx.fill();
        
        // ç»˜åˆ¶ç²’å­
        if (explosion.particles) {
            explosion.particles.forEach(particle => {
                const particleAlpha = particle.life / particle.maxLife;
                ctx.shadowBlur = 5;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.globalAlpha = particleAlpha * 0.7;
                ctx.fill();
            });
        }
        
        ctx.restore();
    });
}

// æ›´æ–°æ•Œäººç”Ÿæˆé€»è¾‘
// æ£€æŸ¥Bossç”Ÿæˆ
function checkBossSpawn() {
    if (boss) return; // å¦‚æœBosså·²ç»å­˜åœ¨ï¼Œåˆ™ä¸ç”Ÿæˆæ–°çš„Boss

    const currentTime = Date.now();
    const elapsedTime = currentTime - gameStartTime;

    // æ¸¸æˆå¼€å§‹30ç§’åï¼Œæ¯30ç§’æ£€æŸ¥ä¸€æ¬¡Bossç”Ÿæˆ
    // ç¬¬ä¸€æ¬¡æ£€æŸ¥ï¼šæ¸¸æˆå¼€å§‹30ç§’å
    // åç»­æ£€æŸ¥ï¼šè·ç¦»ä¸Šæ¬¡æ£€æŸ¥30ç§’å
    if (elapsedTime >= BOSS_SPAWN_TIME && 
        (lastBossSpawnCheckTime === 0 || currentTime - lastBossSpawnCheckTime >= BOSS_SPAWN_TIME)) {
        lastBossSpawnCheckTime = currentTime;
        if (Math.random() < BOSS_SPAWN_CHANCE) {
            // ç”ŸæˆBoss
            boss = {
                x: canvas.width / 2 - 50, // åˆå§‹ä½ç½®åœ¨ç”»å¸ƒä¸­å¤®
                y: canvas.height / 2 - 50,
                width: 100,
                height: 100,
                color: 'purple',
                health: BOSS_MAX_HEALTH,
                maxHealth: BOSS_MAX_HEALTH,
                speed: BOSS_SPEED,
                isDead: false,
                lastSkillTime: 0, // ä¸Šæ¬¡é‡Šæ”¾æŠ€èƒ½æ—¶é—´
                bullets: [], // Bosså‘å°„çš„å­å¼¹
                draw: function() {
                    ctx.fillStyle = this.color;
                    ctx.fillRect(this.x, this.y, this.width, this.height);

                    // ç»˜åˆ¶è¡€æ¡
                    const healthBarWidth = this.width;
                    const healthBarHeight = 10;
                    const healthBarX = this.x;
                    const healthBarY = this.y - 15;
                    ctx.fillStyle = 'gray';
                    ctx.fillRect(healthBarX, healthBarY, healthBarWidth, healthBarHeight);
                    ctx.fillStyle = 'red';
                    ctx.fillRect(healthBarX, healthBarY, healthBarWidth * (this.health / this.maxHealth), healthBarHeight);
                },
                shootSkill: function() {
                    let waveCount = 0;
                    const shootInterval = setInterval(() => {
                        if (waveCount >= BOSS_BULLET_WAVES) {
                            clearInterval(shootInterval);
                            return;
                        }
                        const numBullets = BOSS_BULLET_COUNT;
                        const angleStep = (Math.PI * 2) / numBullets;
                        for (let i = 0; i < numBullets; i++) {
                            const angle = i * angleStep;
                            this.bullets.push({
                                x: this.x + this.width / 2,
                                y: this.y + this.height / 2,
                                vx: Math.cos(angle) * BOSS_BULLET_SPEED,
                                vy: Math.sin(angle) * BOSS_BULLET_SPEED,
                                radius: 8,
                                color: 'orange'
                            });
                        }
                        waveCount++;
                    }, 100); // æ¯100æ¯«ç§’å‘å°„ä¸€æ³¢
                }
            };
            // æ¸…é™¤æ‰€æœ‰å°æ€ª
            enemies = [];
        }
    }
}

// æ›´æ–°æ•Œäººç”Ÿæˆé€»è¾‘
function updateEnemySpawns() {
    // å¦‚æœBosså­˜åœ¨ï¼Œåˆ™ä¸ç”Ÿæˆå…¶ä»–æ•Œäºº
    if (boss && !boss.isDead) {
        return;
    }
    
    const currentTime = Date.now();

    // ç”Ÿæˆç´«è‰²æ•Œäºº
    if (currentTime - lastPurpleEnemySpawnTime >= PURPLE_ENEMY_SPAWN_INTERVAL) {
        if (Math.random() < PURPLE_ENEMY_SPAWN_CHANCE) {
            generateEnemy('purple');
        }
        lastPurpleEnemySpawnTime = currentTime;
    }

    // ç”Ÿæˆçº¢è‰²æ•Œäºº
    if (currentTime - lastRedEnemySpawnTime >= RED_ENEMY_SPAWN_INTERVAL) {
        if (Math.random() < RED_ENEMY_SPAWN_CHANCE) {
            generateEnemy('red');
        }
        lastRedEnemySpawnTime = currentTime;
    }
}

// æ¸¸æˆå¾ªç¯
function gameLoop() {
    // æ¸…ç©ºç”»å¸ƒ
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (gameRunning) {
        // æ›´æ–°æ¸¸æˆçŠ¶æ€
        updatePlayerPosition(player);
        if (player2) {
            updatePlayerPosition(player2);
        }
        
        // æ£€æŸ¥ç©å®¶å‡é€ŸçŠ¶æ€æ¢å¤
        const currentTime = Date.now();
        if (player.slowedByBoss && currentTime >= player.slowEndTime) {
            player.speed = player.originalSpeed;
            player.slowedByBoss = false;
        }
        if (player2 && player2.slowedByBoss && currentTime >= player2.slowEndTime) {
            player2.speed = player2.originalSpeed;
            player2.slowedByBoss = false;
        }
        
        updateEnemies();
        updatePurpleEnemyBullets(); // æ›´æ–°ç´«è‰²æ•Œäººå­å¼¹
        updateRedEnemyBullets(); // æ›´æ–°çº¢è‰²æ•Œäººå­å¼¹
        updateMines();
        
        // å¤„ç†åœ°å½¢æ•ˆæœ
        handleTerrainEffects();

        // å¤„ç†æ•ŒäººæŒç»­æ‰£è¡€
        enemies.forEach(enemy => {
            if (enemy.isBleeding && !enemy.isDead) {
                const currentTime = Date.now();
                if (currentTime - enemy.lastBleedTime >= enemy.bleedInterval) {
                    if (enemy.health > enemy.maxHealth * 0.5) {
                        enemy.health -= enemy.bleedDamage;
                        enemy.lastBleedTime = currentTime;
                    } else {
                        enemy.isBleeding = false; // è¡€é‡ä½äº50%æ—¶åœæ­¢æµè¡€
                    }
                    if (enemy.health <= 0) {
                        enemy.isDead = true;
                        enemy.isBleeding = false; // æ•Œäººæ­»äº¡ååœæ­¢æµè¡€
                    }
                }
            }
        });

    updateRotateShootStatus(player);
    if (player2) {
        updateRotateShootStatus(player2);
    }
    updateBullets(player);
    if (player2) {
        updateBullets(player2);
    }
    updateGrenades(player);
    updateExplosions(player);
    if (player2) {
        updateGrenades(player2);
        updateExplosions(player2);
    }
    updatePublicExplosions(); // æ›´æ–°å…¬å…±çˆ†ç‚¸æ•ˆæœ
    // åªåœ¨å†³èµ›åœˆæœªæ¿€æ´»æ—¶ç”Ÿæˆæ•Œäººå’ŒBoss
    if (!finalCircleActive) {
        updateEnemySpawns(); // æ›´æ–°æ•Œäººç”Ÿæˆé€»è¾‘
        checkBossSpawn(); // æ£€æŸ¥Bossç”Ÿæˆ
    }
    if (boss) {
        updateBoss(); // æ›´æ–°BossçŠ¶æ€
        boss.draw(); // ç»˜åˆ¶Boss
    }
    attackEnemies();
    attackPlayers(); // æ£€æµ‹ç©å®¶é—´æ”»å‡»
    
    // æ›´æ–°å†³èµ›åœˆ
    if (finalCircleActive) {
        updateFinalCircle();
    }
    
    // æ£€æŸ¥ç©å®¶PVPç¢°æ’ï¼ˆä»…åœ¨å†³èµ›åœˆæ¿€æ´»æ—¶ï¼‰
    if (finalCircleActive && player2) {
        checkPlayerPVP();
    }
    

        
        // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸï¼ˆæ‰€æœ‰æ•Œäººéƒ½è¢«å‡»è´¥ï¼‰
        if (enemies.every(enemy => enemy.isDead) && (!boss || boss.isDead)) {
            // å•äººæ¨¡å¼ç›´æ¥ç»“æŸæ¸¸æˆ
            if (!player2) {
                gameRunning = false;
                gameWinner = 'ä½ å­˜æ´»ä¸‹æ¥äº†ï¼';
                // åœæ­¢æ¸¸æˆéŸ³ä¹
                const gameMusic = document.getElementById('gameMusic');
                if (gameMusic) {
                    gameMusic.pause();
                }
                // æ’­æ”¾å¤§å…éŸ³ä¹
                const bgMusic = document.getElementById('backgroundMusic');
                if (bgMusic) {
                    bgMusic.play();
                }
            } else {
                // åŒäººæ¨¡å¼å¯åŠ¨å†³èµ›åœˆ
                if (!finalCircleActive && !finalBattleStarted) {
                    startFinalCircle();
                }
            }
        }
        
        // æ£€æŸ¥åŒäººæ¨¡å¼ä¸‹çš„è·èƒœæ¡ä»¶
        if (player2) {
            if (player.health <= 0 && player2.health > 0) {
                gameRunning = false;
                gameWinner = "ç©å®¶2";
                console.log("ç©å®¶1æ­»äº¡ï¼Œç©å®¶2è·èƒœï¼");
            } else if (player2.health <= 0 && player.health > 0) {
                gameRunning = false;
                gameWinner = "ç©å®¶1";
                console.log("ç©å®¶2æ­»äº¡ï¼Œç©å®¶1è·èƒœï¼");
            } else if (player.health <= 0 && player2.health <= 0) {
                gameRunning = false;
                gameWinner = "å¹³å±€";
                console.log("åŒæ–¹åŒæ—¶æ­»äº¡ï¼Œå¹³å±€ï¼");
            }
        } else {
            // å•äººæ¨¡å¼ä¸‹ç©å®¶æ­»äº¡
            if (player.health <= 0) {
                gameRunning = false;
                gameWinner = "ä½ è¢«å¹²æ‰äº†ï¼";
                console.log("ç©å®¶æ­»äº¡ï¼Œæ¸¸æˆç»“æŸï¼");
                onGameEnd(); // æ¸¸æˆç»“æŸæ—¶æ˜¾ç¤ºé‚®ç®±
            }
        }
    }
    
    // ç»˜åˆ¶æ¸¸æˆå…ƒç´ 
    drawTerrainAreas(); // ç»˜åˆ¶åœ°å½¢åŒºåŸŸ
    drawPlayer(player);
    drawPlayerBubbles(player, 'player1'); // ç»˜åˆ¶ç©å®¶1æ°”æ³¡
    if (player2) {
        drawPlayer(player2);
        drawPlayerBubbles(player2, 'player2'); // ç»˜åˆ¶ç©å®¶2æ°”æ³¡
    }
    drawEnemies();
    drawEnemyStatusIcons(); // ç»˜åˆ¶æ•ŒäººçŠ¶æ€å›¾æ ‡
    drawMines();
    drawBullets();
    drawGrenades(player);
    if (player2) {
        drawGrenades(player2);
    }
    drawExplosions(player); // ç»˜åˆ¶çˆ†ç‚¸æ•ˆæœ
    if (player2) {
        drawExplosions(player2);
    }
    drawGameStatus();
    
    // ç»˜åˆ¶å†³èµ›åœˆ
    if (finalCircleActive) {
        drawFinalCircle();
    }
    
    // ç»˜åˆ¶è·èƒœä¿¡æ¯
    if (gameWinner) {
        drawVictoryMessage();
    }
    
    // å½“ç©å®¶è¡€é‡ä½äºä¸‰åˆ†ä¹‹ä¸€æ—¶ç»˜åˆ¶çº¢è‰²å…‰æ™•
    if (player.health < player.maxHealth / 3) {
        ctx.save();
        ctx.globalAlpha = 0.3;
        ctx.fillStyle = 'red';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.restore();
    }
    
    // ç»§ç»­ä¸‹ä¸€å¸§
    requestAnimationFrame(gameLoop);
}

// æ”¾ç½®åœ°é›·
function placeMine() {
    const currentTime = Date.now();
    
    // æ£€æŸ¥æ˜¯å¦åœ¨å†·å´ä¸­
    if (!player.canPlaceMine) {
        // è®¡ç®—å‰©ä½™å†·å´æ—¶é—´
        const remainingCooldown = Math.ceil((player.lastMinePlaced + MINE_COOLDOWN - currentTime) / 1000);
        
        // æ˜¾ç¤ºå†·å´æç¤º
        showCooldownMessage('åœ°é›·', remainingCooldown);
        return;
    }
    
    // åˆ›å»ºæ–°åœ°é›·
    const mine = {
        x: player.x + player.width / 2 - 15, // å±…ä¸­æ”¾ç½®
        y: player.y + player.height / 2 - 15,
        width: 30,
        height: 30,
        placedTime: currentTime,
        explodeTime: currentTime + 3000, // 3ç§’åçˆ†ç‚¸
        hasExploded: false,
        explosionTimer: 0,
        isExploding: false,
        damageApplied: false // æ–°å¢å±æ€§ï¼Œæ ‡è®°ä¼¤å®³æ˜¯å¦å·²åº”ç”¨
    };
    
    // æ·»åŠ åˆ°åœ°é›·æ•°ç»„
    mines.push(mine);
    
    // è®¾ç½®å†·å´
    player.canPlaceMine = false;
    player.lastMinePlaced = currentTime;
    
    // è®¾ç½®å†·å´ç»“æŸåçš„å›è°ƒ
    setTimeout(() => {
        player.canPlaceMine = true;
    }, MINE_COOLDOWN);
}

// æ›´æ–°æ‰‹é›·çŠ¶æ€
function updateGrenades(p) {
    const currentTime = Date.now();

    for (let i = grenades.length - 1; i >= 0; i--) {
        const grenade = grenades[i];
        // åªå¤„ç†å±äºå½“å‰ç©å®¶çš„æ‰‹é›·
        if (grenade.owner !== p) continue;

        // è®¡ç®—æ‰‹é›·é£è¡Œè¿›åº¦ (0.0 åˆ° 1.0)
        const progress = (currentTime - grenade.startTime) / grenade.flightTime;

        if (progress < 1) {
            // æŠ›ç‰©çº¿è¿åŠ¨
            // ä½¿ç”¨äºŒæ¬¡è´å¡å°”æ›²çº¿æ¨¡æ‹ŸæŠ›ç‰©çº¿
            const startX = grenade.x;
            const startY = grenade.y;
            const endX = grenade.targetX;
            const endY = grenade.targetY;

            // æ§åˆ¶ç‚¹ï¼Œç”¨äºæ¨¡æ‹ŸæŠ›ç‰©çº¿çš„é«˜åº¦
            const controlX = (startX + endX) / 2;
            // æ ¹æ®æ°´å¹³è·ç¦»è°ƒæ•´æŠ›ç‰©çº¿é¡¶ç‚¹é«˜åº¦ï¼Œè·ç¦»è¶Šè¿œï¼ŒæŠ›å¾—è¶Šé«˜
            const distanceX = Math.abs(endX - startX);
            const distanceY = Math.abs(endY - startY);
            const maxDistance = Math.max(distanceX, distanceY);
            // è°ƒæ•´æŠ›ç‰©çº¿é¡¶ç‚¹é«˜åº¦ï¼Œä½¿å…¶æ›´åˆç†åœ°è½åœ¨ç›®æ ‡ç‚¹
            const controlY = (startY + endY) / 2 - Math.max(100, maxDistance / 4);

            grenade.currentX = (1 - progress) * (1 - progress) * startX +
                               2 * (1 - progress) * progress * controlX +
                               progress * progress * endX;
            grenade.currentY = (1 - progress) * (1 - progress) * startY +
                               2 * (1 - progress) * progress * controlY +
                               progress * progress * endY;
        } else {
            // åˆ°è¾¾ç›®æ ‡ç‚¹ï¼Œè§¦å‘çˆ†ç‚¸
            if (!grenade.hasExploded) {
                createExplosion(grenade.targetX, grenade.targetY, grenade.explosionRadius, grenade.damage, p);
                grenade.hasExploded = true;
            }
            // çˆ†ç‚¸åç§»é™¤æ‰‹é›·
            grenades.splice(i, 1);
        }
    }
}



// æ›´æ–°åœ°é›·çŠ¶æ€
function updateMines() 
{
    const currentTime = Date.now();
    
    for (let i = mines.length - 1; i >= 0; i--) {
        const mine = mines[i];
        // æ£€æŸ¥æ˜¯å¦å·²çˆ†ç‚¸
        // æ£€æŸ¥æ˜¯å¦ä¸æ•Œäººç¢°æ’
        for (let j = 0; j < enemies.length; j++) {
            const enemy = enemies[j];
            if (!enemy.isDead && checkCollision(mine, enemy) && !mine.hasExploded) {
                // è®¾ç½®0.5ç§’åçˆ†ç‚¸
                mine.explodeTime = currentTime + 500;
                mine.hasExploded = true;
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸Bossç¢°æ’
        if (boss && !boss.isDead && checkCollision(mine, boss) && !mine.hasExploded) {
            // è®¾ç½®0.5ç§’åçˆ†ç‚¸
            mine.explodeTime = currentTime + 500;
            mine.hasExploded = true;
        }
        
        // æ£€æŸ¥åœ°é›·æ˜¯å¦å·²è§¦å‘çˆ†ç‚¸ï¼Œçˆ†ç‚¸æ—¶é—´å·²åˆ°ï¼Œä¸”ä¼¤å®³å°šæœªåº”ç”¨
        if (mine.hasExploded && currentTime >= mine.explodeTime && !mine.damageApplied) {
            explodeMine(mine); // åº”ç”¨ä¼¤å®³
            mine.damageApplied = true; // æ ‡è®°ä¼¤å®³å·²åº”ç”¨

            mine.isExploding = true; // è¿›å…¥çˆ†ç‚¸åŠ¨ç”»çŠ¶æ€
            mine.explosionTimer = 20; // çˆ†ç‚¸åŠ¨ç”»æŒç»­æ—¶é—´
        }
        
        // æ›´æ–°çˆ†ç‚¸åŠ¨ç”»
        if (mine.isExploding) {
            mine.explosionTimer--;
            // 0.1ç§’åï¼ˆå³çˆ†ç‚¸åŠ¨ç”»å¼€å§‹å6å¸§ï¼ŒexplosionTimerä»20å‡åˆ°14ï¼‰ç«‹å³æ¶ˆå¤±
            if (mine.explosionTimer <= 14) {
                mine.isExploding = false; // åŠ¨ç”»ç»“æŸ
                // ç«‹å³ç§»é™¤åœ°é›·
                const index = mines.indexOf(mine);
                if (index !== -1) {
                    mines.splice(index, 1);
                }
            }
        }
        
        // æ›´æ–°çˆ†ç‚¸åŠ¨ç”»
        if (mine.isExploding) {
            mine.explosionTimer--;
            if (mine.explosionTimer <= 0) {
                mine.isExploding = false; // Animation finished
            }
        }
    }
}

// åœ°é›·çˆ†ç‚¸é€»è¾‘
function explodeMine(mine) {
    // åˆ›å»ºçˆ†ç‚¸æ•ˆæœï¼ˆä¸æ‰‹é›·ç›¸åŒçš„çˆ†ç‚¸æ•ˆæœï¼‰
    createExplosion(mine.x + mine.width/2, mine.y + mine.height/2, MINE_EXPLOSION_RANGE, 0, player);
    
    // å¯¹æ•Œäººé€ æˆä¼¤å®³
    enemies.forEach(enemy => {
        if (!enemy.isDead) {
            // è®¡ç®—ä¸åœ°é›·çš„è·ç¦»
            const dx = enemy.x + enemy.width/2 - (mine.x + mine.width/2);
            const dy = enemy.y + enemy.height/2 - (mine.y + mine.height/2);
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            // å¦‚æœåœ¨çˆ†ç‚¸èŒƒå›´å†…
            if (distance <= MINE_EXPLOSION_RANGE) {
                enemy.health -= MINE_DAMAGE;
                
                // æ•Œäººæ­»äº¡æ£€æŸ¥
                if (enemy.health <= 0) {
                    enemy.isDead = true;
                }
            }
        }
    });
    
    // å¯¹Bossé€ æˆä¼¤å®³
    if (boss && !boss.isDead) {
        // è®¡ç®—ä¸åœ°é›·çš„è·ç¦»
        const dx = boss.x + boss.width/2 - (mine.x + mine.width/2);
        const dy = boss.y + boss.height/2 - (mine.y + mine.height/2);
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        // å¦‚æœåœ¨çˆ†ç‚¸èŒƒå›´å†…
        if (distance <= MINE_EXPLOSION_RANGE) {
            boss.health -= MINE_DAMAGE;
            
            // Bossæ­»äº¡æ£€æŸ¥
            if (boss.health <= 0) {
                boss.isDead = true;
                gameRunning = false; // Bossæ­»äº¡ï¼Œæ¸¸æˆç»“æŸ
                boss = null; // æ¸…é™¤Bosså¯¹è±¡
                onGameEnd(); // æ¸¸æˆç»“æŸæ—¶æ˜¾ç¤ºé‚®ç®±
            }
        }
    }
}

// ç»˜åˆ¶æ‰‹é›·
function drawGrenades(p) {
    grenades.forEach(grenade => {
        if (grenade.owner !== p) return;
        ctx.beginPath();
        ctx.arc(grenade.currentX, grenade.currentY, grenade.radius, 0, Math.PI * 2);
        ctx.fillStyle = grenade.color;
        ctx.fill();
        ctx.closePath();
    });
}

// ç»˜åˆ¶åœ°é›·
function drawMines() {
    mines.forEach(mine => {
        // ç»˜åˆ¶çˆ†ç‚¸æ•ˆæœ (å¦‚æœæ­£åœ¨çˆ†ç‚¸) - æ©™è‰²æ¸å˜åœ†å½¢
        if (mine.isExploding) {
            const gradient = ctx.createRadialGradient(mine.x + mine.width / 2, mine.y + mine.height / 2, 0, mine.x + mine.width / 2, mine.y + mine.height / 2, MINE_EXPLOSION_RANGE);
            gradient.addColorStop(0, 'rgba(255, 165, 0, 1)'); // æ©™è‰²ï¼Œå®Œå…¨ä¸é€æ˜
            gradient.addColorStop(1, 'rgba(255, 165, 0, 0)'); // æ©™è‰²ï¼Œå®Œå…¨é€æ˜
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(mine.x + mine.width / 2, mine.y + mine.height / 2, MINE_EXPLOSION_RANGE, 0, Math.PI * 2);
            ctx.fill();


        } else {
            // æ ¹æ®åœ°é›·æ‰€æœ‰è€…è®¾ç½®é¢œè‰²
            let mineColor, borderColor, dotColor;
            if (mine.owner === player) {
                // ç©å®¶ä¸€çš„åœ°é›· - ç´«è‰²ï¼Œé«˜å¯è§åº¦
                mineColor = 'rgba(128, 0, 128, 0.9)'; // ç´«è‰²ï¼Œå‡ ä¹ä¸é€æ˜
                borderColor = 'rgba(75, 0, 130, 1.0)'; // æ·±ç´«è‰²è¾¹æ¡†ï¼Œå®Œå…¨ä¸é€æ˜
                dotColor = 'rgba(255, 0, 255, 1.0)'; // äº®ç´«è‰²ç‚¹ï¼Œå®Œå…¨ä¸é€æ˜
            } else {
                // ç©å®¶äºŒçš„åœ°é›· - æ£•è‰²ï¼Œé«˜å¯è§åº¦
                mineColor = 'rgba(139, 69, 19, 0.9)'; // æ£•è‰²ï¼Œå‡ ä¹ä¸é€æ˜
                borderColor = 'rgba(101, 67, 33, 1.0)'; // æ£•è‰²è¾¹æ¡†ï¼Œå®Œå…¨ä¸é€æ˜
                dotColor = 'rgba(205, 133, 63, 1.0)'; // äº®æ£•è‰²ç‚¹ï¼Œå®Œå…¨ä¸é€æ˜
            }
            
            // ç»˜åˆ¶åœ°é›· - æ›´éšè”½çš„æ˜¾ç¤º
            ctx.fillStyle = mineColor;
            ctx.fillRect(mine.x + 5, mine.y + 5, mine.width - 10, mine.height - 10); // æ›´å°çš„å°ºå¯¸
            
            // ç»˜åˆ¶å¾®å¼±çš„è¾¹æ¡†
            ctx.strokeStyle = borderColor;
            ctx.lineWidth = 1;
            ctx.strokeRect(mine.x + 5, mine.y + 5, mine.width - 10, mine.height - 10);
            
            // ç»˜åˆ¶å°ç‚¹ä½œä¸ºåœ°é›·æ ‡è¯†
            ctx.fillStyle = dotColor;
            ctx.beginPath();
            ctx.arc(mine.x + mine.width/2, mine.y + mine.height/2, 3, 0, Math.PI * 2);
            ctx.fill();
            
            // å¦‚æœåœ°é›·å·²è¢«è§¦å‘ï¼Œæ˜¾ç¤ºå€’è®¡æ—¶
            if (mine.hasExploded) {
                const remainingTime = Math.max(0, Math.ceil((mine.explodeTime - Date.now()) / 1000));
                ctx.fillStyle = 'rgba(255, 0, 0, 0.8)';
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(remainingTime.toString(), mine.x + mine.width/2, mine.y - 5);
            }
        }
    });
}

// æ˜¾ç¤ºå†·å´æç¤º
function showCooldownMessage(skillName, remainingTime) {
    // ä»…åœ¨å±å¹•å·¦ä¸Šè§’æ˜¾ç¤ºå†·å´æç¤ºï¼Œä¸è¦†ç›–æ•´ä¸ªå±å¹•
    ctx.fillStyle = 'white';
    ctx.font = '16px Arial';
    ctx.textAlign = 'left';
    ctx.fillText(`${skillName}å†·å´ä¸­ (${remainingTime}ç§’)`, 10, 100);
}

// å¯åŠ¨å†³èµ›åœˆ
function startFinalCircle() {
    finalCircleActive = true;
    // åˆå§‹å†³èµ›åœˆè¦†ç›–æ•´ä¸ªç”»å¸ƒï¼Œç•™å‡ºä¸€äº›è¾¹è·
    finalCircleRadius = Math.min(canvas.width, canvas.height) * 0.8;
    finalCircleCenterX = canvas.width / 2;
    finalCircleCenterY = canvas.height / 2;
    finalCircleStartTime = Date.now();
    lastCircleDamageTime = Date.now();
    
    // æ˜¾ç¤ºå†³èµ›åœˆå¼€å§‹æç¤º
    console.log("å†³èµ›åœˆå¼€å§‹ï¼åˆå§‹åŠå¾„:", finalCircleRadius);
}

// æ›´æ–°å†³èµ›åœˆ
function updateFinalCircle() {
    const currentTime = Date.now();
    const elapsedTime = currentTime - finalCircleStartTime;
    
    // ç¼©å°å†³èµ›åœˆ
    if (finalCircleRadius > FINAL_CIRCLE_MIN_RADIUS) {
        finalCircleRadius -= FINAL_CIRCLE_SHRINK_SPEED;
        if (finalCircleRadius < FINAL_CIRCLE_MIN_RADIUS) {
            finalCircleRadius = FINAL_CIRCLE_MIN_RADIUS;
        }
    }
    
    // æ£€æŸ¥ç©å®¶æ˜¯å¦åœ¨å†³èµ›åœˆå¤–å¹¶é€ æˆä¼¤å®³
    if (currentTime - lastCircleDamageTime >= FINAL_CIRCLE_DAMAGE_INTERVAL) {
        checkPlayerInCircle(player);
        if (player2) {
            checkPlayerInCircle(player2);
        }
        lastCircleDamageTime = currentTime;
    }
}

// æ£€æŸ¥ç©å®¶æ˜¯å¦åœ¨å†³èµ›åœˆå†…
function checkPlayerInCircle(p) {
    const playerCenterX = p.x + p.width / 2;
    const playerCenterY = p.y + p.height / 2;
    const distanceFromCenter = Math.sqrt(
        Math.pow(playerCenterX - finalCircleCenterX, 2) + 
        Math.pow(playerCenterY - finalCircleCenterY, 2)
    );
    
    // å¦‚æœç©å®¶åœ¨å†³èµ›åœˆå¤–ï¼Œé€ æˆä¼¤å®³
    if (distanceFromCenter > finalCircleRadius) {
        p.health -= FINAL_CIRCLE_DAMAGE;
        if (p.health <= 0) {
            p.health = 0;
            gameRunning = false; // ç«‹å³åœæ­¢æ¸¸æˆ
            // æ ¹æ®æ¸¸æˆæ¨¡å¼åˆ¤æ–­è·èƒœè€…
            if (currentGameMode === 'single') {
                gameWinner = "ä½ è¢«å¹²æ‰äº†ï¼";
                console.log("ç©å®¶åœ¨å†³èµ›åœˆå¤–æ­»äº¡ï¼");
            } else {
                // åŒäººæ¨¡å¼
                if (p === player) {
                    gameWinner = "ç©å®¶2";
                    console.log("ç©å®¶1åœ¨å†³èµ›åœˆå¤–æ­»äº¡ï¼Œç©å®¶2è·èƒœï¼");
                } else {
                    gameWinner = "ç©å®¶1";
                    console.log("ç©å®¶2åœ¨å†³èµ›åœˆå¤–æ­»äº¡ï¼Œç©å®¶1è·èƒœï¼");
                }
            }
        }
    }
}

// æ£€æŸ¥ç©å®¶PVPç¢°æ’
function checkPlayerPVP() {
    if (!player2 || player.health <= 0 || player2.health <= 0) return;
    
    // æ£€æŸ¥ç¢°æ’
    if (checkCollision(player, player2)) {
        if (!finalBattleStarted) {
            finalBattleStarted = true;
            console.log("è¿›å…¥å†³æˆ˜é˜¶æ®µï¼");
        }
        
        // åŒæ–¹æ‰£è¡€
        player.health -= PVP_DAMAGE;
        player2.health -= PVP_DAMAGE;
        
        // æ£€æŸ¥æ˜¯å¦æœ‰ç©å®¶æ­»äº¡ï¼ˆPVPåªåœ¨åŒäººæ¨¡å¼ä¸‹å‘ç”Ÿï¼‰
        if (player.health <= 0 && player2.health <= 0) {
            gameRunning = false;
            gameWinner = "å¹³å±€";
            console.log("åŒæ–¹åœ¨PVPä¸­åŒæ—¶æ­»äº¡ï¼Œå¹³å±€ï¼");
        } else if (player.health <= 0) {
            gameRunning = false;
            gameWinner = "ç©å®¶2";
            console.log("ç©å®¶1åœ¨PVPä¸­æ­»äº¡ï¼Œç©å®¶2è·èƒœï¼");
        } else if (player2.health <= 0) {
            gameRunning = false;
            gameWinner = "ç©å®¶1";
            console.log("ç©å®¶2åœ¨PVPä¸­æ­»äº¡ï¼Œç©å®¶1è·èƒœï¼");
        }
    }
}

// ç»˜åˆ¶å†³èµ›åœˆ
function drawFinalCircle() {
    // ç»˜åˆ¶å†³èµ›åœˆè¾¹ç•Œ
    ctx.save();
    ctx.strokeStyle = 'rgba(255, 0, 0, 0.8)';
    ctx.lineWidth = 5;
    ctx.setLineDash([10, 5]);
    ctx.beginPath();
    ctx.arc(finalCircleCenterX, finalCircleCenterY, finalCircleRadius, 0, Math.PI * 2);
    ctx.stroke();
    ctx.setLineDash([]);
    
    // ç»˜åˆ¶å†³èµ›åœˆå¤–çš„å±é™©åŒºåŸŸ
    ctx.globalAlpha = 0.3;
    ctx.fillStyle = 'red';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // æ¸…é™¤å†³èµ›åœˆå†…çš„åŒºåŸŸ
    ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath();
    ctx.arc(finalCircleCenterX, finalCircleCenterY, finalCircleRadius, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.globalCompositeOperation = 'source-over';
    ctx.restore();
    
    // æ˜¾ç¤ºå†³èµ›åœˆä¿¡æ¯
    ctx.fillStyle = 'white';
    ctx.font = 'bold 20px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('å†³èµ›åœˆ', canvas.width / 2, 50);
    
    // æ˜¾ç¤ºå†³èµ›åœˆåŠå¾„ä¿¡æ¯
    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
    ctx.font = '16px Arial';
    ctx.fillText(`å®‰å…¨åŒºåŠå¾„: ${Math.round(finalCircleRadius)}`, canvas.width / 2, 75);
    
    // è®¡ç®—ç¼©å°è¿›åº¦
    const initialRadius = Math.min(canvas.width, canvas.height) * 0.8;
    const progress = ((initialRadius - finalCircleRadius) / (initialRadius - FINAL_CIRCLE_MIN_RADIUS) * 100);
    if (progress < 100) {
        ctx.fillText(`ç¼©åœˆè¿›åº¦: ${Math.round(progress)}%`, canvas.width / 2, 95);
    }
    
    if (finalBattleStarted) {
        ctx.fillStyle = 'yellow';
        ctx.font = 'bold 24px Arial';
        ctx.fillText('å†³æˆ˜é˜¶æ®µï¼', canvas.width / 2, 125);
    }
}

// ç»˜åˆ¶è·èƒœä¿¡æ¯
function drawVictoryMessage() {
    ctx.save();
    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.fillStyle = 'gold';
    ctx.font = 'bold 48px Arial';
    ctx.textAlign = 'center';
    
    // æ ¹æ®æ¸¸æˆæ¨¡å¼å’ŒgameWinnerå†…å®¹æ˜¾ç¤ºä¸åŒä¿¡æ¯
    if (currentGameMode === 'single') {
        // å•äººæ¨¡å¼ï¼šç›´æ¥æ˜¾ç¤ºgameWinnerçš„å†…å®¹ï¼ˆå¦‚"ä½ å­˜æ´»ä¸‹æ¥äº†ï¼"æˆ–"ä½ è¢«å¹²æ‰äº†ï¼"ï¼‰
        ctx.fillText(gameWinner, canvas.width / 2, canvas.height / 2);
    } else {
        // åŒäººæ¨¡å¼ï¼šæ˜¾ç¤ºä¼ ç»Ÿçš„èƒœåˆ©ä¿¡æ¯
        if (gameWinner === "å¹³å±€") {
            ctx.fillText(gameWinner, canvas.width / 2, canvas.height / 2);
        } else {
            ctx.fillText(`${gameWinner}èƒœåˆ©ï¼`, canvas.width / 2, canvas.height / 2);
        }
    }
    
    ctx.fillStyle = 'white';
    ctx.font = '24px Arial';
    ctx.fillText('æŒ‰ESCé”®è¿”å›å¤§å…', canvas.width / 2, canvas.height / 2 + 60);
    ctx.restore();
}



// è¿”å›å¤§å…
function returnToLobby() {
    // åœæ­¢æ¸¸æˆéŸ³ä¹
    const gameMusic = document.getElementById('gameMusic');
    if (gameMusic) {
        gameMusic.pause();
        gameMusic.currentTime = 0;
    }
    
    // æ’­æ”¾å¤§å…éŸ³ä¹
    const bgMusic = document.getElementById('backgroundMusic');
    if (bgMusic) {
        bgMusic.play().catch(e => console.log("å¤§å…éŸ³ä¹æ’­æ”¾å¤±è´¥: ", e));
    }
    
    // é‡ç½®æ¸¸æˆçŠ¶æ€
    gameRunning = false;
    gameWinner = null;
    currentGameMode = 'single';
    
    // æ¸…ç©ºæ¸¸æˆå…ƒç´ 
    enemies = [];
    bullets = [];
    purpleEnemyBullets = [];
    explosions = [];
    grenades = [];
    mines = [];
    boss = null;
    bossSpawned = false;
    
    // é‡ç½®å†³èµ›åœˆç›¸å…³å˜é‡
    finalCircleActive = false;
    finalCircleRadius = 0;
    finalCircleCenterX = 0;
    finalCircleCenterY = 0;
    finalCircleStartTime = 0;
    finalBattleStarted = false;
    lastCircleDamageTime = 0;
    
    // é‡ç½®ç©å®¶
    player2 = null;
    
    // æ¢å¤å¤§å…èƒŒæ™¯
    document.body.style.backgroundColor = '';
    document.body.style.background = "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
    
    // æ˜¾ç¤ºæ¬¢è¿ç•Œé¢
    document.getElementById('welcomeScreen').style.display = 'flex';
    document.getElementById('gameCanvas').style.filter = 'blur(5px)';
    
    showSuggestionButton(); // æ˜¾ç¤ºå»ºè®®æŒ‰é’®
    
    console.log("è¿”å›å¤§å…ï¼");
}

// å»ºè®®åŠŸèƒ½ç›¸å…³ä»£ç 
let suggestionStorage = [];

// å¼€å‘è€…æ¨¡å¼ç›¸å…³å˜é‡
let isDeveloperMode = false;
let developerWebhookUrl = null;
let suggestionPollingInterval = null;
let lastCheckedTimestamp = Date.now();

// åˆå§‹åŒ–å»ºè®®åŠŸèƒ½
function initSuggestionFeature() {
    const suggestionButton = document.getElementById('suggestionButton');
    const suggestionModal = document.getElementById('suggestionModal');
    const suggestionTextarea = document.getElementById('suggestionTextarea');
    const submitSuggestionBtn = document.getElementById('submitSuggestionBtn');
    const cancelSuggestionBtn = document.getElementById('cancelSuggestionBtn');
    const suggestionNotification = document.getElementById('suggestionNotification');
    
    // ç‚¹å‡»å»ºè®®æŒ‰é’®æ‰“å¼€å¼¹çª—
    suggestionButton.addEventListener('click', function() {
        suggestionModal.style.display = 'block';
        suggestionTextarea.value = '';
        suggestionTextarea.focus();
    });
    
    // å–æ¶ˆæŒ‰é’®
    cancelSuggestionBtn.addEventListener('click', function() {
        suggestionModal.style.display = 'none';
    });
    
    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    suggestionModal.addEventListener('click', function(e) {
        if (e.target === suggestionModal) {
            suggestionModal.style.display = 'none';
        }
    });
    
    // æäº¤å»ºè®®
    submitSuggestionBtn.addEventListener('click', function() {
        const suggestionText = suggestionTextarea.value.trim();
        if (suggestionText === '') {
            console.log('è¯·è¾“å…¥å»ºè®®å†…å®¹ï¼');
            return;
        }
        
        // å­˜å‚¨å»ºè®®
        const suggestion = {
            id: Date.now(),
            content: suggestionText,
            timestamp: new Date().toLocaleString(),
            userId: currentUser ? currentUser.id : 'anonymous',
            userName: currentUser ? currentUser.name : 'åŒ¿åç”¨æˆ·'
        };
        suggestionStorage.push(suggestion);
        
        // æ¼”ç¤ºæ¨¡å¼ï¼šæ¨¡æ‹Ÿè·¨è®¾å¤‡å»ºè®®æ”¶é›† + çœŸå®å‘é€
        if (window.demoMode) {
            // æ·»åŠ å½“å‰å»ºè®®åˆ°æ¼”ç¤ºåˆ—è¡¨
            const currentDevice = navigator.userAgent.includes('Mobile') ? 'Mobile Device' : 'Desktop PC';
            const newSuggestion = {
                device: currentDevice,
                suggestion: suggestionText,
                time: new Date().toLocaleString()
            };
            window.demoSuggestions.push(newSuggestion);
            
            // æ˜¾ç¤ºè·¨è®¾å¤‡æ”¶é›†æ•ˆæœ
            console.log('\nğŸ‰ å»ºè®®å·²æ·»åŠ åˆ°è·¨è®¾å¤‡æ”¶é›†ç³»ç»Ÿï¼');
            console.log('\nğŸ“Š æ‰€æœ‰è®¾å¤‡çš„å»ºè®®æ±‡æ€»:');
            window.demoSuggestions.forEach((item, index) => {
                const isNew = index === window.demoSuggestions.length - 1;
                const prefix = isNew ? 'ğŸ†•' : '  ';
                console.log(`${prefix} ${index + 1}. [${item.device}] ${item.suggestion} (${item.time})`);
            });
            console.log('\nâœ¨ è¿™å°±æ˜¯è·¨è®¾å¤‡å»ºè®®æ”¶é›†çš„æ•ˆæœï¼ä¸åŒè®¾å¤‡çš„å»ºè®®éƒ½æ±‡æ€»åœ¨ä¸€èµ·ã€‚');
            
            // åŒæ—¶å‘é€åˆ°çœŸå®çš„webhookï¼ˆå¦‚æœé…ç½®äº†çš„è¯ï¼‰
            console.log('\nğŸŒ åŒæ—¶å‘é€åˆ°çœŸå®æœåŠ¡å™¨...');
            sendToWebhook(suggestionText);
        } else {
            // çœŸå®æ¨¡å¼ï¼šå®é™…å‘é€å»ºè®®
            
            // æ–¹æ³•1: å‘é€åˆ° Google Analytics (éœ€è¦é…ç½®çœŸå®çš„æµ‹é‡ID)
            if (typeof gtag !== 'undefined') {
                gtag('event', 'user_suggestion', {
                    'event_category': 'User Feedback',
                    'event_label': 'Game Suggestion',
                    'custom_parameter_1': suggestionText,
                    'custom_parameter_2': new Date().toISOString(),
                    'value': 1
                });
            }
            
            // æ–¹æ³•1: å‘é€åˆ°å…è´¹çš„åœ¨çº¿æ”¶é›†æœåŠ¡
            sendToWebhook(suggestionText);
            
            // æ–¹æ³•2: ç”Ÿæˆå¯å¤åˆ¶çš„å»ºè®®æ•°æ®
            generateCopyableData(suggestionText);
        }
        
        // ç«‹å³å°†å»ºè®®å­˜å‚¨åˆ°ç®¡ç†å‘˜é‚®ç®±
        addMessageToAdminMailbox(`æ”¶åˆ°æ–°å»ºè®®: ${suggestion.content}`, currentUser ? currentUser.name : 'åŒ¿åç”¨æˆ·');
        
        // æ˜¾ç¤ºé€šçŸ¥ç»™ç”¨æˆ·
        showSuggestionNotification(suggestion.content);
        
        // å…³é—­å¼¹çª—
        suggestionModal.style.display = 'none';
        
        // æ˜¾ç¤ºæˆåŠŸæç¤ºï¼ˆä»…åœ¨å¼€å‘è€…æ§åˆ¶å°æ˜¾ç¤ºï¼‰
        console.log('æ„Ÿè°¢æ‚¨çš„å»ºè®®ï¼å·²æˆåŠŸæäº¤å¹¶ä¿å­˜åˆ°é‚®ç®±ã€‚');
        
        // åœ¨æ§åˆ¶å°è¾“å‡ºå»ºè®®ç¡®è®¤
        console.log('æ‚¨çš„å»ºè®®å·²è®°å½•:', suggestion);
        console.log('å»ºè®®å·²å‘é€åˆ° Google Analytics å¹¶ä¿å­˜åˆ°ç®¡ç†å‘˜é‚®ç®±');
    });
    
    // ESCé”®å…³é—­å¼¹çª—
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && suggestionModal.style.display === 'block') {
            suggestionModal.style.display = 'none';
        }
    });
}

// æ—§çš„å»ºè®®é€šçŸ¥å‡½æ•°å·²è¢«æ–°çš„é‚®ç®±åŠŸèƒ½æ›¿ä»£

// åˆ‡æ¢å»ºè®®æ–‡æœ¬æ˜¾ç¤º
function toggleSuggestionText() {
    const preview = document.getElementById('suggestionPreview');
    const full = document.getElementById('suggestionFull');
    const btn = document.getElementById('showFullBtn');
    
    if (preview.style.display === 'none') {
        preview.style.display = 'inline';
        full.style.display = 'none';
        btn.textContent = 'æ˜¾ç¤ºå…¨æ–‡';
    } else {
        preview.style.display = 'none';
        full.style.display = 'inline';
        btn.textContent = 'æ”¶èµ·';
    }
}

// éšè—å»ºè®®é€šçŸ¥
function hideSuggestionNotification(shouldStoreToMailbox = false, message = '', userName = '') {
    const notification = document.getElementById('suggestionNotification');
    notification.className = '';
    
    // å¦‚æœéœ€è¦å­˜å‚¨åˆ°é‚®ç®±ä¸”æœ‰æ¶ˆæ¯å†…å®¹
    if (shouldStoreToMailbox && message) {
        addMessageToAdminMailbox(`æ”¶åˆ°æ–°å»ºè®®: ${message}`, userName);
    }
}

// åœ¨æ¸¸æˆå¼€å§‹æ—¶éšè—å»ºè®®æŒ‰é’®
function hideSuggestionButton() {
    document.getElementById('suggestionButton').style.display = 'none';
}

// æ˜¾ç¤ºå»ºè®®æŒ‰é’®ï¼ˆç°åœ¨ä¸€ç›´æ˜¾ç¤ºï¼‰
function showSuggestionButton() {
    document.getElementById('suggestionButton').style.display = 'flex';
}

// è®¾ç½® Google Analytics æµ‹é‡ ID çš„è¾…åŠ©å‡½æ•°
function setupGoogleAnalytics(measurementId) {
    if (!measurementId) {
        console.warn('è¯·æä¾›æœ‰æ•ˆçš„ Google Analytics æµ‹é‡ ID');
        return;
    }
    
    // æ›´æ–° gtag é…ç½®
    if (typeof gtag !== 'undefined') {
        gtag('config', measurementId);
        console.log('Google Analytics å·²é…ç½®ï¼Œæµ‹é‡ ID:', measurementId);
    } else {
        console.error('Google Analytics æœªæ­£ç¡®åŠ è½½');
    }
}

// æ£€æŸ¥ GA è®¾ç½®çŠ¶æ€
function checkGASetup() {
    const scripts = document.querySelectorAll('script[src*="googletagmanager"]');
    const hasGAScript = scripts.length > 0;
    const currentSrc = hasGAScript ? scripts[0].src : '';
    
    if (currentSrc.includes('GA_MEASUREMENT_ID')) {
        console.warn('âš ï¸ Google Analytics è®¾ç½®æé†’ï¼š');
        console.warn('1. è¯·è®¿é—® https://analytics.google.com/ åˆ›å»º GA4 å±æ€§');
        console.warn('2. è·å–æ‚¨çš„æµ‹é‡ IDï¼ˆæ ¼å¼ï¼šG-XXXXXXXXXXï¼‰');
        console.warn('3. åœ¨ä»£ç ä¸­å°† "GA_MEASUREMENT_ID" æ›¿æ¢ä¸ºæ‚¨çš„å®é™…æµ‹é‡ ID');
        console.warn('4. æˆ–è€…è°ƒç”¨ setupGoogleAnalytics("æ‚¨çš„æµ‹é‡ID") æ¥åŠ¨æ€è®¾ç½®');
        return false;
    }
    
    console.log('âœ… Google Analytics é…ç½®æ£€æŸ¥é€šè¿‡');
    return true;
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å»ºè®®åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    initSuggestionFeature();
    
    // æ˜¾ç¤ºé‚®ç®±å’Œå»ºè®®æŒ‰é’®ï¼ˆé™¤äº†æ¸¸æˆè¿›è¡Œä¸­ï¼‰
    showMailboxButton();
    showSuggestionButton();
    
    // è‡ªåŠ¨å¯ç”¨æ¼”ç¤ºæ¨¡å¼
    setTimeout(() => {
        enableDemoMode();
        console.log('\nğŸ® æ¸¸æˆå»ºè®®æ”¶é›†ç³»ç»Ÿå·²å¯åŠ¨');
        console.log('\nğŸ’¡ æ¼”ç¤ºæ¨¡å¼å·²è‡ªåŠ¨å¯ç”¨ï¼Œç°åœ¨æäº¤å»ºè®®å³å¯çœ‹åˆ°è·¨è®¾å¤‡é€šçŸ¥æ•ˆæœï¼');
        
        // æ£€æŸ¥è·¨è®¾å¤‡é€šä¿¡é…ç½®
        if (!window.webhookUrl) {
            console.log('\nğŸŒ è·¨è®¾å¤‡é€šä¿¡é…ç½®');
            console.log('ğŸ“‹ å½“å‰çŠ¶æ€: ä»…æœ¬åœ°æ¼”ç¤ºæ¨¡å¼');
            console.log('ğŸš€ å¯ç”¨çœŸå®è·¨è®¾å¤‡é€šä¿¡çš„æ­¥éª¤:');
            console.log('   1. è®¿é—®: https://webhook.site/');
            console.log('   2. å¤åˆ¶æ˜¾ç¤ºçš„URL');
            console.log('   3. è¿è¡Œ: setupWebhook("æ‚¨çš„URL")');
            console.log('ğŸ’¡ é…ç½®åï¼Œä¸åŒè®¾å¤‡çš„å»ºè®®å°†çœŸæ­£æ±‡èšåˆ°æ‚¨æŒ‡å®šçš„åœ°å€ï¼');
        } else {
            console.log('\nâœ… è·¨è®¾å¤‡é€šä¿¡å·²å¯ç”¨: ' + window.webhookUrl);
        }
        
        // éªŒè¯çŠ¶æ€
        setTimeout(() => {
            console.log('ğŸ” æœ€ç»ˆçŠ¶æ€æ£€æŸ¥: isDeveloperMode =', isDeveloperMode);
            console.log('ğŸ” æœ€ç»ˆçŠ¶æ€æ£€æŸ¥: window.demoMode =', window.demoMode);
        }, 500);
    }, 1000);
});

// æ–¹æ³•1: å‘é€åˆ°å…è´¹çš„åœ¨çº¿æ”¶é›†æœåŠ¡
function sendToWebhook(suggestionText, customWebhookUrl = null) {
    // ä½¿ç”¨è‡ªå®šä¹‰URLæˆ–é»˜è®¤é…ç½®çš„URL
    const webhookUrl = customWebhookUrl || window.webhookUrl;
    
    // æ£€æŸ¥æ˜¯å¦é…ç½®äº† webhook URL
    if (!webhookUrl) {
        console.log('â„¹ï¸ Webhook æœªé…ç½®ï¼Œè·³è¿‡åœ¨çº¿å‘é€');
        console.log('ğŸ’¡ é…ç½®æ–¹æ³•: setupWebhook("æ‚¨çš„URL")');
        return;
    }
    
    // ç”Ÿæˆæˆ–è·å–æŒä¹…çš„è®¾å¤‡ID
    if (!window.currentDeviceId) {
        window.currentDeviceId = 'device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        console.log('ğŸ”§ ç”Ÿæˆè®¾å¤‡ID:', window.currentDeviceId);
    }
    
    const data = {
        suggestion: suggestionText,
        timestamp: new Date().toISOString(),
        game: 'å¯¹æˆ˜æ¸¸æˆ',
        userAgent: navigator.userAgent,
        url: window.location.href,
        deviceId: window.currentDeviceId,
        userId: currentUser ? currentUser.id : 'anonymous',
        userName: currentUser ? currentUser.name : 'åŒ¿åç”¨æˆ·',
        // æ‰€æœ‰å»ºè®®éƒ½å‘é€ç»™ç®¡ç†å‘˜è´¦å·00000000
        targetUserId: '00000000',
        originalUserId: currentUser ? currentUser.id : 'anonymous',
        originalUserName: currentUser ? currentUser.name : 'åŒ¿åç”¨æˆ·'
    };
    
    // å‘é€åˆ°é…ç½®çš„ webhook URL
    fetch(webhookUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (response.ok) {
            console.log('âœ… å»ºè®®å·²å‘é€åˆ° Webhook:', webhookUrl);
            if (customWebhookUrl) {
                console.log('ğŸ“¡ å‘é€ç›®æ ‡: å¼€å‘è€…ç›‘å¬åœ°å€');
            }
        } else {
            console.log('âš ï¸ Webhook å“åº”å¼‚å¸¸ï¼Œä½†æ•°æ®å·²å‘é€');
        }
    })
    .catch(error => {
        console.log('âŒ Webhook å‘é€å¤±è´¥:', error.message);
        console.log('ğŸ’¡ è¯·æ£€æŸ¥ URL æ˜¯å¦æ­£ç¡®æˆ–ç½‘ç»œè¿æ¥');
    });
}

// æ–¹æ³•2: ç”Ÿæˆå¯å¤åˆ¶çš„å»ºè®®æ•°æ®
function generateCopyableData(suggestionText) {
    const data = {
        å»ºè®®å†…å®¹: suggestionText,
        æäº¤æ—¶é—´: new Date().toLocaleString(),
        æ¸¸æˆåç§°: 'å¯¹æˆ˜æ¸¸æˆ',
        ç”¨æˆ·ID: 'user_' + Date.now()
    };
    
    const formattedData = JSON.stringify(data, null, 2);
    
    // å°è¯•å¤åˆ¶åˆ°å‰ªè´´æ¿
    if (navigator.clipboard) {
        navigator.clipboard.writeText(formattedData).then(() => {
            console.log('ğŸ“‹ å»ºè®®æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }).catch(() => {
            console.log('ğŸ“‹ å»ºè®®æ•°æ®:', formattedData);
        });
    } else {
        console.log('ğŸ“‹ å»ºè®®æ•°æ®:', formattedData);
    }
}



// æ–¹æ³•3: é€šè¿‡é‚®ä»¶å‘é€ (å¤‡ç”¨æ–¹æ¡ˆ)
function sendByEmail(suggestionText) {
    // ä½¿ç”¨ EmailJS æœåŠ¡ (éœ€è¦é…ç½®)
    if (typeof emailjs !== 'undefined') {
        emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', {
            suggestion: suggestionText,
            timestamp: new Date().toLocaleString(),
            game: 'å¯¹æˆ˜æ¸¸æˆ'
        })
        .then(function(response) {
            console.log('âœ… å»ºè®®å·²é€šè¿‡é‚®ä»¶å‘é€');
        }, function(error) {
            console.warn('âš ï¸ é‚®ä»¶å‘é€å¤±è´¥:', error);
        });
    } else {
        // å¤‡ç”¨æ–¹æ¡ˆï¼šç”Ÿæˆ mailto é“¾æ¥
        const subject = encodeURIComponent('æ¸¸æˆå»ºè®®åé¦ˆ');
        const body = encodeURIComponent(`å»ºè®®å†…å®¹ï¼š${suggestionText}\n\næ—¶é—´ï¼š${new Date().toLocaleString()}\næ¸¸æˆï¼šå¯¹æˆ˜æ¸¸æˆ`);
        const mailtoLink = `mailto:your-email@example.com?subject=${subject}&body=${body}`;
        
        console.log('ğŸ“§ é‚®ä»¶é“¾æ¥å·²ç”Ÿæˆ:', mailtoLink);
        console.log('ğŸ’¡ æç¤ºï¼šæ‚¨å¯ä»¥ç‚¹å‡»æ­¤é“¾æ¥å‘é€é‚®ä»¶ï¼Œæˆ–é…ç½® EmailJS å®ç°è‡ªåŠ¨å‘é€');
    }
}

// æ–¹æ³•4: å‘é€åˆ° Google Sheets (é¢å¤–é€‰é¡¹)
function sendToGoogleSheets(suggestionText) {
    // ä½¿ç”¨ Google Apps Script Web App
    const scriptUrl = 'YOUR_GOOGLE_SCRIPT_URL';
    
    fetch(scriptUrl, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            suggestion: suggestionText,
            timestamp: new Date().toISOString(),
            game: 'å¯¹æˆ˜æ¸¸æˆ'
        })
    })
    .then(() => {
        console.log('âœ… å»ºè®®å·²å‘é€åˆ° Google Sheets');
    })
    .catch(error => {
        console.warn('âš ï¸ Google Sheets å‘é€å‡ºé”™:', error.message);
    });
}

// å»ºè®®æ”¶é›†é—®é¢˜è§£å†³åŠ©æ‰‹
function setupSuggestionCollection() {
    console.log('ğŸ” å»ºè®®æ”¶é›†é—®é¢˜è¯Šæ–­ä¸è§£å†³');
    
    if (window.webhookUrl) {
        console.log('\nâœ… ç³»ç»ŸçŠ¶æ€: è·¨è®¾å¤‡æ”¶é›†å·²å¯ç”¨');
        console.log('ğŸŒ Webhook URL:', window.webhookUrl);
        console.log('ğŸ“Š æ‚¨çš„å»ºè®®æ•°æ®ä¼šå‘é€åˆ°ä¸Šè¿°ç½‘å€ï¼Œå¯ä»¥åœ¨é‚£é‡ŒæŸ¥çœ‹æ‰€æœ‰è®¾å¤‡çš„å»ºè®®');
    } else {
        console.log('\nâŒ é—®é¢˜: å»ºè®®åªä¿å­˜åœ¨æœ¬åœ°ï¼Œæ— æ³•è·¨è®¾å¤‡æ”¶é›†');
        console.log('\nğŸ¯ è§£å†³æ–¹æ¡ˆ: å¯ç”¨è·¨è®¾å¤‡æ”¶é›† (2åˆ†é’Ÿæå®š)');
        console.log('\nğŸ“‹ è¯¦ç»†æ­¥éª¤:');
        console.log('   1. æ‰“å¼€æ–°æ ‡ç­¾é¡µï¼Œè®¿é—®: https://webhook.site/');
        console.log('   2. é¡µé¢ä¼šæ˜¾ç¤ºä¸€ä¸ªå”¯ä¸€çš„URL (ç±»ä¼¼: https://webhook.site/12345...)');
        console.log('   3. å¤åˆ¶è¿™ä¸ªURL');
        console.log('   4. å›åˆ°è¿™é‡Œï¼Œè¿è¡Œ: setupWebhook("ç²˜è´´æ‚¨å¤åˆ¶çš„URL")');
        console.log('   5. å®Œæˆï¼ç°åœ¨æ‚¨åœ¨æ‰€æœ‰è®¾å¤‡ä¸Šçš„å»ºè®®éƒ½ä¼šæ±‡æ€»åˆ°é‚£ä¸ªç½‘é¡µ');
        console.log('\nğŸ’¡ æç¤º: webhook.site æ˜¯å…è´¹æœåŠ¡ï¼Œæ— éœ€æ³¨å†Œ');
    }
    
    console.log('\n=== å½“å‰æ”¶é›†æ–¹å¼ ===');
    console.log('ğŸ“¥ æœ¬åœ°ä¸‹è½½: å·²å¯ç”¨ (æ‚¨çš„æ¯æ¬¡å»ºè®®éƒ½ä¼šä¸‹è½½JSONæ–‡ä»¶)');
    console.log('ğŸ“‹ å‰ªè´´æ¿: å·²å¯ç”¨ (æ‚¨çš„å»ºè®®æ•°æ®è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿)');
    console.log('ğŸŒ è·¨è®¾å¤‡æ”¶é›†: ' + (window.webhookUrl ? 'âœ… å·²å¯ç”¨' : 'âŒ æœªå¯ç”¨'));
}

// å¿«é€Ÿé…ç½®å‡½æ•°
function setupWebhook(url) {
    if (!url) {
        console.error('è¯·æä¾› Webhook URL');
        console.log('ğŸ’¡ è·å–æ–¹æ³•: è®¿é—® https://webhook.site/ å¹¶å¤åˆ¶æ‚¨çš„å”¯ä¸€URL');
        return;
    }
    
    // ç®€å•éªŒè¯URLæ ¼å¼
    if (!url.startsWith('http')) {
        console.error('âŒ URLæ ¼å¼é”™è¯¯ï¼Œè¯·ç¡®ä¿ä»¥ http:// æˆ– https:// å¼€å¤´');
        return;
    }
    
    window.webhookUrl = url;
    console.log('\nğŸ‰ è·¨è®¾å¤‡æ”¶é›†å·²å¯ç”¨ï¼');
    console.log('ğŸŒ Webhook URL:', url);
    
    // è‡ªåŠ¨å¯ç”¨å¼€å‘è€…æ¨¡å¼æ¥æ¥æ”¶å…¶ä»–è®¾å¤‡çš„é€šçŸ¥
    enableDeveloperMode(url);
    
    console.log('\nğŸ“‹ éªŒè¯æ­¥éª¤:');
    console.log('   1. åœ¨å¦ä¸€å°è®¾å¤‡ä¸Šè®¿é—®æ‚¨çš„æ¸¸æˆé¡µé¢');
    console.log('   2. å…¶ä»–äººç‚¹å‡»å»ºè®®æŒ‰é’®å¹¶æäº¤å»ºè®®');
    console.log('   3. æ‚¨çš„ç”µè„‘ä¼šç«‹å³å¼¹å‡ºè“è‰²é€šçŸ¥ï¼');
    console.log('   4. ä¹Ÿå¯ä»¥åˆ° webhook.site é¡µé¢æŸ¥çœ‹æ‰€æœ‰æ•°æ®');
    console.log('\nğŸ’¡ ç°åœ¨æ‚¨å¯ä»¥æ¥æ”¶æ¥è‡ªæ‰€æœ‰è®¾å¤‡çš„å»ºè®®é€šçŸ¥äº†ï¼');
}

function setupFormspree(formId) {
    if (!formId) {
        console.error('è¯·æä¾› Formspree è¡¨å• ID');
        return;
    }
    
    window.formspreeEndpoint = `https://formspree.io/f/${formId}`;
    console.log('âœ… Formspree å·²é…ç½®:', window.formspreeEndpoint);
}

function setupEmailJS(serviceId, templateId) {
    if (!serviceId || !templateId) {
        console.error('è¯·æä¾› EmailJS æœåŠ¡IDå’Œæ¨¡æ¿ID');
        return;
    }
    
    window.emailjsConfig = { serviceId, templateId };
    console.log('âœ… EmailJS å·²é…ç½®');
}

// å¼€å‘è€…æ¨¡å¼åŠŸèƒ½
function enableDeveloperMode(webhookUrl) {
    if (!webhookUrl) {
        console.error('âŒ è¯·æä¾›æœ‰æ•ˆçš„ Webhook URL');
        console.log('ğŸ’¡ è·å–æ–¹æ³•: è®¿é—® https://webhook.site/ å¹¶å¤åˆ¶æ‚¨çš„å”¯ä¸€URL');
        return;
    }
    
    // ç¡®ä¿è®¾å¤‡IDå·²ç”Ÿæˆ
    if (!window.currentDeviceId) {
        window.currentDeviceId = 'device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        console.log('ğŸ”§ ç”Ÿæˆè®¾å¤‡ID:', window.currentDeviceId);
    }
    
    isDeveloperMode = true;
    developerWebhookUrl = webhookUrl;
    lastCheckedTimestamp = Date.now();
    
    console.log('ğŸ”§ å¼€å‘è€…æ¨¡å¼å·²å¯ç”¨');
    console.log('ğŸ“¡ ç›‘å¬åœ°å€:', webhookUrl);
    console.log('ğŸ†” æœ¬è®¾å¤‡ID:', window.currentDeviceId);
    console.log('ğŸ”„ å¼€å§‹å®æ—¶ç›‘å¬å…¶ä»–è®¾å¤‡çš„å»ºè®®...');
    console.log('ğŸ’¡ æ³¨æ„: æ¥è‡ªæœ¬è®¾å¤‡çš„å»ºè®®å°†è¢«è‡ªåŠ¨è¿‡æ»¤ï¼Œåªæ˜¾ç¤ºå…¶ä»–è®¾å¤‡çš„å»ºè®®');
    
    // å¼€å§‹è½®è¯¢æ£€æŸ¥æ–°å»ºè®®
    startSuggestionPolling();
    
    // æ˜¾ç¤ºå¼€å‘è€…æ¨¡å¼çŠ¶æ€
    showDeveloperModeStatus();
}

function startSuggestionPolling() {
    if (suggestionPollingInterval) {
        clearInterval(suggestionPollingInterval);
    }
    
    // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥
    checkForNewSuggestions();
    
    suggestionPollingInterval = setInterval(() => {
        checkForNewSuggestions();
    }, 3000); // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡
    
    console.log('ğŸ”„ å»ºè®®è½®è¯¢å·²å¯åŠ¨ï¼Œæ¯3ç§’æ£€æŸ¥ä¸€æ¬¡æ–°å»ºè®®');
}

// å·²æ˜¾ç¤ºçš„å»ºè®®IDé›†åˆï¼Œé¿å…é‡å¤æ˜¾ç¤º
let displayedSuggestionIds = new Set();

function checkForNewSuggestions() {
    if (!isDeveloperMode || !developerWebhookUrl) return;
    
    // è¿™é‡Œä½¿ç”¨webhook.siteçš„APIæ¥è·å–æ–°çš„è¯·æ±‚
    const webhookId = developerWebhookUrl.split('/').pop();
    const apiUrl = `https://webhook.site/token/${webhookId}/requests`;
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            if (data && data.data) {
                // è¿‡æ»¤å‡ºæ–°çš„å»ºè®®ï¼ˆæ’é™¤æ¥è‡ªæœ¬è®¾å¤‡çš„å»ºè®®å’Œå·²æ˜¾ç¤ºçš„å»ºè®®ï¼‰
                const newSuggestions = data.data.filter(request => {
                    const requestTime = new Date(request.created_at).getTime();
                    if (requestTime <= lastCheckedTimestamp || 
                        request.method !== 'POST' ||
                        !request.content) {
                        return false;
                    }
                    
                    try {
                        const suggestionData = JSON.parse(request.content);
                        
                        // æ’é™¤æ¥è‡ªæœ¬è®¾å¤‡çš„å»ºè®®
                        if (suggestionData.deviceId === window.currentDeviceId) {
                            console.log('ğŸ” è·³è¿‡æœ¬è®¾å¤‡å»ºè®®:', suggestionData.suggestion);
                            return false;
                        }
                        
                        // ç”Ÿæˆå”¯ä¸€IDæ¥é¿å…é‡å¤æ˜¾ç¤º
                        const suggestionId = `${request.uuid || request.created_at}_${suggestionData.suggestion.substring(0, 20)}`;
                        if (displayedSuggestionIds.has(suggestionId)) {
                            console.log('ğŸ” è·³è¿‡å·²æ˜¾ç¤ºå»ºè®®:', suggestionData.suggestion);
                            return false;
                        }
                        
                        // æ ‡è®°ä¸ºå·²æ˜¾ç¤º
                        displayedSuggestionIds.add(suggestionId);
                        
                        return suggestionData.suggestion;
                    } catch (e) {
                        return false;
                    }
                });
                
                // æ˜¾ç¤ºæ–°å»ºè®®
                newSuggestions.forEach(request => {
                    const suggestionData = JSON.parse(request.content);
                    showDeveloperNotification(suggestionData, request.created_at);
                });
                
                // æ›´æ–°æœ€åæ£€æŸ¥æ—¶é—´
                if (data.data.length > 0) {
                    lastCheckedTimestamp = Math.max(...data.data.map(r => new Date(r.created_at).getTime()));
                }
                
                // æ¸…ç†è¿‡æœŸçš„å·²æ˜¾ç¤ºå»ºè®®IDï¼ˆä¿ç•™æœ€è¿‘1å°æ—¶çš„è®°å½•ï¼‰
                const oneHourAgo = Date.now() - 3600000;
                const expiredIds = Array.from(displayedSuggestionIds).filter(id => {
                    const timestamp = id.split('_')[0];
                    return new Date(timestamp).getTime() < oneHourAgo;
                });
                expiredIds.forEach(id => displayedSuggestionIds.delete(id));
            }
        })
        .catch(error => {
            console.log('ğŸ” è½®è¯¢æ£€æŸ¥ä¸­...', new Date().toLocaleTimeString());
        });
}

function showDeveloperNotification(suggestionData, timestamp) {
    console.log('ğŸ’» æ˜¾ç¤ºå¼€å‘è€…é€šçŸ¥: ' + suggestionData.suggestion);
    console.log('ğŸ” è°ƒè¯•: showDeveloperNotification å‡½æ•°è¢«è°ƒç”¨');
    
    const notification = document.getElementById('developerNotification');
    console.log('ğŸ” è°ƒè¯•: developerNotification å…ƒç´ :', notification);
    
    if (!notification) {
        console.error('âŒ é”™è¯¯: æ‰¾ä¸åˆ° developerNotification å…ƒç´ !');
        return;
    }
    
    // è§£æè®¾å¤‡ä¿¡æ¯
    const userAgent = suggestionData.userAgent || '';
    let deviceInfo = 'ğŸ–¥ï¸ æœªçŸ¥è®¾å¤‡';
    if (userAgent.includes('Mobile') || userAgent.includes('Android') || userAgent.includes('iPhone')) {
        deviceInfo = 'ğŸ“± ç§»åŠ¨è®¾å¤‡';
    } else if (userAgent.includes('Windows') || userAgent.includes('Mac') || userAgent.includes('Linux')) {
        deviceInfo = 'ğŸ’» æ¡Œé¢è®¾å¤‡';
    }
    
    // æ ¼å¼åŒ–æ—¶é—´
    const date = new Date(timestamp);
    const timeStr = date.toLocaleString();
    
    // å¤„ç†é•¿æ–‡æœ¬
    const suggestion = suggestionData.suggestion || '';
    let notificationHTML;
    
    if (suggestion.length > 50) {
        const preview = suggestion.substring(0, 50) + '...';
        notificationHTML = `
            <div style="margin-bottom: 10px;">
                <strong>ğŸ”” æ”¶åˆ°æ–°å»ºè®®</strong><br>
                <small>${deviceInfo} â€¢ ${timeStr}</small>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; margin: 10px 0;">
                <span id="devSuggestionPreview">${preview}</span>
                <span id="devSuggestionFull" style="display: none;">${suggestion}</span>
                <br><button onclick="toggleDevSuggestionText()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 3px; margin-top: 5px; cursor: pointer; font-size: 12px;">æ˜¾ç¤ºå…¨æ–‡</button>
            </div>
            <button onclick="hideDeveloperNotification()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 5px; margin-top: 10px; cursor: pointer;">çŸ¥é“äº†</button>
        `;
    } else {
        notificationHTML = `
            <div style="margin-bottom: 10px;">
                <strong>ğŸ”” æ”¶åˆ°æ–°å»ºè®®</strong><br>
                <small>${deviceInfo} â€¢ ${timeStr}</small>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; margin: 10px 0;">
                ${suggestion}
            </div>
            <button onclick="hideDeveloperNotification()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 5px; margin-top: 10px; cursor: pointer;">çŸ¥é“äº†</button>
        `;
    }
    
    notification.innerHTML = notificationHTML;
    notification.style.display = 'block';
    notification.style.animation = 'slideIn 0.5s ease-out';
    
    // 10ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        if (notification.style.display === 'block') {
            hideDeveloperNotification();
        }
    }, 10000);
    
    console.log('âœ… å¼€å‘è€…é€šçŸ¥å·²æ˜¾ç¤º');
    console.log('ğŸ” è°ƒè¯•: notification.style.display =', notification.style.display);
    console.log('ğŸ” è°ƒè¯•: notification.offsetHeight =', notification.offsetHeight);
    console.log('ğŸ” è°ƒè¯•: notification.offsetWidth =', notification.offsetWidth);
    console.log('ğŸ”” æ”¶åˆ°æ–°å»ºè®®:', suggestionData.suggestion);
    console.log('ğŸ“Š è®¾å¤‡ä¿¡æ¯:', deviceInfo);
    console.log('â° æäº¤æ—¶é—´:', timeStr);
}

// éšè—å¼€å‘è€…é€šçŸ¥
function hideDeveloperNotification() {
    const notification = document.getElementById('developerNotification');
    notification.style.display = 'none';
}

// åˆ‡æ¢å¼€å‘è€…é€šçŸ¥ä¸­çš„å»ºè®®æ–‡æœ¬æ˜¾ç¤º
function toggleDevSuggestionText() {
    const preview = document.getElementById('devSuggestionPreview');
    const full = document.getElementById('devSuggestionFull');
    const btn = event.target;
    
    if (preview.style.display === 'none') {
        preview.style.display = 'inline';
        full.style.display = 'none';
        btn.textContent = 'æ˜¾ç¤ºå…¨æ–‡';
    } else {
        preview.style.display = 'none';
        full.style.display = 'inline';
        btn.textContent = 'æ”¶èµ·';
    }
}

function showDeveloperModeStatus() {
    const statusDiv = document.createElement('div');
    statusDiv.id = 'developerModeStatus';
    statusDiv.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
        font-size: 12px;
        z-index: 1002;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        max-width: 250px;
    `;
    
    statusDiv.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 8px;">ğŸ”§ å¼€å‘è€…æ¨¡å¼</div>
        <div>ğŸ“¡ æ­£åœ¨ç›‘å¬ç”¨æˆ·å»ºè®®...</div>
        <div style="font-size: 10px; opacity: 0.8; margin-top: 5px;">æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡æ–°å»ºè®®</div>
        <button onclick="disableDeveloperMode()" style="
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 10px;
            margin-top: 8px;
        ">å…³é—­ç›‘å¬</button>
    `;
    
    // ç§»é™¤æ—§çš„çŠ¶æ€æ˜¾ç¤º
    const oldStatus = document.getElementById('developerModeStatus');
    if (oldStatus) oldStatus.remove();
    
    document.body.appendChild(statusDiv);
}

function disableDeveloperMode() {
    isDeveloperMode = false;
    developerWebhookUrl = null;
    
    if (suggestionPollingInterval) {
        clearInterval(suggestionPollingInterval);
        suggestionPollingInterval = null;
    }
    
    const statusDiv = document.getElementById('developerModeStatus');
    if (statusDiv) statusDiv.remove();
    
    console.log('ğŸ”§ å¼€å‘è€…æ¨¡å¼å·²å…³é—­');
}

// å¯ç”¨æ¼”ç¤ºæ¨¡å¼ï¼ˆæ— éœ€çœŸå®webhookï¼‰
function enableDemoMode() {
    isDeveloperMode = true;
    window.demoMode = true;
    window.demoSuggestions = window.demoSuggestions || [];
    console.log('ğŸ® æ¼”ç¤ºæ¨¡å¼å·²å¯ç”¨');
    console.log('ğŸ” è°ƒè¯•: enableDemoMode è®¾ç½® isDeveloperMode =', isDeveloperMode);
    console.log('ğŸ” è°ƒè¯•: enableDemoMode è®¾ç½® window.demoMode =', window.demoMode);
    console.log('ğŸ’¡ ç°åœ¨æäº¤å»ºè®®æ—¶ï¼Œæ‚¨å°†çœ‹åˆ°è·¨è®¾å¤‡é€šçŸ¥æ¼”ç¤ºæ•ˆæœ');
    console.log('ğŸ“± å»ºè®®æäº¤åä¼šæ˜¾ç¤º"å‘é€æˆåŠŸ"ï¼Œç„¶åå¼€å‘è€…ç«¯ä¼šæ”¶åˆ°é€šçŸ¥');
    
    // æ˜¾ç¤ºæ¼”ç¤ºæ¨¡å¼çŠ¶æ€
    const statusDiv = document.createElement('div');
    statusDiv.id = 'demoModeStatus';
    statusDiv.style.cssText = `
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0, 150, 255, 0.9);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    `;
    statusDiv.innerHTML = `
        ğŸ® æ¼”ç¤ºæ¨¡å¼å·²å¯ç”¨<br>
        <small>æäº¤å»ºè®®å¯ä½“éªŒè·¨è®¾å¤‡é€šçŸ¥</small>
    `;
    
    // ç§»é™¤æ—§çš„çŠ¶æ€æ˜¾ç¤º
    const oldStatus = document.getElementById('demoModeStatus');
    if (oldStatus) oldStatus.remove();
    
    document.body.appendChild(statusDiv);
    
    // 3ç§’åè‡ªåŠ¨éšè—çŠ¶æ€æç¤ºï¼ˆä¸å½±å“æ¼”ç¤ºæ¨¡å¼åŠŸèƒ½ï¼‰
    setTimeout(() => {
        if (statusDiv && statusDiv.parentNode) {
            statusDiv.remove();
        }
    }, 3000);
}

function disableDemoMode() {
    isDeveloperMode = false;
    window.demoMode = false;
    
    const statusDiv = document.getElementById('demoModeStatus');
    if (statusDiv) statusDiv.remove();
    
    console.log('ğŸ® æ¼”ç¤ºæ¨¡å¼å·²å…³é—­');
}

// å¯¼å‡ºå…¨å±€å‡½æ•°ä¾›å¼€å‘è€…ä½¿ç”¨
window.setupSuggestionCollection = setupSuggestionCollection;
window.setupWebhook = setupWebhook;
window.setupFormspree = setupFormspree;
window.enableDeveloperMode = enableDeveloperMode;
window.disableDeveloperMode = disableDeveloperMode;
window.enableDemoMode = enableDemoMode;
window.disableDemoMode = disableDemoMode;
window.setupEmailJS = setupEmailJS;
window.setupGA = setupGoogleAnalytics;
window.checkGA = checkGASetup;
window.sendToGoogleSheets = sendToGoogleSheets;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ç™»å½•ç³»ç»Ÿ
window.addEventListener('DOMContentLoaded', function() {
    console.log('é¡µé¢DOMContentLoadedäº‹ä»¶è§¦å‘');
    console.log('å‡†å¤‡è°ƒç”¨initLoginSystem');
    try {
        initLoginSystem();
        console.log('initLoginSystemè°ƒç”¨æˆåŠŸ');
    } catch (error) {
        console.error('initLoginSystemè°ƒç”¨å¤±è´¥:', error);
    }
});

// é€šè¿‡ç”¨æˆ·IDæŸ¥çœ‹å»ºè®®çš„åŠŸèƒ½
function getSuggestionsByUserId(userId) {
    console.log('ğŸ” æŸ¥æ‰¾ç”¨æˆ·IDä¸º ' + userId + ' çš„å»ºè®®:');
    
    const userSuggestions = suggestionStorage.filter(suggestion => 
        suggestion.userId === userId
    );
    
    if (userSuggestions.length === 0) {
        console.log('âŒ æœªæ‰¾åˆ°è¯¥ç”¨æˆ·çš„å»ºè®®');
        return [];
    }
    
    console.log('âœ… æ‰¾åˆ° ' + userSuggestions.length + ' æ¡å»ºè®®:');
    userSuggestions.forEach((suggestion, index) => {
        console.log(`${index + 1}. [${suggestion.timestamp}] ${suggestion.content}`);
    });
    
    return userSuggestions;
}

// é€šè¿‡ç”¨æˆ·åæŸ¥çœ‹å»ºè®®çš„åŠŸèƒ½
function getSuggestionsByUserName(userName) {
    console.log('ğŸ” æŸ¥æ‰¾ç”¨æˆ·åä¸º "' + userName + '" çš„å»ºè®®:');
    
    const userSuggestions = suggestionStorage.filter(suggestion => 
        suggestion.userName === userName
    );
    
    if (userSuggestions.length === 0) {
        console.log('âŒ æœªæ‰¾åˆ°è¯¥ç”¨æˆ·çš„å»ºè®®');
        return [];
    }
    
    console.log('âœ… æ‰¾åˆ° ' + userSuggestions.length + ' æ¡å»ºè®®:');
    userSuggestions.forEach((suggestion, index) => {
        console.log(`${index + 1}. [${suggestion.timestamp}] ${suggestion.content}`);
    });
    
    return userSuggestions;
}

// æŸ¥çœ‹æ‰€æœ‰å»ºè®®å¹¶æŒ‰ç”¨æˆ·åˆ†ç»„
function getAllSuggestionsGroupedByUser() {
    console.log('ğŸ“Š æ‰€æœ‰å»ºè®®æŒ‰ç”¨æˆ·åˆ†ç»„:');
    
    if (suggestionStorage.length === 0) {
        console.log('âŒ æš‚æ— å»ºè®®è®°å½•');
        return {};
    }
    
    const groupedSuggestions = {};
    
    suggestionStorage.forEach(suggestion => {
        const key = `${suggestion.userName} (ID: ${suggestion.userId})`;
        if (!groupedSuggestions[key]) {
            groupedSuggestions[key] = [];
        }
        groupedSuggestions[key].push(suggestion);
    });
    
    Object.keys(groupedSuggestions).forEach(userKey => {
        console.log(`\nğŸ‘¤ ${userKey}:`);
        groupedSuggestions[userKey].forEach((suggestion, index) => {
            console.log(`   ${index + 1}. [${suggestion.timestamp}] ${suggestion.content}`);
        });
    });
    
    return groupedSuggestions;
}

// åˆ é™¤ç‰¹å®šç”¨æˆ·çš„å»ºè®®
function deleteSuggestionsByUserId(userId) {
    console.log('ğŸ—‘ï¸ åˆ é™¤ç”¨æˆ·IDä¸º ' + userId + ' çš„æ‰€æœ‰å»ºè®®...');
    
    const initialCount = suggestionStorage.length;
    suggestionStorage = suggestionStorage.filter(suggestion => 
        suggestion.userId !== userId
    );
    
    const deletedCount = initialCount - suggestionStorage.length;
    
    if (deletedCount > 0) {
        console.log('âœ… å·²åˆ é™¤ ' + deletedCount + ' æ¡å»ºè®®');
    } else {
        console.log('âŒ æœªæ‰¾åˆ°è¯¥ç”¨æˆ·çš„å»ºè®®');
    }
    
    return deletedCount;
}

// ç®¡ç†å‘˜æŸ¥çœ‹æ‰€æœ‰å»ºè®®åŠŸèƒ½ï¼ˆä¸“ä¸ºè´¦å·00000000è®¾è®¡ï¼‰
function getAdminSuggestions() {
    console.log('ğŸ‘‘ ç®¡ç†å‘˜å»ºè®®æ±‡æ€» (ç›®æ ‡è´¦å·: 00000000):');
    
    if (suggestionStorage.length === 0) {
        console.log('âŒ æš‚æ— å»ºè®®è®°å½•');
        return [];
    }
    
    console.log('\nğŸ“Š æ‰€æœ‰ç”¨æˆ·å»ºè®®æ±‡æ€»:');
    suggestionStorage.forEach((suggestion, index) => {
        const userInfo = suggestion.userId === 'anonymous' ? 
            'åŒ¿åç”¨æˆ·' : 
            `${suggestion.userName} (ID: ${suggestion.userId})`;
        console.log(`${index + 1}. [${suggestion.timestamp}] ${userInfo}: ${suggestion.content}`);
    });
    
    console.log('\nğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯:');
    const userStats = {};
    suggestionStorage.forEach(suggestion => {
        const key = suggestion.userId === 'anonymous' ? 'åŒ¿åç”¨æˆ·' : suggestion.userId;
        userStats[key] = (userStats[key] || 0) + 1;
    });
    
    Object.keys(userStats).forEach(userId => {
        const userName = userId === 'åŒ¿åç”¨æˆ·' ? 'åŒ¿åç”¨æˆ·' : 
            suggestionStorage.find(s => s.userId === userId)?.userName || 'æœªçŸ¥';
        console.log(`   ${userName} (${userId}): ${userStats[userId]} æ¡å»ºè®®`);
    });
    
    return suggestionStorage;
}

// æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜
function checkAdminAccess() {
    if (currentUser && currentUser.id === '00000000') {
        console.log('âœ… ç®¡ç†å‘˜æƒé™ç¡®è®¤ï¼æ‚¨å¯ä»¥ä½¿ç”¨ getAdminSuggestions() æŸ¥çœ‹æ‰€æœ‰å»ºè®®');
        return true;
    } else {
        console.log('âŒ éç®¡ç†å‘˜è´¦å·ï¼Œè¯·ä½¿ç”¨è´¦å·00000000ç™»å½•åæŸ¥çœ‹');
        return false;
    }
}

// ä½¿ç”¨è¯´æ˜
function showSuggestionManagementHelp() {
    console.log('\nğŸ“‹ å»ºè®®ç®¡ç†åŠŸèƒ½ä½¿ç”¨è¯´æ˜:');
    console.log('\nğŸ” æŸ¥çœ‹åŠŸèƒ½:');
    console.log('   getSuggestionsByUserId("ç”¨æˆ·ID")     - æŸ¥çœ‹æŒ‡å®šç”¨æˆ·IDçš„å»ºè®®');
    console.log('   getSuggestionsByUserName("ç”¨æˆ·å")   - æŸ¥çœ‹æŒ‡å®šç”¨æˆ·åçš„å»ºè®®');
    console.log('   getAllSuggestionsGroupedByUser()    - æŸ¥çœ‹æ‰€æœ‰å»ºè®®å¹¶æŒ‰ç”¨æˆ·åˆ†ç»„');
    console.log('\nğŸ‘‘ ç®¡ç†å‘˜åŠŸèƒ½ (ä»…é™è´¦å·00000000):');
    console.log('   getAdminSuggestions()               - æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·å‘é€çš„å»ºè®®æ±‡æ€»');
    console.log('   checkAdminAccess()                  - æ£€æŸ¥ç®¡ç†å‘˜æƒé™');
    console.log('\nğŸ—‘ï¸ ç®¡ç†åŠŸèƒ½:');
    console.log('   deleteSuggestionsByUserId("ç”¨æˆ·ID") - åˆ é™¤æŒ‡å®šç”¨æˆ·çš„æ‰€æœ‰å»ºè®®');
    console.log('\nğŸ’¡ ç¤ºä¾‹:');
    console.log('   getSuggestionsByUserId("00000001")  - æŸ¥çœ‹IDä¸º00000001çš„ç”¨æˆ·å»ºè®®');
    console.log('   getSuggestionsByUserName("å¼ ä¸‰")     - æŸ¥çœ‹ç”¨æˆ·åä¸ºå¼ ä¸‰çš„å»ºè®®');
    console.log('   getAdminSuggestions()               - ç®¡ç†å‘˜æŸ¥çœ‹æ‰€æœ‰å»ºè®®');
    console.log('\nğŸ“Š å½“å‰å»ºè®®æ€»æ•°:', suggestionStorage.length);
}

// å¿«é€Ÿç™»å½•ç®¡ç†å‘˜å‡½æ•°
function loginAsAdmin() {
    const adminUser = users.find(user => user.id === '00000000');
    if (adminUser) {
        currentUser = adminUser;
        console.log('âœ… å·²å¿«é€Ÿç™»å½•ç®¡ç†å‘˜è´¦å·:', adminUser.name);
        
        // éšè—ç™»å½•ç•Œé¢ï¼Œæ˜¾ç¤ºæ¬¢è¿ç•Œé¢
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('welcomeScreen').style.display = 'block';
        
        // åˆå§‹åŒ–é‚®ç®±
        initializeMailbox();
        updateUnreadCount();
        // åªæœ‰åœ¨æœ‰æœªè¯»æ¶ˆæ¯æ—¶æ‰æ˜¾ç¤ºé‚®ç®±æŒ‰é’®
        if (mailboxMessages.filter(msg => !msg.read).length > 0) {
            showMailboxButton();
        }
        
        console.log('ğŸ“§ é‚®ç®±åŠŸèƒ½å·²æ¿€æ´»ï¼Œè¯·æŸ¥çœ‹å³ä¸Šè§’é‚®ç®±æŒ‰é’®');
    } else {
        console.log('âŒ ç®¡ç†å‘˜è´¦å·ä¸å­˜åœ¨');
    }
}

// é‚®ç®±åŠŸèƒ½ç›¸å…³å˜é‡å’Œå‡½æ•°
let mailboxMessages = [];
let mailboxAutoHideTimer = null;
let isGameStarted = false;
let gameRunning = false;

// åˆå§‹åŒ–é‚®ç®±æ¶ˆæ¯ï¼ˆæ ¹æ®ç”¨æˆ·ç±»å‹ï¼‰
function initializeMailbox() {
    if (currentUser && currentUser.id === '00000000') {
        // ç®¡ç†å‘˜åŠ è½½ç®¡ç†å‘˜é‚®ç®±
        mailboxMessages = JSON.parse(localStorage.getItem('adminMailboxMessages') || '[]');
    } else {
        // æ™®é€šç”¨æˆ·ä¸éœ€è¦é‚®ç®±
        mailboxMessages = [];
    }
}

// æ›´æ–°æœªè¯»æ¶ˆæ¯è®¡æ•°
function updateUnreadCount() {
    const unreadCount = mailboxMessages.filter(msg => !msg.read).length;
    const badge = document.getElementById('unreadCount');
    if (unreadCount > 0) {
        badge.textContent = unreadCount;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}

// æ·»åŠ æ¶ˆæ¯åˆ°é‚®ç®±
function addMessageToMailbox(content, type = 'suggestion') {
    const message = {
        id: Date.now() + Math.random(),
        content: content,
        type: type,
        timestamp: new Date().toISOString(),
        read: false
    };
    
    mailboxMessages.unshift(message); // æœ€æ–°æ¶ˆæ¯åœ¨å‰
    localStorage.setItem('mailboxMessages', JSON.stringify(mailboxMessages));
    updateUnreadCount();
    showMailboxButton();
}

// æ·»åŠ æ¶ˆæ¯åˆ°ç®¡ç†å‘˜é‚®ç®±
function addMessageToAdminMailbox(content, fromUser) {
    // ç®¡ç†å‘˜é‚®ç®±æ¶ˆæ¯å­˜å‚¨åœ¨ä¸“é—¨çš„keyä¸­
    let adminMessages = JSON.parse(localStorage.getItem('adminMailboxMessages') || '[]');
    
    const message = {
        id: Date.now() + Math.random(),
        content: content,
        fromUser: fromUser,
        type: 'suggestion',
        timestamp: new Date().toISOString(),
        read: false
    };
    
    adminMessages.unshift(message); // æœ€æ–°æ¶ˆæ¯åœ¨å‰
    localStorage.setItem('adminMailboxMessages', JSON.stringify(adminMessages));
    
    // å¦‚æœå½“å‰ç”¨æˆ·æ˜¯ç®¡ç†å‘˜ï¼Œæ›´æ–°é‚®ç®±æ˜¾ç¤º
    if (currentUser && currentUser.id === '00000000') {
        mailboxMessages = adminMessages;
        updateUnreadCount();
        showMailboxButton();
    }
}

// æ˜¾ç¤ºé‚®ç®±æŒ‰é’®ï¼ˆåªæœ‰ç®¡ç†å‘˜å¯è§ï¼‰
function showMailboxButton() {
    const mailboxButton = document.getElementById('mailboxButton');
    
    // åªæœ‰ç®¡ç†å‘˜æ‰èƒ½çœ‹åˆ°é‚®ç®±æŒ‰é’®
    if (currentUser && currentUser.id === '00000000') {
        mailboxButton.style.display = 'flex';
        resetAutoHideTimer();
    } else {
        mailboxButton.style.display = 'none';
    }
}

// éšè—é‚®ç®±æŒ‰é’®
function hideMailboxButton() {
    const mailboxButton = document.getElementById('mailboxButton');
    mailboxButton.style.display = 'none';
    clearTimeout(mailboxAutoHideTimer);
}

// é‡ç½®è‡ªåŠ¨éšè—è®¡æ—¶å™¨ï¼ˆç°åœ¨ä¸å†è‡ªåŠ¨éšè—æŒ‰é’®ï¼‰
function resetAutoHideTimer() {
    clearTimeout(mailboxAutoHideTimer);
    // é‚®ç®±æŒ‰é’®ç°åœ¨ä¸€ç›´æ˜¾ç¤ºï¼Œä¸å†è‡ªåŠ¨éšè—
}

// æ˜¾ç¤ºé‚®ç®±å¼¹çª—
function showMailboxModal() {
    const modal = document.getElementById('mailboxModal');
    modal.style.display = 'flex';
    renderMailboxMessages();
    resetAutoHideTimer();
}

// éšè—é‚®ç®±å¼¹çª—
function hideMailboxModal() {
    const modal = document.getElementById('mailboxModal');
    modal.style.display = 'none';
}

// æ¸²æŸ“é‚®ç®±æ¶ˆæ¯
function renderMailboxMessages() {
    const messagesContainer = document.getElementById('mailboxMessages');
    
    if (mailboxMessages.length === 0) {
        messagesContainer.innerHTML = '<div class="empty-state"><p>è¿™é‡Œæ˜¯ç©ºç©ºå“’</p></div>';
        return;
    }
    
    const messagesHtml = mailboxMessages.map(message => {
        const date = new Date(message.timestamp);
        const timeStr = date.toLocaleString('zh-CN');
        const fromUserInfo = message.fromUser ? `æ¥è‡ª: ${message.fromUser}` : '';
        
        return `
            <div class="message-item" data-message-id="${message.id}">
                <div class="message-header">
                    <span class="message-from">${fromUserInfo}</span>
                    <span class="message-time">${timeStr}</span>
                </div>
                <div class="message-content">${message.content}</div>
                <button class="message-dismiss" onclick="dismissMessage('${message.id}')">çŸ¥é“äº†</button>
            </div>
        `;
    }).join('');
    
    messagesContainer.innerHTML = messagesHtml;
}

// æ¶ˆé™¤å•ä¸ªæ¶ˆæ¯
function dismissMessage(messageId) {
    mailboxMessages = mailboxMessages.filter(msg => msg.id != messageId);
    
    // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œæ›´æ–°ç®¡ç†å‘˜é‚®ç®±å­˜å‚¨
    if (currentUser && currentUser.id === '00000000') {
        localStorage.setItem('adminMailboxMessages', JSON.stringify(mailboxMessages));
    } else {
        localStorage.setItem('mailboxMessages', JSON.stringify(mailboxMessages));
    }
    
    updateUnreadCount();
    renderMailboxMessages();
    
    // å¦‚æœæ²¡æœ‰æ¶ˆæ¯äº†ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
    if (mailboxMessages.length === 0) {
        setTimeout(() => {
            hideMailboxModal();
        }, 500);
    }
}

// ä¿®æ”¹åŸæœ‰çš„å»ºè®®å‘é€æˆåŠŸé€šçŸ¥å‡½æ•°
function showSuggestionNotification(message) {
    // æ˜¾ç¤ºç”¨æˆ·å»ºè®®å‘é€æˆåŠŸé€šçŸ¥
    console.log('ğŸ“¤ æ˜¾ç¤ºç”¨æˆ·é€šçŸ¥: ' + message);
    
    const notification = document.getElementById('suggestionNotification');
    
    notification.innerHTML = `
        <strong>âœ… å»ºè®®å‘é€æˆåŠŸï¼</strong><br>
        <small>â° ${new Date().toLocaleString()}</small><br>
        <small>ğŸ“§ æ‚¨çš„å»ºè®®å·²å‘é€ç»™ç®¡ç†å‘˜</small><br>
        <button onclick="hideSuggestionNotification(true, '${message.replace(/'/g, "\\'").replace(/"/g, '\\"')}', '${currentUser ? currentUser.name.replace(/'/g, "\\'").replace(/"/g, '\\"') : 'åŒ¿åç”¨æˆ·'}')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 5px; margin-top: 10px; cursor: pointer;">çŸ¥é“äº†</button>
    `;
    
    notification.className = 'show';
    
    // 10ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        if (notification.classList.contains('show')) {
            hideSuggestionNotification();
        }
    }, 10000);
    
    // æ³¨é‡Šæ‰å¼€å‘è€…é€šçŸ¥æ˜¾ç¤ºé€»è¾‘ï¼Œç”¨æˆ·ç«¯åªæ˜¾ç¤ºå‘é€æˆåŠŸé€šçŸ¥
    // è“è‰²çš„å¼€å‘è€…é€šçŸ¥åº”è¯¥åªåœ¨çœŸæ­£çš„å¼€å‘è€…ç«¯æ˜¾ç¤º
    console.log('ğŸ“¤ ç”¨æˆ·ç«¯åªæ˜¾ç¤ºç»¿è‰²å‘é€æˆåŠŸé€šçŸ¥ï¼Œä¸æ˜¾ç¤ºè“è‰²å¼€å‘è€…é€šçŸ¥');
    console.log('ğŸ” å½“å‰ isDeveloperMode å€¼:', isDeveloperMode);
}

// æ¸¸æˆå¼€å§‹æ—¶éšè—é‚®ç®±ã€åˆ›å»ºæˆ¿é—´å’Œå¹¿åœºæŒ‰é’®
function onGameStart() {
    isGameStarted = true;
    gameRunning = true;
    // æ¸¸æˆå¼€å§‹æ—¶éšè—é‚®ç®±æ¨¡æ€æ¡†
    hideMailboxModal();
    // éšè—é‚®ç®±ã€åˆ›å»ºæˆ¿é—´å’Œå¹¿åœºæŒ‰é’®
    hideMailboxButton();
    const createRoomButton = document.getElementById('createRoomButton');
    const squareButton = document.getElementById('squareButton');
    if (createRoomButton) {
        createRoomButton.style.display = 'none';
    }
    if (squareButton) {
        squareButton.style.display = 'none';
    }
}

// æ¸¸æˆç»“æŸæ—¶é‡æ–°æ˜¾ç¤ºæ‰€æœ‰æŒ‰é’®
function onGameEnd() {
    isGameStarted = false;
    gameRunning = false;
    // æ¸¸æˆç»“æŸåé‡æ–°æ˜¾ç¤ºé‚®ç®±å’Œå»ºè®®æŒ‰é’®
    showMailboxButton();
    showSuggestionButton();
    // é‡æ–°æ˜¾ç¤ºåˆ›å»ºæˆ¿é—´å’Œå¹¿åœºæŒ‰é’®
    const createRoomButton = document.getElementById('createRoomButton');
    const squareButton = document.getElementById('squareButton');
    if (createRoomButton) {
        createRoomButton.style.display = 'flex';
    }
    if (squareButton) {
        squareButton.style.display = 'flex';
    }
}

// æ·»åŠ é¡µé¢åŠ è½½æµ‹è¯•
console.log('JavaScriptä»£ç å¼€å§‹æ‰§è¡Œ');
window.addEventListener('load', function() {
    console.log('é¡µé¢å®Œå…¨åŠ è½½å®Œæˆ');
    console.log('\nğŸ’¡ æç¤º: è¾“å…¥ showSuggestionManagementHelp() æŸ¥çœ‹å»ºè®®ç®¡ç†åŠŸèƒ½');
    console.log('\nğŸ“§ é‚®ç®±æµ‹è¯•: ä½¿ç”¨è´¦å· 00000000 å¯†ç  993966 ç™»å½•æŸ¥çœ‹ç®¡ç†å‘˜é‚®ç®±');
    console.log('\nğŸ”§ å¿«é€Ÿç™»å½•ç®¡ç†å‘˜: è¾“å…¥ loginAsAdmin() å¿«é€Ÿç™»å½•ç®¡ç†å‘˜è´¦å·');
    
    // åˆå§‹åŒ–é‚®ç®±åŠŸèƒ½
    initializeMailbox();
    updateUnreadCount();
    
    // è®¾ç½®å…¨å±€å‡½æ•°
    window.loginAsAdmin = loginAsAdmin;
    window.showSuggestionManagementHelp = showSuggestionManagementHelp;
    
    // é‚®ç®±æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('mailboxButton').addEventListener('click', function() {
        showMailboxModal();
    });
    
    // å…³é—­é‚®ç®±å¼¹çª—äº‹ä»¶
    document.getElementById('closeMailboxBtn').addEventListener('click', function() {
        hideMailboxModal();
    });
    
    // åˆ›å»ºæˆ¿é—´æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('createRoomButton').addEventListener('click', function() {
        alert('åŠŸèƒ½å¼€å‘ä¸­');
    });
    
    // å¹¿åœºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('squareButton').addEventListener('click', function() {
        alert('åŠŸèƒ½å¼€å‘ä¸­');
    });
    
    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    document.getElementById('mailboxModal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideMailboxModal();
        }
    });
    
    // é¼ æ ‡ç§»åŠ¨æ—¶é‡ç½®è‡ªåŠ¨éšè—è®¡æ—¶å™¨
    document.addEventListener('mousemove', function() {
        if (document.getElementById('mailboxButton').style.display !== 'none') {
            resetAutoHideTimer();
        }
    });
    
    // å¦‚æœæ˜¯ç®¡ç†å‘˜ä¸”æœ‰æœªè¯»æ¶ˆæ¯ï¼Œæ˜¾ç¤ºé‚®ç®±æŒ‰é’®
    if (currentUser && currentUser.id === '00000000' && mailboxMessages.filter(msg => !msg.read).length > 0) {
        showMailboxButton();
    }
    
    // åˆ›å»ºåŠ¨æ€ç²’å­æ•ˆæœ
    createParticleSystem();
    
    // åˆ›å»ºåŠ¨æ€ç”»å¸ƒæ•ˆæœ
    createDynamicCanvas();
    
    // ä¸ºé‚®ç®±æŒ‰é’®æ·»åŠ è„‰å†²åŠ¨ç”»
    addMailboxPulseEffect();
});

// åˆ›å»ºç²’å­ç³»ç»Ÿ
function createParticleSystem() {
    const particlesContainer = document.createElement('div');
    particlesContainer.className = 'particles';
    document.body.appendChild(particlesContainer);
    
    function createParticle() {
        const particle = document.createElement('div');
        particle.className = 'particle';
        
        // éšæœºå¤§å°å’Œä½ç½®
        const size = Math.random() * 6 + 2;
        particle.style.width = size + 'px';
        particle.style.height = size + 'px';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.bottom = '-10px';
        
        // éšæœºåŠ¨ç”»å»¶è¿Ÿ
        particle.style.animationDelay = Math.random() * 6 + 's';
        particle.style.animationDuration = (Math.random() * 4 + 4) + 's';
        
        particlesContainer.appendChild(particle);
        
        // åŠ¨ç”»ç»“æŸåç§»é™¤ç²’å­
        setTimeout(() => {
            if (particle.parentNode) {
                particle.parentNode.removeChild(particle);
            }
        }, 8000);
    }
    
    // å®šæœŸåˆ›å»ºç²’å­
    setInterval(createParticle, 300);
}

// ä¸ºé‚®ç®±æŒ‰é’®æ·»åŠ è„‰å†²æ•ˆæœ
function addMailboxPulseEffect() {
    const style = document.createElement('style');
    style.textContent = `
        #mailboxButton {
            animation: mailboxPulse 2s ease-in-out infinite;
        }
        
        @keyframes mailboxPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
        }
        
        #mailboxButton:hover {
            animation: mailboxHover 0.3s ease-out;
            transform: scale(1.1) rotate(5deg);
        }
        
        @keyframes mailboxHover {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.15) rotate(-5deg); }
            100% { transform: scale(1.1) rotate(5deg); }
        }
        
        /* æŒ‰é’®ç‚¹å‡»æ³¢çº¹æ•ˆæœ */
        .ripple-effect {
            position: relative;
            overflow: hidden;
        }
        
        .ripple-effect:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .ripple-effect:active:before {
            width: 300px;
            height: 300px;
        }
    `;
    document.head.appendChild(style);
    
    // ä¸ºæ‰€æœ‰æŒ‰é’®æ·»åŠ æ³¢çº¹æ•ˆæœç±»
    document.querySelectorAll('.gameButton, .loginButton').forEach(button => {
        button.classList.add('ripple-effect');
    });
}

// åˆ›å»ºåŠ¨æ€ç”»å¸ƒæ•ˆæœ
function createDynamicCanvas() {
    const canvas = document.getElementById('dynamicCanvas');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    // å‡ ä½•å›¾å½¢æ•°ç»„
    const shapes = [];
    
    // åˆ›å»ºå‡ ä½•å›¾å½¢
    function createShape() {
        const shapeTypes = ['circle', 'triangle', 'square'];
        const type = shapeTypes[Math.floor(Math.random() * shapeTypes.length)];
        
        return {
            type: type,
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            size: Math.random() * 30 + 10,
            speed: Math.random() * 2 + 0.5,
            angle: Math.random() * Math.PI * 2,
            rotation: 0,
            rotationSpeed: (Math.random() - 0.5) * 0.02,
            opacity: Math.random() * 0.3 + 0.1,
            color: `hsl(${Math.random() * 60 + 200}, 70%, 60%)`
        };
    }
    
    // åˆå§‹åŒ–å›¾å½¢
    for (let i = 0; i < 15; i++) {
        shapes.push(createShape());
    }
    
    // ç»˜åˆ¶å›¾å½¢
    function drawShape(shape) {
        ctx.save();
        ctx.globalAlpha = shape.opacity;
        ctx.translate(shape.x, shape.y);
        ctx.rotate(shape.rotation);
        
        switch (shape.type) {
            case 'circle':
                ctx.beginPath();
                ctx.arc(0, 0, shape.size, 0, Math.PI * 2);
                ctx.fillStyle = shape.color;
                ctx.fill();
                break;
                
            case 'triangle':
                ctx.beginPath();
                ctx.moveTo(0, -shape.size);
                ctx.lineTo(-shape.size * 0.866, shape.size * 0.5);
                ctx.lineTo(shape.size * 0.866, shape.size * 0.5);
                ctx.closePath();
                ctx.fillStyle = shape.color;
                ctx.fill();
                break;
                
            case 'square':
                ctx.fillStyle = shape.color;
                ctx.fillRect(-shape.size/2, -shape.size/2, shape.size, shape.size);
                break;
        }
        
        ctx.restore();
    }
    
    // åŠ¨ç”»å¾ªç¯
    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        shapes.forEach(shape => {
            // æ›´æ–°ä½ç½®
            shape.x += Math.cos(shape.angle) * shape.speed;
            shape.y += Math.sin(shape.angle) * shape.speed;
            shape.rotation += shape.rotationSpeed;
            
            // è¾¹ç•Œæ£€æµ‹
            if (shape.x < -shape.size) shape.x = canvas.width + shape.size;
            if (shape.x > canvas.width + shape.size) shape.x = -shape.size;
            if (shape.y < -shape.size) shape.y = canvas.height + shape.size;
            if (shape.y > canvas.height + shape.size) shape.y = -shape.size;
            
            drawShape(shape);
        });
        
        requestAnimationFrame(animate);
    }
    
    // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è°ƒæ•´ç”»å¸ƒ
    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    });
    
    animate();
}

</script>
